<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chat App</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					Oxygen, Ubuntu, Cantarell, sans-serif;
				background: #f5f5f5;
			}
		</style>
		<script type="module">class Ve{constructor(){this.features=new Map,this.mounted=new Map,this.dependencies=new Map,this.context=null}register(t){if(this.features.has(t.id))throw new Error(`Feature ${t.id} already registered`);this.validateFeature(t),this.features.set(t.id,t),t.dependencies&&this.dependencies.set(t.id,t.dependencies),t.onRegister&&this.context&&t.onRegister(this.context),console.log(`✅ Feature registered: ${t.id}`)}setContext(t){this.context=t}async mountAll(t){this.setContext(t);const e=this.topologicalSort();for(const n of e)await this.mount(n,t)}async mount(t,e){const n=this.features.get(t);if(!n)throw new Error(`Feature ${t} not found`);if(this.mounted.has(t))return;if(n.dependencies)for(const r of n.dependencies)this.mounted.has(r)||await this.mount(r,e);console.log(`⬆️ Mounting feature: ${t}`);const i=await n.onMount(e);this.mounted.set(t,i||{}),n.subscribedEvents&&e.eventBus&&this.subscribeToEvents(n,e.eventBus)}async unmountAll(){const t=this.topologicalSort().reverse();for(const e of t)await this.unmount(e)}async unmount(t){const e=this.features.get(t),n=this.mounted.get(t);n&&(console.log(`⬇️ Unmounting feature: ${t}`),e.onUnmount&&this.context&&await e.onUnmount({...this.context,...n}),this.mounted.delete(t))}subscribeToEvents(t,e){for(const n of t.subscribedEvents)e.on(n,i=>{const r=this.mounted.get(t.id);r?.actor&&r.actor.send(i)})}topologicalSort(){const t=[],e=new Set,n=new Set,i=r=>{if(e.has(r))return;if(n.has(r))throw new Error(`Circular dependency detected: ${r}`);n.add(r);const o=this.dependencies.get(r)||[];for(const a of o){if(!this.features.has(a))throw new Error(`Feature ${r} depends on ${a}, but ${a} is not registered`);i(a)}n.delete(r),e.add(r),t.push(r)};for(const r of this.features.keys())i(r);return t}validateFeature(t){if(!t.id||!t.name)throw new Error("Feature must have id and name");if(!t.onMount)throw new Error(`Feature ${t.id} must have onMount`)}get(t){return this.features.get(t)}has(t){return this.features.has(t)}isMounted(t){return this.mounted.has(t)}getAll(){return Array.from(this.features.values())}getMountResult(t){return this.mounted.get(t)}}const S=new Ve;class Xe extends EventTarget{constructor(){super(),this.queues={HIGH:[],MEDIUM:[],LOW:[],DROPPED:[]},this.limits={HIGH:1e3,MEDIUM:500,LOW:100},this.processing=!1,this.stats={dropped:0,processed:0},this.frameStart=performance.now()}dispatch(t,e="MEDIUM"){if(this.queues[e].length>this.limits[e]&&this.canDrop(e)){this.queues.DROPPED.push(t),this.stats.dropped++;return}this.queues[e].push(t),this.scheduleProcess()}canDrop(t){return["LOW"].includes(t)}hasEvents(){return this.queues.HIGH.length>0||this.queues.MEDIUM.length>0||this.queues.LOW.length>0}getNextEvent(){return this.queues.HIGH.length>0?this.queues.HIGH.shift():this.queues.MEDIUM.length>0?this.queues.MEDIUM.shift():this.queues.LOW.length>0?this.queues.LOW.shift():null}async scheduleProcess(){if(!this.processing){for(this.processing=!0,this.frameStart=performance.now();this.hasEvents();){const t=this.getNextEvent();if(!t)break;performance.now()-this.frameStart>10&&(await new Promise(e=>setTimeout(e,0)),this.frameStart=performance.now()),this.dispatchEvent(new CustomEvent(t.type||"event",{detail:t})),this.stats.processed++}this.processing=!1}}on(t,e){this.addEventListener(t,n=>{e(n.detail||n)})}off(t,e){this.removeEventListener(t,e)}}const Jt=new Xe;class Ye{constructor(){this.actors=new Map,this.stats=new Map}register(t,e,n={}){this.actors.has(t)&&(console.warn(`Actor ${t} already registered, stopping old instance`),this.unregister(t)),this.actors.set(t,{actor:e,meta:{...n,spawnedAt:Date.now(),type:n.type||"unknown"}}),this.updateStats(t,"spawned"),e.subscribe&&e.subscribe({complete:()=>this.unregister(t),error:i=>{this.updateStats(t,"error",i),this.unregister(t)}})}unregister(t){const e=this.actors.get(t);if(!e)return;const{actor:n,meta:i}=e;typeof n.stop=="function"&&n.stop(),this.updateStats(t,"stopped"),this.actors.delete(t);const r=Date.now()-i.spawnedAt;console.debug(`Actor ${t} stopped after ${r}ms`)}get(t){return this.actors.get(t)?.actor}getAll(t){return Array.from(this.actors.values()).filter(({meta:e})=>!t||e.type===t).map(({actor:e})=>e)}updateStats(t,e,n=null){this.stats.has(t)||this.stats.set(t,{spawned:0,stopped:0,errors:[]});const i=this.stats.get(t);e==="spawned"&&i.spawned++,e==="stopped"&&i.stopped++,e==="error"&&n&&i.errors.push(n)}getStats(){return{active:this.actors.size,total:this.stats.size,byType:this.groupByType()}}groupByType(){const t={};for(const{meta:e}of this.actors.values())t[e.type]=(t[e.type]||0)+1;return t}}const Ze=new Ye;function Qe(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function ts(){const s=Qe();if(s.__xstate__)return s.__xstate__}const es=s=>{if(typeof window>"u")return;const t=ts();t&&t.register(s)};class Kt{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const e={value:t,next:null};if(this._current){this._last.next=e,this._last=e;return}this._current=e,this._last=e,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const ve=".",ss="",_e="",ns="#",is="*",be="xstate.init",rs="xstate.error",ot="xstate.stop";function os(s,t){return{type:`xstate.after.${s}.${t}`}}function wt(s,t){return{type:`xstate.done.state.${s}`,output:t}}function as(s,t){return{type:`xstate.done.actor.${s}`,output:t,actorId:s}}function we(s,t){return{type:`xstate.error.actor.${s}`,error:t,actorId:s}}function Se(s){return{type:be,input:s}}function w(s){setTimeout(()=>{throw s})}const cs=typeof Symbol=="function"&&Symbol.observable||"@@observable";function $e(s,t){const e=Vt(s),n=Vt(t);return typeof n=="string"?typeof e=="string"?n===e:!1:typeof e=="string"?e in n:Object.keys(e).every(i=>i in n?$e(e[i],n[i]):!1)}function kt(s){if(Ae(s))return s;const t=[];let e="";for(let n=0;n<s.length;n++){switch(s.charCodeAt(n)){case 92:e+=s[n+1],n++;continue;case 46:t.push(e),e="";continue}e+=s[n]}return t.push(e),t}function Vt(s){if(Ns(s))return s.value;if(typeof s!="string")return s;const t=kt(s);return us(t)}function us(s){if(s.length===1)return s[0];const t={};let e=t;for(let n=0;n<s.length-1;n++)if(n===s.length-2)e[s[n]]=s[n+1];else{const i=e;e={},i[s[n]]=e}return t}function Xt(s,t){const e={},n=Object.keys(s);for(let i=0;i<n.length;i++){const r=n[i];e[r]=t(s[r],r,s,i)}return e}function Ee(s){return Ae(s)?s:[s]}function E(s){return s===void 0?[]:Ee(s)}function St(s,t,e,n){return typeof s=="function"?s({context:t,event:e,self:n}):s}function Ae(s){return Array.isArray(s)}function hs(s){return s.type.startsWith("xstate.error.actor")}function L(s){return Ee(s).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function xe(s){if(!(s===void 0||s===ss))return E(s)}function $t(s,t,e){const n=typeof s=="object",i=n?s:void 0;return{next:(n?s.next:s)?.bind(i),error:(n?s.error:t)?.bind(i),complete:(n?s.complete:e)?.bind(i)}}function Yt(s,t){return`${t}.${s}`}function It(s,t){const e=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!e)return s.implementations.actors[t];const[,n,i]=e,o=s.getStateNodeById(i).config.invoke;return(Array.isArray(o)?o[n]:o).src}function ds(s,t){if(t===s||t===is)return!0;if(!t.endsWith(".*"))return!1;const e=t.split("."),n=s.split(".");for(let i=0;i<e.length;i++){const r=e[i],o=n[i];if(r==="*")return i===e.length-1;if(r!==o)return!1}return!0}function Zt(s,t){return`${s.sessionId}.${t}`}let ls=0;function fs(s,t){const e=new Map,n=new Map,i=new WeakMap,r=new Set,o={},{clock:a,logger:c}=t,d={schedule:(h,l,p,g,y=Math.random().toString(36).slice(2))=>{const R={source:h,target:l,event:p,delay:g,id:y,startedAt:Date.now()},U=Zt(h,y);u._snapshot._scheduledEvents[U]=R;const Ke=a.setTimeout(()=>{delete o[U],delete u._snapshot._scheduledEvents[U],u._relay(h,l,p)},g);o[U]=Ke},cancel:(h,l)=>{const p=Zt(h,l),g=o[p];delete o[p],delete u._snapshot._scheduledEvents[p],g!==void 0&&a.clearTimeout(g)},cancelAll:h=>{for(const l in u._snapshot._scheduledEvents){const p=u._snapshot._scheduledEvents[l];p.source===h&&d.cancel(h,p.id)}}},f=h=>{if(!r.size)return;const l={...h,rootId:s.sessionId};r.forEach(p=>p.next?.(l))},u={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${ls++}`,_register:(h,l)=>(e.set(h,l),h),_unregister:h=>{e.delete(h.sessionId);const l=i.get(h);l!==void 0&&(n.delete(l),i.delete(h))},get:h=>n.get(h),getAll:()=>Object.fromEntries(n.entries()),_set:(h,l)=>{const p=n.get(h);if(p&&p!==l)throw new Error(`Actor with system ID '${h}' already exists.`);n.set(h,l),i.set(l,h)},inspect:h=>{const l=$t(h);return r.add(l),{unsubscribe(){r.delete(l)}}},_sendInspectionEvent:f,_relay:(h,l,p)=>{u._sendInspectionEvent({type:"@xstate.event",sourceRef:h,actorRef:l,event:p}),l._send(p)},scheduler:d,getSnapshot:()=>({_scheduledEvents:{...u._snapshot._scheduledEvents}}),start:()=>{const h=u._snapshot._scheduledEvents;u._snapshot._scheduledEvents={};for(const l in h){const{source:p,target:g,event:y,delay:R,id:U}=h[l];d.schedule(p,g,y,R,U)}},_clock:a,_logger:c};return u}let mt=!1;const Ct=1;let v=(function(s){return s[s.NotStarted=0]="NotStarted",s[s.Running=1]="Running",s[s.Stopped=2]="Stopped",s})({});const ps={clock:{setTimeout:(s,t)=>setTimeout(s,t),clearTimeout:s=>clearTimeout(s)},logger:console.log.bind(console),devTools:!1};class gs{constructor(t,e){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new Kt(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=v.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this.systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const n={...ps,...e},{clock:i,logger:r,parent:o,syncSnapshot:a,id:c,systemId:d,inspect:f}=n;this.system=o?o.system:fs(this,{clock:i,logger:r}),f&&!o&&this.system.inspect($t(f)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=e?.logger??this.system._logger,this.clock=e?.clock??this.system._clock,this._parent=o,this._syncSnapshot=a,this.options=n,this.src=n.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:u=>{this._deferred.push(u)},system:this.system,stopChild:u=>{if(u._parent!==this)throw new Error(`Cannot stop child actor ${u.id} of ${this.id} because it is not a child`);u._stop()},emit:u=>{const h=this.eventListeners.get(u.type),l=this.eventListeners.get("*");if(!h&&!l)return;const p=[...h?h.values():[],...l?l.values():[]];for(const g of p)try{g(u)}catch(y){w(y)}},actionExecutor:u=>{const h=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:u.type,params:u.params}}),!u.exec)return;const l=mt;try{mt=!0,u.exec(u.info,u.params)}finally{mt=l}};this._processingStatus===v.Running?h():this._deferred.push(h)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),d&&(this.systemId=d,this.system._set(d,this)),this._initState(e?.snapshot??e?.state),d&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(e){this._snapshot={status:"error",output:void 0,error:e}}}update(t,e){this._snapshot=t;let n;for(;n=this._deferred.shift();)try{n()}catch(i){this._deferred.length=0,this._snapshot={...t,status:"error",error:i}}switch(this._snapshot.status){case"active":for(const i of this.observers)try{i.next?.(t)}catch(r){w(r)}break;case"done":for(const i of this.observers)try{i.next?.(t)}catch(r){w(r)}this._stopProcedure(),this._complete(),this._doneEvent=as(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:e,snapshot:t})}subscribe(t,e,n){const i=$t(t,e,n);if(this._processingStatus!==v.Stopped)this.observers.add(i);else switch(this._snapshot.status){case"done":try{i.complete?.()}catch(r){w(r)}break;case"error":{const r=this._snapshot.error;if(!i.error)w(r);else try{i.error(r)}catch(o){w(o)}break}}return{unsubscribe:()=>{this.observers.delete(i)}}}on(t,e){let n=this.eventListeners.get(t);n||(n=new Set,this.eventListeners.set(t,n));const i=e.bind(void 0);return n.add(i),{unsubscribe:()=>{n.delete(i)}}}start(){if(this._processingStatus===v.Running)return this;this._syncSnapshot&&this.subscribe({next:n=>{n.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:n})},error:()=>{}}),this.system._register(this.sessionId,this),this.systemId&&this.system._set(this.systemId,this),this._processingStatus=v.Running;const t=Se(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(n){return this._snapshot={...this._snapshot,status:"error",error:n},this._error(n),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let e,n;try{e=this.logic.transition(this._snapshot,t,this._actorScope)}catch(i){n={err:i}}if(n){const{err:i}=n;this._snapshot={...this._snapshot,status:"error",error:i},this._error(i);return}this.update(e,t),t.type===ot&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===v.Stopped?this:(this.mailbox.clear(),this._processingStatus===v.NotStarted?(this._processingStatus=v.Stopped,this):(this.mailbox.enqueue({type:ot}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(const t of this.observers)try{t.complete?.()}catch(e){w(e)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||w(t);return}let e=!1;for(const n of this.observers){const i=n.error;e||=!i;try{i?.(t)}catch(r){w(r)}}this.observers.clear(),e&&w(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,we(this.id,t))}_stopProcedure(){return this._processingStatus!==v.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new Kt(this._process.bind(this)),this._processingStatus=v.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==v.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:es)(this)}toJSON(){return{xstate$$type:Ct,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[cs](){return this}getSnapshot(){return this._snapshot}}function N(s,...[t]){return new gs(s,t)}function ys(s,t,e,n,{sendId:i}){const r=typeof i=="function"?i(e,n):i;return[t,{sendId:r},void 0]}function ms(s,t){s.defer(()=>{s.system.scheduler.cancel(s.self,t.sendId)})}function Ot(s){function t(e,n){}return t.type="xstate.cancel",t.sendId=s,t.resolve=ys,t.execute=ms,t}function vs(s,t,e,n,{id:i,systemId:r,src:o,input:a,syncSnapshot:c}){const d=typeof o=="string"?It(t.machine,o):o,f=typeof i=="function"?i(e):i;let u,h;return d&&(h=typeof a=="function"?a({context:t.context,event:e.event,self:s.self}):a,u=N(d,{id:f,src:o,parent:s.self,syncSnapshot:c,systemId:r,input:h})),[P(t,{children:{...t.children,[f]:u}}),{id:i,systemId:r,actorRef:u,src:o,input:h},void 0]}function _s(s,{actorRef:t}){t&&s.defer(()=>{t._processingStatus!==v.Stopped&&t.start()})}function Pt(...[s,{id:t,systemId:e,input:n,syncSnapshot:i=!1}={}]){function r(o,a){}return r.type="xstate.spawnChild",r.id=t,r.systemId=e,r.src=s,r.input=n,r.syncSnapshot=i,r.resolve=vs,r.execute=_s,r}function bs(s,t,e,n,{actorRef:i}){const r=typeof i=="function"?i(e,n):i,o=typeof r=="string"?t.children[r]:r;let a=t.children;return o&&(a={...a},delete a[o.id]),[P(t,{children:a}),o,void 0]}function ws(s,t){if(t){if(s.system._unregister(t),t._processingStatus!==v.Running){s.stopChild(t);return}s.defer(()=>{s.stopChild(t)})}}function lt(s){function t(e,n){}return t.type="xstate.stopChild",t.actorRef=s,t.resolve=bs,t.execute=ws,t}function ft(s,t,e,n){const{machine:i}=n,r=typeof s=="function",o=r?s:i.implementations.guards[typeof s=="string"?s:s.type];if(!r&&!o)throw new Error(`Guard '${typeof s=="string"?s:s.type}' is not implemented.'.`);if(typeof o!="function")return ft(o,t,e,n);const a={context:t,event:e},c=r||typeof s=="string"?void 0:"params"in s?typeof s.params=="function"?s.params({context:t,event:e}):s.params:void 0;return"check"in o?o.check(n,a,o):o(a,c)}const Mt=s=>s.type==="atomic"||s.type==="final";function B(s){return Object.values(s.states).filter(t=>t.type!=="history")}function tt(s,t){const e=[];if(t===s)return e;let n=s.parent;for(;n&&n!==t;)e.push(n),n=n.parent;return e}function at(s){const t=new Set(s),e=ke(t);for(const n of t)if(n.type==="compound"&&(!e.get(n)||!e.get(n).length))Qt(n).forEach(i=>t.add(i));else if(n.type==="parallel"){for(const i of B(n))if(i.type!=="history"&&!t.has(i)){const r=Qt(i);for(const o of r)t.add(o)}}for(const n of t){let i=n.parent;for(;i;)t.add(i),i=i.parent}return t}function Te(s,t){const e=t.get(s);if(!e)return{};if(s.type==="compound"){const i=e[0];if(i){if(Mt(i))return i.key}else return{}}const n={};for(const i of e)n[i.key]=Te(i,t);return n}function ke(s){const t=new Map;for(const e of s)t.has(e)||t.set(e,[]),e.parent&&(t.has(e.parent)||t.set(e.parent,[]),t.get(e.parent).push(e));return t}function Ie(s,t){const e=at(t);return Te(s,ke(e))}function Rt(s,t){return t.type==="compound"?B(t).some(e=>e.type==="final"&&s.has(e)):t.type==="parallel"?B(t).every(e=>Rt(s,e)):t.type==="final"}const pt=s=>s[0]===ns;function Ss(s,t){return s.transitions.get(t)||[...s.transitions.keys()].filter(n=>ds(t,n)).sort((n,i)=>i.length-n.length).flatMap(n=>s.transitions.get(n))}function $s(s){const t=s.config.after;if(!t)return[];const e=i=>{const r=os(i,s.id),o=r.type;return s.entry.push(Lt(r,{id:o,delay:i})),s.exit.push(Ot(o)),o};return Object.keys(t).flatMap(i=>{const r=t[i],o=typeof r=="string"?{target:r}:r,a=Number.isNaN(+i)?i:+i,c=e(a);return E(o).map(d=>({...d,event:c,delay:a}))}).map(i=>{const{delay:r}=i;return{...k(s,i.event,i),delay:r}})}function k(s,t,e){const n=xe(e.target),i=e.reenter??!1,r=xs(s,n),o={...e,actions:E(e.actions),guard:e.guard,target:r,source:s,reenter:i,eventType:t,toJSON:()=>({...o,source:`#${s.id}`,target:r?r.map(a=>`#${a.id}`):void 0})};return o}function Es(s){const t=new Map;if(s.config.on)for(const e of Object.keys(s.config.on)){if(e===_e)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const n=s.config.on[e];t.set(e,L(n).map(i=>k(s,e,i)))}if(s.config.onDone){const e=`xstate.done.state.${s.id}`;t.set(e,L(s.config.onDone).map(n=>k(s,e,n)))}for(const e of s.invoke){if(e.onDone){const n=`xstate.done.actor.${e.id}`;t.set(n,L(e.onDone).map(i=>k(s,n,i)))}if(e.onError){const n=`xstate.error.actor.${e.id}`;t.set(n,L(e.onError).map(i=>k(s,n,i)))}if(e.onSnapshot){const n=`xstate.snapshot.${e.id}`;t.set(n,L(e.onSnapshot).map(i=>k(s,n,i)))}}for(const e of s.after){let n=t.get(e.eventType);n||(n=[],t.set(e.eventType,n)),n.push(e)}return t}function As(s,t){const e=typeof t=="string"?s.states[t]:t?s.states[t.target]:void 0;if(!e&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${s.id}`);const n={source:s,actions:!t||typeof t=="string"?[]:E(t.actions),eventType:null,reenter:!1,target:e?[e]:[],toJSON:()=>({...n,source:`#${s.id}`,target:e?[`#${e.id}`]:[]})};return n}function xs(s,t){if(t!==void 0)return t.map(e=>{if(typeof e!="string")return e;if(pt(e))return s.machine.getStateNodeById(e);const n=e[0]===ve;if(n&&!s.parent)return ct(s,e.slice(1));const i=n?s.key+e:e;if(s.parent)try{return ct(s.parent,i)}catch(r){throw new Error(`Invalid transition definition for state node '${s.id}':
${r.message}`)}else throw new Error(`Invalid target: "${e}" is not a valid target from the root node. Did you mean ".${e}"?`)})}function Ce(s){const t=xe(s.config.target);return t?{target:t.map(e=>typeof e=="string"?ct(s.parent,e):e)}:s.parent.initial}function I(s){return s.type==="history"}function Qt(s){const t=Oe(s);for(const e of t)for(const n of tt(e,s))t.add(n);return t}function Oe(s){const t=new Set;function e(n){if(!t.has(n)){if(t.add(n),n.type==="compound")e(n.initial.target[0]);else if(n.type==="parallel")for(const i of B(n))e(i)}}return e(s),t}function z(s,t){if(pt(t))return s.machine.getStateNodeById(t);if(!s.states)throw new Error(`Unable to retrieve child state '${t}' from '${s.id}'; no child states exist.`);const e=s.states[t];if(!e)throw new Error(`Child state '${t}' does not exist on '${s.id}'`);return e}function ct(s,t){if(typeof t=="string"&&pt(t))try{return s.machine.getStateNodeById(t)}catch{}const e=kt(t).slice();let n=s;for(;e.length;){const i=e.shift();if(!i.length)break;n=z(n,i)}return n}function ut(s,t){if(typeof t=="string"){const i=s.states[t];if(!i)throw new Error(`State '${t}' does not exist on '${s.id}'`);return[s,i]}const e=Object.keys(t),n=e.map(i=>z(s,i)).filter(Boolean);return[s.machine.root,s].concat(n,e.reduce((i,r)=>{const o=z(s,r);if(!o)return i;const a=ut(o,t[r]);return i.concat(a)},[]))}function Ts(s,t,e,n){const r=z(s,t).next(e,n);return!r||!r.length?s.next(e,n):r}function ks(s,t,e,n){const i=Object.keys(t),r=z(s,i[0]),o=Ut(r,t[i[0]],e,n);return!o||!o.length?s.next(e,n):o}function Is(s,t,e,n){const i=[];for(const r of Object.keys(t)){const o=t[r];if(!o)continue;const a=z(s,r),c=Ut(a,o,e,n);c&&i.push(...c)}return i.length?i:s.next(e,n)}function Ut(s,t,e,n){return typeof t=="string"?Ts(s,t,e,n):Object.keys(t).length===1?ks(s,t,e,n):Is(s,t,e,n)}function Cs(s){return Object.keys(s.states).map(t=>s.states[t]).filter(t=>t.type==="history")}function x(s,t){let e=s;for(;e.parent&&e.parent!==t;)e=e.parent;return e.parent===t}function Os(s,t){const e=new Set(s),n=new Set(t);for(const i of e)if(n.has(i))return!0;for(const i of n)if(e.has(i))return!0;return!1}function Pe(s,t,e){const n=new Set;for(const i of s){let r=!1;const o=new Set;for(const a of n)if(Os(Et([i],t,e),Et([a],t,e)))if(x(i.source,a.source))o.add(a);else{r=!0;break}if(!r){for(const a of o)n.delete(a);n.add(i)}}return Array.from(n)}function Ps(s){const[t,...e]=s;for(const n of tt(t,void 0))if(e.every(i=>x(i,n)))return n}function Dt(s,t){if(!s.target)return[];const e=new Set;for(const n of s.target)if(I(n))if(t[n.id])for(const i of t[n.id])e.add(i);else for(const i of Dt(Ce(n),t))e.add(i);else e.add(n);return[...e]}function Me(s,t){const e=Dt(s,t);if(!e)return;if(!s.reenter&&e.every(i=>i===s.source||x(i,s.source)))return s.source;const n=Ps(e.concat(s.source));if(n)return n;if(!s.reenter)return s.source.machine.root}function Et(s,t,e){const n=new Set;for(const i of s)if(i.target?.length){const r=Me(i,e);i.reenter&&i.source===r&&n.add(r);for(const o of t)x(o,r)&&n.add(o)}return[...n]}function Ms(s,t){if(s.length!==t.size)return!1;for(const e of s)if(!t.has(e))return!1;return!0}function At(s,t,e,n,i,r){if(!s.length)return t;const o=new Set(t._nodes);let a=t.historyValue;const c=Pe(s,o,a);let d=t;i||([d,a]=Ls(d,n,e,c,o,a,r,e.actionExecutor)),d=F(d,n,e,c.flatMap(u=>u.actions),r,void 0),d=Us(d,n,e,c,o,r,a,i);const f=[...o];d.status==="done"&&(d=F(d,n,e,f.sort((u,h)=>h.order-u.order).flatMap(u=>u.exit),r,void 0));try{return a===t.historyValue&&Ms(t._nodes,o)?d:P(d,{_nodes:f,historyValue:a})}catch(u){throw u}}function Rs(s,t,e,n,i){if(n.output===void 0)return;const r=wt(i.id,i.output!==void 0&&i.parent?St(i.output,s.context,t,e.self):void 0);return St(n.output,s.context,r,e.self)}function Us(s,t,e,n,i,r,o,a){let c=s;const d=new Set,f=new Set;Ds(n,o,f,d),a&&f.add(s.machine.root);const u=new Set;for(const h of[...d].sort((l,p)=>l.order-p.order)){i.add(h);const l=[];l.push(...h.entry);for(const p of h.invoke)l.push(Pt(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(f.has(h)){const p=h.initial.actions;l.push(...p)}if(c=F(c,t,e,l,r,h.invoke.map(p=>p.id)),h.type==="final"){const p=h.parent;let g=p?.type==="parallel"?p:p?.parent,y=g||h;for(p?.type==="compound"&&r.push(wt(p.id,h.output!==void 0?St(h.output,c.context,t,e.self):void 0));g?.type==="parallel"&&!u.has(g)&&Rt(i,g);)u.add(g),r.push(wt(g.id)),y=g,g=g.parent;if(g)continue;c=P(c,{status:"done",output:Rs(c,t,e,c.machine.root,y)})}}return c}function Ds(s,t,e,n){for(const i of s){const r=Me(i,t);for(const a of i.target||[])!I(a)&&(i.source!==a||i.source!==r||i.reenter)&&(n.add(a),e.add(a)),H(a,t,e,n);const o=Dt(i,t);for(const a of o){const c=tt(a,r);r?.type==="parallel"&&c.push(r),Re(n,t,e,c,!i.source.parent&&i.reenter?void 0:r)}}}function H(s,t,e,n){if(I(s))if(t[s.id]){const i=t[s.id];for(const r of i)n.add(r),H(r,t,e,n);for(const r of i)vt(r,s.parent,n,t,e)}else{const i=Ce(s);for(const r of i.target)n.add(r),i===s.parent?.initial&&e.add(s.parent),H(r,t,e,n);for(const r of i.target)vt(r,s.parent,n,t,e)}else if(s.type==="compound"){const[i]=s.initial.target;I(i)||(n.add(i),e.add(i)),H(i,t,e,n),vt(i,s,n,t,e)}else if(s.type==="parallel")for(const i of B(s).filter(r=>!I(r)))[...n].some(r=>x(r,i))||(I(i)||(n.add(i),e.add(i)),H(i,t,e,n))}function Re(s,t,e,n,i){for(const r of n)if((!i||x(r,i))&&s.add(r),r.type==="parallel")for(const o of B(r).filter(a=>!I(a)))[...s].some(a=>x(a,o))||(s.add(o),H(o,t,e,s))}function vt(s,t,e,n,i){Re(e,n,i,tt(s,t))}function Ls(s,t,e,n,i,r,o,a){let c=s;const d=Et(n,i,r);d.sort((u,h)=>h.order-u.order);let f;for(const u of d)for(const h of Cs(u)){let l;h.history==="deep"?l=p=>Mt(p)&&x(p,u):l=p=>p.parent===u,f??={...r},f[h.id]=Array.from(i).filter(l)}for(const u of d)c=F(c,t,e,[...u.exit,...u.invoke.map(h=>lt(h.id))],o,void 0),i.delete(u);return[c,f||r]}function js(s,t){return s.implementations.actions[t]}function Ue(s,t,e,n,i,r){const{machine:o}=s;let a=s;for(const c of n){const d=typeof c=="function",f=d?c:js(o,typeof c=="string"?c:c.type),u={context:a.context,event:t,self:e.self,system:e.system},h=d||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:t}):c.params:void 0;if(!f||!("resolve"in f)){e.actionExecutor({type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",info:u,params:h,exec:f});continue}const l=f,[p,g,y]=l.resolve(e,a,u,h,f,i);a=p,"retryResolve"in l&&r?.push([l,g]),"execute"in l&&e.actionExecutor({type:l.type,info:u,params:g,exec:l.execute.bind(null,e,g)}),y&&(a=Ue(a,t,e,y,i,r))}return a}function F(s,t,e,n,i,r){const o=r?[]:void 0,a=Ue(s,t,e,n,{internalQueue:i,deferredActorIds:r},o);return o?.forEach(([c,d])=>{c.retryResolve(e,a,d)}),a}function _t(s,t,e,n){let i=s;const r=[];function o(d,f,u){e.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:e.self,event:f,snapshot:d,_transitions:u}),r.push(d)}if(t.type===ot)return i=P(te(i,t,e),{status:"stopped"}),o(i,t,[]),{snapshot:i,microstates:r};let a=t;if(a.type!==be){const d=a,f=hs(d),u=ee(d,i);if(f&&!u.length)return i=P(s,{status:"error",error:d.error}),o(i,d,[]),{snapshot:i,microstates:r};i=At(u,s,e,a,!1,n),o(i,d,u)}let c=!0;for(;i.status==="active";){let d=c?Hs(i,a):[];const f=d.length?i:void 0;if(!d.length){if(!n.length)break;a=n.shift(),d=ee(a,i)}i=At(d,i,e,a,!1,n),c=i!==f,o(i,a,d)}return i.status!=="active"&&te(i,a,e),{snapshot:i,microstates:r}}function te(s,t,e){return F(s,t,e,Object.values(s.children).map(n=>lt(n)),[],void 0)}function ee(s,t){return t.machine.getTransitionData(t,s)}function Hs(s,t){const e=new Set,n=s._nodes.filter(Mt);for(const i of n)t:for(const r of[i].concat(tt(i,void 0)))if(r.always){for(const o of r.always)if(o.guard===void 0||ft(o.guard,s.context,t,s)){e.add(o);break t}}return Pe(Array.from(e),new Set(s._nodes),s.historyValue)}function qs(s,t){const e=at(ut(s,t));return Ie(s,[...e])}function Ns(s){return!!s&&typeof s=="object"&&"machine"in s&&"value"in s}const Bs=function(t){return $e(t,this.value)},zs=function(t){return this.tags.has(t)},Fs=function(t){const e=this.machine.getTransitionData(this,t);return!!e?.length&&e.some(n=>n.target!==void 0||n.actions.length)},Gs=function(){const{_nodes:t,tags:e,machine:n,getMeta:i,toJSON:r,can:o,hasTag:a,matches:c,...d}=this;return{...d,tags:Array.from(e)}},Ws=function(){return this._nodes.reduce((t,e)=>(e.meta!==void 0&&(t[e.id]=e.meta),t),{})};function nt(s,t){return{status:s.status,output:s.output,error:s.error,machine:t,context:s.context,_nodes:s._nodes,value:Ie(t.root,s._nodes),tags:new Set(s._nodes.flatMap(e=>e.tags)),children:s.children,historyValue:s.historyValue||{},matches:Bs,hasTag:zs,can:Fs,getMeta:Ws,toJSON:Gs}}function P(s,t={}){return nt({...s,...t},s.machine)}function Js(s){if(typeof s!="object"||s===null)return{};const t={};for(const e in s){const n=s[e];Array.isArray(n)&&(t[e]=n.map(i=>({id:i.id})))}return t}function Ks(s,t){const{_nodes:e,tags:n,machine:i,children:r,context:o,can:a,hasTag:c,matches:d,getMeta:f,toJSON:u,...h}=s,l={};for(const g in r){const y=r[g];l[g]={snapshot:y.getPersistedSnapshot(t),src:y.src,systemId:y.systemId,syncSnapshot:y._syncSnapshot}}return{...h,context:De(o),children:l,historyValue:Js(h.historyValue)}}function De(s){let t;for(const e in s){const n=s[e];if(n&&typeof n=="object")if("sessionId"in n&&"send"in n&&"ref"in n)t??=Array.isArray(s)?s.slice():{...s},t[e]={xstate$$type:Ct,id:n.id};else{const i=De(n);i!==n&&(t??=Array.isArray(s)?s.slice():{...s},t[e]=i)}}return t??s}function Vs(s,t,e,n,{event:i,id:r,delay:o},{internalQueue:a}){const c=t.machine.implementations.delays;if(typeof i=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${i}" }) instead`);const d=typeof i=="function"?i(e,n):i;let f;if(typeof o=="string"){const u=c&&c[o];f=typeof u=="function"?u(e,n):u}else f=typeof o=="function"?o(e,n):o;return typeof f!="number"&&a.push(d),[t,{event:d,id:r,delay:f},void 0]}function Xs(s,t){const{event:e,delay:n,id:i}=t;if(typeof n=="number"){s.defer(()=>{const r=s.self;s.system.scheduler.schedule(r,r,e,n,i)});return}}function Lt(s,t){function e(n,i){}return e.type="xstate.raise",e.event=s,e.id=t?.id,e.delay=t?.delay,e.resolve=Vs,e.execute=Xs,e}const se="xstate.promise.resolve",ne="xstate.promise.reject",st=new WeakMap;function A(s){return{config:s,transition:(e,n,i)=>{if(e.status!=="active")return e;switch(n.type){case se:{const r=n.data;return{...e,status:"done",output:r,input:void 0}}case ne:return{...e,status:"error",error:n.data,input:void 0};case ot:return st.get(i.self)?.abort(),{...e,status:"stopped",input:void 0};default:return e}},start:(e,{self:n,system:i,emit:r})=>{if(e.status!=="active")return;const o=new AbortController;st.set(n,o),Promise.resolve(s({input:e.input,system:i,self:n,signal:o.signal,emit:r})).then(c=>{n.getSnapshot().status==="active"&&(st.delete(n),i._relay(n,n,{type:se,data:c}))},c=>{n.getSnapshot().status==="active"&&(st.delete(n),i._relay(n,n,{type:ne,data:c}))})},getInitialSnapshot:(e,n)=>({status:"active",output:void 0,error:void 0,input:n}),getPersistedSnapshot:e=>e,restoreSnapshot:e=>e}}function Ys(s,{machine:t,context:e},n,i){const r=(o,a)=>{if(typeof o=="string"){const c=It(t,o);if(!c)throw new Error(`Actor logic '${o}' not implemented in machine '${t.id}'`);const d=N(c,{id:a?.id,parent:s.self,syncSnapshot:a?.syncSnapshot,input:typeof a?.input=="function"?a.input({context:e,event:n,self:s.self}):a?.input,src:o,systemId:a?.systemId});return i[d.id]=d,d}else return N(o,{id:a?.id,parent:s.self,syncSnapshot:a?.syncSnapshot,input:a?.input,src:o,systemId:a?.systemId})};return(o,a)=>{const c=r(o,a);return i[c.id]=c,s.defer(()=>{c._processingStatus!==v.Stopped&&c.start()}),c}}function Zs(s,t,e,n,{assignment:i}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const r={},o={context:t.context,event:e.event,spawn:Ys(s,t,e.event,r),self:s.self,system:s.system};let a={};if(typeof i=="function")a=i(o,n);else for(const d of Object.keys(i)){const f=i[d];a[d]=typeof f=="function"?f(o,n):f}const c=Object.assign({},t.context,a);return[P(t,{context:c,children:Object.keys(r).length?{...t.children,...r}:t.children}),void 0,void 0]}function _(s){function t(e,n){}return t.type="xstate.assign",t.assignment=s,t.resolve=Zs,t}const ie=new WeakMap;function D(s,t,e){let n=ie.get(s);return n?t in n||(n[t]=e()):(n={[t]:e()},ie.set(s,n)),n[t]}const Qs={},J=s=>typeof s=="string"?{type:s}:typeof s=="function"?"resolve"in s?{type:s.type}:{type:s.name}:s;class ht{constructor(t,e){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=e._parent,this.key=e._key,this.machine=e._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(ve),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?Xt(this.config.states,(n,i)=>new ht(n,{_parent:this,_key:i,_machine:this.machine})):Qs,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=E(this.config.entry).slice(),this.exit=E(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=E(t.tags).slice()}_initialize(){this.transitions=Es(this),this.config.always&&(this.always=L(this.config.always).map(t=>k(this,_e,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(J),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(J),eventType:null})}:void 0,history:this.history,states:Xt(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(J)})),entry:this.entry.map(J),exit:this.exit.map(J),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return D(this,"invoke",()=>E(this.config.invoke).map((t,e)=>{const{src:n,systemId:i}=t,r=t.id??Yt(this.id,e),o=typeof n=="string"?n:`xstate.invoke.${Yt(this.id,e)}`;return{...t,src:o,id:r,systemId:i,toJSON(){const{onDone:a,onError:c,...d}=t;return{...d,type:"xstate.invoke",src:o,id:r}}}}))}get on(){return D(this,"on",()=>[...this.transitions].flatMap(([e,n])=>n.map(i=>[e,i])).reduce((e,[n,i])=>(e[n]=e[n]||[],e[n].push(i),e),{}))}get after(){return D(this,"delayedTransitions",()=>$s(this))}get initial(){return D(this,"initial",()=>As(this,this.config.initial))}next(t,e){const n=e.type,i=[];let r;const o=D(this,`candidates-${n}`,()=>Ss(this,n));for(const a of o){const{guard:c}=a,d=t.context;let f=!1;try{f=!c||ft(c,d,e,t)}catch(u){const h=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${h?`'${h}' `:""}in transition for event '${n}' in state node '${this.id}':
${u.message}`)}if(f){i.push(...a.actions),r=a;break}}return r?[r]:void 0}get events(){return D(this,"events",()=>{const{states:t}=this,e=new Set(this.ownEvents);if(t)for(const n of Object.keys(t)){const i=t[n];if(i.states)for(const r of i.events)e.add(`${r}`)}return Array.from(e)})}get ownEvents(){const t=Object.keys(Object.fromEntries(this.transitions)),e=new Set(t.filter(n=>this.transitions.get(n).some(i=>!(!i.target&&!i.actions.length&&!i.reenter))));return Array.from(e)}}const tn="#";class jt{constructor(t,e){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=t.id||"(machine)",this.implementations={actors:e?.actors??{},actions:e?.actions??{},delays:e?.delays??{},guards:e?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new ht(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:e,guards:n,actors:i,delays:r}=this.implementations;return new jt(this.config,{actions:{...e,...t.actions},guards:{...n,...t.guards},actors:{...i,...t.actors},delays:{...r,...t.delays}})}resolveState(t){const e=qs(this.root,t.value),n=at(ut(this.root,e));return nt({_nodes:[...n],context:t.context||{},children:{},status:Rt(n,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,e,n){return _t(t,e,n,[]).snapshot}microstep(t,e,n){return _t(t,e,n,[]).microstates}getTransitionData(t,e){return Ut(this.root,t.value,t,e)||[]}getPreInitialState(t,e,n){const{context:i}=this.config,r=nt({context:typeof i!="function"&&i?i:{},_nodes:[this.root],children:{},status:"active"},this);return typeof i=="function"?F(r,e,t,[_(({spawn:a,event:c,self:d})=>i({spawn:a,input:c.input,self:d}))],n,void 0):r}getInitialSnapshot(t,e){const n=Se(e),i=[],r=this.getPreInitialState(t,n,i),o=At([{target:[...Oe(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],r,t,n,!0,i),{snapshot:a}=_t(o,n,t,i);return a}start(t){Object.values(t.children).forEach(e=>{e.getSnapshot().status==="active"&&e.start()})}getStateNodeById(t){const e=kt(t),n=e.slice(1),i=pt(e[0])?e[0].slice(tn.length):e[0],r=this.idMap.get(i);if(!r)throw new Error(`Child state node '#${i}' does not exist on machine '${this.id}'`);return ct(r,n)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,e){return Ks(t,e)}restoreSnapshot(t,e){const n={},i=t.children;Object.keys(i).forEach(u=>{const h=i[u],l=h.snapshot,p=h.src,g=typeof p=="string"?It(this,p):p;if(!g)return;const y=N(g,{id:u,parent:e.self,syncSnapshot:h.syncSnapshot,snapshot:l,src:p,systemId:h.systemId});n[u]=y});function r(u,h){if(h instanceof ht)return h;try{return u.machine.getStateNodeById(h.id)}catch{}}function o(u,h){if(!h||typeof h!="object")return{};const l={};for(const p in h){const g=h[p];for(const y of g){const R=r(u,y);R&&(l[p]??=[],l[p].push(R))}}return l}const a=o(this.root,t.historyValue),c=nt({...t,children:n,_nodes:Array.from(at(ut(this.root,t.value))),historyValue:a},this),d=new Set;function f(u,h){if(!d.has(u)){d.add(u);for(const l in u){const p=u[l];if(p&&typeof p=="object"){if("xstate$$type"in p&&p.xstate$$type===Ct){u[l]=h[p.id];continue}f(p,h)}}}}return f(c.context,n),c}}function en(s,t,e,n,{event:i}){const r=typeof i=="function"?i(e,n):i;return[t,{event:r},void 0]}function sn(s,{event:t}){s.defer(()=>s.emit(t))}function Le(s){function t(e,n){}return t.type="xstate.emit",t.event=s,t.resolve=en,t.execute=sn,t}let xt=(function(s){return s.Parent="#_parent",s.Internal="#_internal",s})({});function nn(s,t,e,n,{to:i,event:r,id:o,delay:a},c){const d=t.machine.implementations.delays;if(typeof r=="string")throw new Error(`Only event objects may be used with sendTo; use sendTo({ type: "${r}" }) instead`);const f=typeof r=="function"?r(e,n):r;let u;if(typeof a=="string"){const p=d&&d[a];u=typeof p=="function"?p(e,n):p}else u=typeof a=="function"?a(e,n):a;const h=typeof i=="function"?i(e,n):i;let l;if(typeof h=="string"){if(h===xt.Parent?l=s.self._parent:h===xt.Internal?l=s.self:h.startsWith("#_")?l=t.children[h.slice(2)]:l=c.deferredActorIds?.includes(h)?h:t.children[h],!l)throw new Error(`Unable to send event to actor '${h}' from machine '${t.machine.id}'.`)}else l=h||s.self;return[t,{to:l,targetId:typeof h=="string"?h:void 0,event:f,id:o,delay:u},void 0]}function rn(s,t,e){typeof e.to=="string"&&(e.to=t.children[e.to])}function on(s,t){s.defer(()=>{const{to:e,event:n,delay:i,id:r}=t;if(typeof i=="number"){s.system.scheduler.schedule(s.self,e,n,i,r);return}s.system._relay(s.self,e,n.type===rs?we(s.self.id,n.data):n)})}function Ht(s,t,e){function n(i,r){}return n.type="xstate.sendTo",n.to=s,n.event=t,n.id=e?.id,n.delay=e?.delay,n.resolve=nn,n.retryResolve=rn,n.execute=on,n}function an(s,t){return Ht(xt.Parent,s,t)}function cn(s,t,e,n,{collect:i}){const r=[],o=function(c){r.push(c)};return o.assign=(...a)=>{r.push(_(...a))},o.cancel=(...a)=>{r.push(Ot(...a))},o.raise=(...a)=>{r.push(Lt(...a))},o.sendTo=(...a)=>{r.push(Ht(...a))},o.sendParent=(...a)=>{r.push(an(...a))},o.spawnChild=(...a)=>{r.push(Pt(...a))},o.stopChild=(...a)=>{r.push(lt(...a))},o.emit=(...a)=>{r.push(Le(...a))},i({context:e.context,event:e.event,enqueue:o,check:a=>ft(a,t.context,e.event,t),self:s.self,system:s.system},n),[t,void 0,r]}function un(s){function t(e,n){}return t.type="xstate.enqueueActions",t.collect=s,t.resolve=cn,t}function hn(s,t,e,n,{value:i,label:r}){return[t,{value:typeof i=="function"?i(e,n):i,label:r},void 0]}function dn({logger:s},{value:t,label:e}){e?s(e,t):s(t)}function ln(s=({context:e,event:n})=>({context:e,event:n}),t){function e(n,i){}return e.type="xstate.log",e.value=s,e.label=t,e.resolve=hn,e.execute=dn,e}function fn(s,t){return new jt(s,t)}function qt({schemas:s,actors:t,actions:e,guards:n,delays:i}){return{assign:_,sendTo:Ht,raise:Lt,log:ln,cancel:Ot,stopChild:lt,enqueueActions:un,emit:Le,spawnChild:Pt,createStateConfig:r=>r,createAction:r=>r,createMachine:r=>fn({...r,schemas:s},{actors:t,actions:e,guards:n,delays:i}),extend:r=>qt({schemas:s,actors:t,actions:{...e,...r.actions},guards:{...n,...r.guards},delays:{...i,...r.delays}})}}let V=null;function pn(s){V=s}const gn=qt({actors:{mountFeatures:A(async({input:s})=>{const t=V||s;if(console.log("mountFeatures - using context:",t),!t||!t.actorRegistry)throw new Error("Missing required context: actorRegistry");return await S.mountAll(t),{success:!0}}),unmountFeatures:A(async()=>(await S.unmountAll(),{success:!0})),detectStartupType:A(async()=>{const s=localStorage.getItem("session")!==null,t=navigator.onLine;return s?t?"warm":"offline":"cold"}),loadSettings:A(async()=>{const s=localStorage.getItem("settings");return s?JSON.parse(s):{}})}}).createMachine({id:"app",initial:"booting",context:{features:[],mountedFeatures:new Set,startupType:"cold",settings:{}},states:{booting:{initial:"detecting",states:{detecting:{invoke:{src:"detectStartupType",onDone:{target:"loadingSettings",actions:_({startupType:({event:s})=>s.output})}}},loadingSettings:{invoke:{src:"loadSettings",onDone:{target:"mounting",actions:_({settings:({event:s})=>s.output})}}},mounting:{invoke:{src:"mountFeatures",input:({self:s})=>(V&&(V.appActor=s),V||{}),onDone:{target:"#app.ready",actions:_({mountedFeatures:()=>new Set(S.getAll().map(s=>s.id))})},onError:{target:"#app.error",actions:({event:s})=>{console.error("Mounting failed:",s.error)}}}}}},ready:{on:{LOGOUT:{target:"shuttingDown"},ERROR_CRITICAL:{target:"error"}}},shuttingDown:{invoke:{src:"unmountFeatures",onDone:{target:"terminated"}}},error:{on:{RETRY:{target:"booting"}}},terminated:{type:"final"}}});class yn{constructor(){this.db=null,this.dbName="chat-app",this.dbVersion=1}async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>{e(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this.db=n.result,t()},n.onupgradeneeded=i=>{const r=i.target.result;r.objectStoreNames.contains("profiles")||r.createObjectStore("profiles",{keyPath:"userId"}),r.objectStoreNames.contains("messages")||r.createObjectStore("messages",{keyPath:"id"}),r.objectStoreNames.contains("settings")||r.createObjectStore("settings",{keyPath:"key"})}})}async get(t,e){return new Promise((n,i)=>{const a=this.db.transaction([t],"readonly").objectStore(t).get(e);a.onsuccess=()=>n(a.result),a.onerror=()=>i(a.error)})}async set(t,e){return new Promise((n,i)=>{const a=this.db.transaction([t],"readwrite").objectStore(t).put(e);a.onsuccess=()=>n(),a.onerror=()=>i(a.error)})}async delete(t,e){return new Promise((n,i)=>{const a=this.db.transaction([t],"readwrite").objectStore(t).delete(e);a.onsuccess=()=>n(),a.onerror=()=>i(a.error)})}async getAll(t){return new Promise((e,n)=>{const o=this.db.transaction([t],"readonly").objectStore(t).getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>n(o.error)})}}const q=new yn,mn={id:"persistence",name:"Persistence",version:"1.0.0",async onMount(s){return await q.init(),console.log("✅ Persistence initialized"),{service:q}},async onUnmount(s){}};class vn{constructor(){this.keyPair=null}async generateKeyPair(){try{const t=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]),e=await crypto.subtle.exportKey("jwk",t.publicKey),n=await crypto.subtle.exportKey("jwk",t.privateKey);return this.keyPair={publicKey:JSON.stringify(e),privateKey:JSON.stringify(n)},this.keyPair}catch(t){throw console.error("Failed to generate key pair:",t),t}}async encrypt(t,e){return btoa(t)}async decrypt(t,e){return atob(t)}getKeyPair(){return this.keyPair}}const je=new vn,_n={id:"crypto",name:"Crypto",version:"1.0.0",async onMount(s){return console.log("✅ Crypto feature mounted"),{service:je}},async onUnmount(s){}};class bn{async createProfile(t,e){const n=await je.generateKeyPair(),i={userId:`user_${Date.now()}`,username:t,passwordHash:btoa(e),publicKey:n.publicKey,privateKey:n.privateKey,createdAt:Date.now()};return await q.set("profiles",i),i}async getProfile(t){return await q.get("profiles",t)}async getProfileByUsername(t){return(await q.getAll("profiles")).find(n=>n.username===t)}async saveProfile(t){await q.set("profiles",t)}}const it=new bn,wn={id:"identity",name:"Identity",version:"1.0.0",dependencies:["persistence","crypto"],async onMount(s){return console.log("✅ Identity feature mounted"),{service:it}},async onUnmount(s){}},Sn=qt({actors:{checkStoredSession:A(async()=>{const s=localStorage.getItem("session");if(s){const t=JSON.parse(s);return{userId:t.userId,token:t.token}}throw new Error("No session")}),login:A(async({input:s})=>{const{username:t,password:e}=s,n=await it.getProfileByUsername(t);if(!n)throw new Error("User not found");if(n.passwordHash!==btoa(e))throw new Error("Invalid password");const i={userId:n.userId,token:`token_${Date.now()}`};return localStorage.setItem("session",JSON.stringify(i)),i}),signup:A(async({input:s})=>{const{username:t,password:e}=s;if(await it.getProfileByUsername(t))throw new Error("Username already exists");const r={userId:(await it.createProfile(t,e)).userId,token:`token_${Date.now()}`};return localStorage.setItem("session",JSON.stringify(r)),r}),logout:A(async()=>(localStorage.removeItem("session"),{success:!0}))}}).createMachine({id:"auth",initial:"checkingSession",context:{userId:null,sessionToken:null,error:null,username:null,password:null},states:{checkingSession:{invoke:{src:"checkStoredSession",onDone:{target:"authenticated",actions:_({userId:({event:s})=>s.output.userId,sessionToken:({event:s})=>s.output.token})},onError:{target:"unauthenticated"}}},unauthenticated:{on:{LOGIN:{target:"loggingIn",actions:_({username:({event:s})=>s.username,password:({event:s})=>s.password,error:null})},SIGNUP:{target:"signingUp",actions:_({username:({event:s})=>s.username,password:({event:s})=>s.password,error:null})}}},loggingIn:{invoke:{src:"login",input:({context:s})=>({username:s.username,password:s.password}),onDone:{target:"authenticated",actions:_({userId:({event:s})=>s.output.userId,sessionToken:({event:s})=>s.output.token,error:null})},onError:{target:"unauthenticated",actions:_({error:({event:s})=>s.error.message})}}},signingUp:{invoke:{src:"signup",input:({context:s})=>({username:s.username,password:s.password}),onDone:{target:"authenticated",actions:_({userId:({event:s})=>s.output.userId,sessionToken:({event:s})=>s.output.token,error:null})},onError:{target:"unauthenticated",actions:_({error:({event:s})=>s.error.message})}}},authenticated:{on:{LOGOUT:{target:"loggingOut"},SESSION_EXPIRED:{target:"unauthenticated"}}},loggingOut:{invoke:{src:"logout",onDone:{target:"unauthenticated",actions:_({userId:null,sessionToken:null})}}}}}),$n={id:"auth",name:"Authentication",version:"1.0.0",dependencies:["identity","persistence"],async onMount(s){const{eventBus:t,actorRegistry:e}=s,n=N(Sn,{id:"auth"});return n.start(),e.register("auth",n,{type:"feature",featureId:"auth"}),n.subscribe(i=>{i.matches("authenticated")&&t.dispatch({type:"AUTH_SUCCESS",userId:i.context.userId},"HIGH"),i.matches("unauthenticated")&&t.dispatch({type:"AUTH_LOGOUT"},"HIGH")}),typeof window<"u"&&(window.addEventListener("auth-login",i=>{n.send({type:"LOGIN",username:i.detail.username,password:i.detail.password})}),window.addEventListener("auth-signup",i=>{n.send({type:"SIGNUP",username:i.detail.username,password:i.detail.password})})),{actor:n}},async onUnmount(s){s.actorRegistry.unregister("auth")},subscribedEvents:["APP_READY","LOGOUT","SESSION_EXPIRED"],emittedEvents:["AUTH_SUCCESS","AUTH_FAILED","AUTH_LOGOUT"]},En="modulepreload",An=function(s,t){return new URL(s,t).href},re={},oe=function(t,e,n){let i=Promise.resolve();if(e&&e.length>0){let d=function(f){return Promise.all(f.map(u=>Promise.resolve(u).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};const o=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),c=a?.nonce||a?.getAttribute("nonce");i=d(e.map(f=>{if(f=An(f,n),f in re)return;re[f]=!0;const u=f.endsWith(".css"),h=u?'[rel="stylesheet"]':"";if(n)for(let p=o.length-1;p>=0;p--){const g=o[p];if(g.href===f&&(!u||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${f}"]${h}`))return;const l=document.createElement("link");if(l.rel=u?"stylesheet":En,u||(l.as="script"),l.crossOrigin="",l.href=f,c&&l.setAttribute("nonce",c),document.head.appendChild(l),u)return new Promise((p,g)=>{l.addEventListener("load",p),l.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${f}`)))})}))}function r(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return i.then(o=>{for(const a of o||[])a.status==="rejected"&&r(a.reason);return t().catch(r)})},xn={id:"shell",name:"Shell",version:"1.0.0",dependencies:["auth"],async onMount(s){if(console.log("✅ Shell feature mounted"),await oe(()=>Promise.resolve().then(()=>Yn),void 0,import.meta.url),await oe(()=>Promise.resolve().then(()=>Zn),void 0,import.meta.url),typeof document<"u"){const t=document.getElementById("app");if(t){t.innerHTML="";const e=document.createElement("app-shell");t.appendChild(e)}else{const e=document.createElement("app-shell");document.body.appendChild(e)}}return{}},async onUnmount(s){const t=document.querySelector("app-shell");t&&t.remove()}};async function Tn(){console.log("🚀 Bootstrapping application..."),S.register(mn),S.register(_n),S.register(wn),S.register($n),S.register(xn);const s={eventBus:Jt,actorRegistry:Ze,featureRegistry:S};pn(s);const t=N(gn,{input:s});return t.start(),t.subscribe(e=>{console.log("App state:",e.value),e.matches("ready")&&Jt.dispatch({type:"APP_READY"},"HIGH")}),await kn(t,e=>e.matches("ready")),console.log("✅ Application ready!"),{appActor:t,context:s}}function kn(s,t){return new Promise(e=>{const n=s.subscribe(i=>{t(i)&&(n.unsubscribe(),e())})})}Tn().then(({appActor:s,context:t})=>{console.log("Application initialized successfully"),typeof window<"u"&&(window.appActor=s,window.appContext=t)}).catch(s=>{console.error("Failed to bootstrap application:",s)});const rt=globalThis,Nt=rt.ShadowRoot&&(rt.ShadyCSS===void 0||rt.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Bt=Symbol(),ae=new WeakMap;let He=class{constructor(t,e,n){if(this._$cssResult$=!0,n!==Bt)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t,this.t=e}get styleSheet(){let t=this.o;const e=this.t;if(Nt&&t===void 0){const n=e!==void 0&&e.length===1;n&&(t=ae.get(e)),t===void 0&&((this.o=t=new CSSStyleSheet).replaceSync(this.cssText),n&&ae.set(e,t))}return t}toString(){return this.cssText}};const In=s=>new He(typeof s=="string"?s:s+"",void 0,Bt),zt=(s,...t)=>{const e=s.length===1?s[0]:t.reduce((n,i,r)=>n+(o=>{if(o._$cssResult$===!0)return o.cssText;if(typeof o=="number")return o;throw Error("Value passed to 'css' function must be a 'css' function result: "+o+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(i)+s[r+1],s[0]);return new He(e,s,Bt)},Cn=(s,t)=>{if(Nt)s.adoptedStyleSheets=t.map(e=>e instanceof CSSStyleSheet?e:e.styleSheet);else for(const e of t){const n=document.createElement("style"),i=rt.litNonce;i!==void 0&&n.setAttribute("nonce",i),n.textContent=e.cssText,s.appendChild(n)}},ce=Nt?s=>s:s=>s instanceof CSSStyleSheet?(t=>{let e="";for(const n of t.cssRules)e+=n.cssText;return In(e)})(s):s;const{is:On,defineProperty:Pn,getOwnPropertyDescriptor:Mn,getOwnPropertyNames:Rn,getOwnPropertySymbols:Un,getPrototypeOf:Dn}=Object,gt=globalThis,ue=gt.trustedTypes,Ln=ue?ue.emptyScript:"",jn=gt.reactiveElementPolyfillSupport,X=(s,t)=>s,Tt={toAttribute(s,t){switch(t){case Boolean:s=s?Ln:null;break;case Object:case Array:s=s==null?s:JSON.stringify(s)}return s},fromAttribute(s,t){let e=s;switch(t){case Boolean:e=s!==null;break;case Number:e=s===null?null:Number(s);break;case Object:case Array:try{e=JSON.parse(s)}catch{e=null}}return e}},qe=(s,t)=>!On(s,t),he={attribute:!0,type:String,converter:Tt,reflect:!1,useDefault:!1,hasChanged:qe};Symbol.metadata??=Symbol("metadata"),gt.litPropertyMetadata??=new WeakMap;let j=class extends HTMLElement{static addInitializer(t){this._$Ei(),(this.l??=[]).push(t)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(t,e=he){if(e.state&&(e.attribute=!1),this._$Ei(),this.prototype.hasOwnProperty(t)&&((e=Object.create(e)).wrapped=!0),this.elementProperties.set(t,e),!e.noAccessor){const n=Symbol(),i=this.getPropertyDescriptor(t,n,e);i!==void 0&&Pn(this.prototype,t,i)}}static getPropertyDescriptor(t,e,n){const{get:i,set:r}=Mn(this.prototype,t)??{get(){return this[e]},set(o){this[e]=o}};return{get:i,set(o){const a=i?.call(this);r?.call(this,o),this.requestUpdate(t,a,n)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this.elementProperties.get(t)??he}static _$Ei(){if(this.hasOwnProperty(X("elementProperties")))return;const t=Dn(this);t.finalize(),t.l!==void 0&&(this.l=[...t.l]),this.elementProperties=new Map(t.elementProperties)}static finalize(){if(this.hasOwnProperty(X("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(X("properties"))){const e=this.properties,n=[...Rn(e),...Un(e)];for(const i of n)this.createProperty(i,e[i])}const t=this[Symbol.metadata];if(t!==null){const e=litPropertyMetadata.get(t);if(e!==void 0)for(const[n,i]of e)this.elementProperties.set(n,i)}this._$Eh=new Map;for(const[e,n]of this.elementProperties){const i=this._$Eu(e,n);i!==void 0&&this._$Eh.set(i,e)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(t){const e=[];if(Array.isArray(t)){const n=new Set(t.flat(1/0).reverse());for(const i of n)e.unshift(ce(i))}else t!==void 0&&e.push(ce(t));return e}static _$Eu(t,e){const n=e.attribute;return n===!1?void 0:typeof n=="string"?n:typeof t=="string"?t.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise(t=>this.enableUpdating=t),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach(t=>t(this))}addController(t){(this._$EO??=new Set).add(t),this.renderRoot!==void 0&&this.isConnected&&t.hostConnected?.()}removeController(t){this._$EO?.delete(t)}_$E_(){const t=new Map,e=this.constructor.elementProperties;for(const n of e.keys())this.hasOwnProperty(n)&&(t.set(n,this[n]),delete this[n]);t.size>0&&(this._$Ep=t)}createRenderRoot(){const t=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return Cn(t,this.constructor.elementStyles),t}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach(t=>t.hostConnected?.())}enableUpdating(t){}disconnectedCallback(){this._$EO?.forEach(t=>t.hostDisconnected?.())}attributeChangedCallback(t,e,n){this._$AK(t,n)}_$ET(t,e){const n=this.constructor.elementProperties.get(t),i=this.constructor._$Eu(t,n);if(i!==void 0&&n.reflect===!0){const r=(n.converter?.toAttribute!==void 0?n.converter:Tt).toAttribute(e,n.type);this._$Em=t,r==null?this.removeAttribute(i):this.setAttribute(i,r),this._$Em=null}}_$AK(t,e){const n=this.constructor,i=n._$Eh.get(t);if(i!==void 0&&this._$Em!==i){const r=n.getPropertyOptions(i),o=typeof r.converter=="function"?{fromAttribute:r.converter}:r.converter?.fromAttribute!==void 0?r.converter:Tt;this._$Em=i;const a=o.fromAttribute(e,r.type);this[i]=a??this._$Ej?.get(i)??a,this._$Em=null}}requestUpdate(t,e,n,i=!1,r){if(t!==void 0){const o=this.constructor;if(i===!1&&(r=this[t]),n??=o.getPropertyOptions(t),!((n.hasChanged??qe)(r,e)||n.useDefault&&n.reflect&&r===this._$Ej?.get(t)&&!this.hasAttribute(o._$Eu(t,n))))return;this.C(t,e,n)}this.isUpdatePending===!1&&(this._$ES=this._$EP())}C(t,e,{useDefault:n,reflect:i,wrapped:r},o){n&&!(this._$Ej??=new Map).has(t)&&(this._$Ej.set(t,o??e??this[t]),r!==!0||o!==void 0)||(this._$AL.has(t)||(this.hasUpdated||n||(e=void 0),this._$AL.set(t,e)),i===!0&&this._$Em!==t&&(this._$Eq??=new Set).add(t))}async _$EP(){this.isUpdatePending=!0;try{await this._$ES}catch(e){Promise.reject(e)}const t=this.scheduleUpdate();return t!=null&&await t,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[i,r]of this._$Ep)this[i]=r;this._$Ep=void 0}const n=this.constructor.elementProperties;if(n.size>0)for(const[i,r]of n){const{wrapped:o}=r,a=this[i];o!==!0||this._$AL.has(i)||a===void 0||this.C(i,void 0,r,a)}}let t=!1;const e=this._$AL;try{t=this.shouldUpdate(e),t?(this.willUpdate(e),this._$EO?.forEach(n=>n.hostUpdate?.()),this.update(e)):this._$EM()}catch(n){throw t=!1,this._$EM(),n}t&&this._$AE(e)}willUpdate(t){}_$AE(t){this._$EO?.forEach(e=>e.hostUpdated?.()),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(t)),this.updated(t)}_$EM(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(t){return!0}update(t){this._$Eq&&=this._$Eq.forEach(e=>this._$ET(e,this[e])),this._$EM()}updated(t){}firstUpdated(t){}};j.elementStyles=[],j.shadowRootOptions={mode:"open"},j[X("elementProperties")]=new Map,j[X("finalized")]=new Map,jn?.({ReactiveElement:j}),(gt.reactiveElementVersions??=[]).push("2.1.2");const Ft=globalThis,de=s=>s,dt=Ft.trustedTypes,le=dt?dt.createPolicy("lit-html",{createHTML:s=>s}):void 0,Ne="$lit$",$=`lit$${Math.random().toFixed(9).slice(2)}$`,Be="?"+$,Hn=`<${Be}>`,M=document,Y=()=>M.createComment(""),Z=s=>s===null||typeof s!="object"&&typeof s!="function",Gt=Array.isArray,qn=s=>Gt(s)||typeof s?.[Symbol.iterator]=="function",bt=`[ 	
\f\r]`,K=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,fe=/-->/g,pe=/>/g,T=RegExp(`>|${bt}(?:([^\\s"'>=/]+)(${bt}*=${bt}*(?:[^ 	
\f\r"'\`<>=]|("|')|))|$)`,"g"),ge=/'/g,ye=/"/g,ze=/^(?:script|style|textarea|title)$/i,Nn=s=>(t,...e)=>({_$litType$:s,strings:t,values:e}),b=Nn(1),G=Symbol.for("lit-noChange"),m=Symbol.for("lit-nothing"),me=new WeakMap,C=M.createTreeWalker(M,129);function Fe(s,t){if(!Gt(s)||!s.hasOwnProperty("raw"))throw Error("invalid template strings array");return le!==void 0?le.createHTML(t):t}const Bn=(s,t)=>{const e=s.length-1,n=[];let i,r=t===2?"<svg>":t===3?"<math>":"",o=K;for(let a=0;a<e;a++){const c=s[a];let d,f,u=-1,h=0;for(;h<c.length&&(o.lastIndex=h,f=o.exec(c),f!==null);)h=o.lastIndex,o===K?f[1]==="!--"?o=fe:f[1]!==void 0?o=pe:f[2]!==void 0?(ze.test(f[2])&&(i=RegExp("</"+f[2],"g")),o=T):f[3]!==void 0&&(o=T):o===T?f[0]===">"?(o=i??K,u=-1):f[1]===void 0?u=-2:(u=o.lastIndex-f[2].length,d=f[1],o=f[3]===void 0?T:f[3]==='"'?ye:ge):o===ye||o===ge?o=T:o===fe||o===pe?o=K:(o=T,i=void 0);const l=o===T&&s[a+1].startsWith("/>")?" ":"";r+=o===K?c+Hn:u>=0?(n.push(d),c.slice(0,u)+Ne+c.slice(u)+$+l):c+$+(u===-2?a:l)}return[Fe(s,r+(s[e]||"<?>")+(t===2?"</svg>":t===3?"</math>":"")),n]};class Q{constructor({strings:t,_$litType$:e},n){let i;this.parts=[];let r=0,o=0;const a=t.length-1,c=this.parts,[d,f]=Bn(t,e);if(this.el=Q.createElement(d,n),C.currentNode=this.el.content,e===2||e===3){const u=this.el.content.firstChild;u.replaceWith(...u.childNodes)}for(;(i=C.nextNode())!==null&&c.length<a;){if(i.nodeType===1){if(i.hasAttributes())for(const u of i.getAttributeNames())if(u.endsWith(Ne)){const h=f[o++],l=i.getAttribute(u).split($),p=/([.?@])?(.*)/.exec(h);c.push({type:1,index:r,name:p[2],strings:l,ctor:p[1]==="."?Fn:p[1]==="?"?Gn:p[1]==="@"?Wn:yt}),i.removeAttribute(u)}else u.startsWith($)&&(c.push({type:6,index:r}),i.removeAttribute(u));if(ze.test(i.tagName)){const u=i.textContent.split($),h=u.length-1;if(h>0){i.textContent=dt?dt.emptyScript:"";for(let l=0;l<h;l++)i.append(u[l],Y()),C.nextNode(),c.push({type:2,index:++r});i.append(u[h],Y())}}}else if(i.nodeType===8)if(i.data===Be)c.push({type:2,index:r});else{let u=-1;for(;(u=i.data.indexOf($,u+1))!==-1;)c.push({type:7,index:r}),u+=$.length-1}r++}}static createElement(t,e){const n=M.createElement("template");return n.innerHTML=t,n}}function W(s,t,e=s,n){if(t===G)return t;let i=n!==void 0?e._$Co?.[n]:e._$Cl;const r=Z(t)?void 0:t._$litDirective$;return i?.constructor!==r&&(i?._$AO?.(!1),r===void 0?i=void 0:(i=new r(s),i._$AT(s,e,n)),n!==void 0?(e._$Co??=[])[n]=i:e._$Cl=i),i!==void 0&&(t=W(s,i._$AS(s,t.values),i,n)),t}class zn{constructor(t,e){this._$AV=[],this._$AN=void 0,this._$AD=t,this._$AM=e}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(t){const{el:{content:e},parts:n}=this._$AD,i=(t?.creationScope??M).importNode(e,!0);C.currentNode=i;let r=C.nextNode(),o=0,a=0,c=n[0];for(;c!==void 0;){if(o===c.index){let d;c.type===2?d=new et(r,r.nextSibling,this,t):c.type===1?d=new c.ctor(r,c.name,c.strings,this,t):c.type===6&&(d=new Jn(r,this,t)),this._$AV.push(d),c=n[++a]}o!==c?.index&&(r=C.nextNode(),o++)}return C.currentNode=M,i}p(t){let e=0;for(const n of this._$AV)n!==void 0&&(n.strings!==void 0?(n._$AI(t,n,e),e+=n.strings.length-2):n._$AI(t[e])),e++}}class et{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(t,e,n,i){this.type=2,this._$AH=m,this._$AN=void 0,this._$AA=t,this._$AB=e,this._$AM=n,this.options=i,this._$Cv=i?.isConnected??!0}get parentNode(){let t=this._$AA.parentNode;const e=this._$AM;return e!==void 0&&t?.nodeType===11&&(t=e.parentNode),t}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(t,e=this){t=W(this,t,e),Z(t)?t===m||t==null||t===""?(this._$AH!==m&&this._$AR(),this._$AH=m):t!==this._$AH&&t!==G&&this._(t):t._$litType$!==void 0?this.$(t):t.nodeType!==void 0?this.T(t):qn(t)?this.k(t):this._(t)}O(t){return this._$AA.parentNode.insertBefore(t,this._$AB)}T(t){this._$AH!==t&&(this._$AR(),this._$AH=this.O(t))}_(t){this._$AH!==m&&Z(this._$AH)?this._$AA.nextSibling.data=t:this.T(M.createTextNode(t)),this._$AH=t}$(t){const{values:e,_$litType$:n}=t,i=typeof n=="number"?this._$AC(t):(n.el===void 0&&(n.el=Q.createElement(Fe(n.h,n.h[0]),this.options)),n);if(this._$AH?._$AD===i)this._$AH.p(e);else{const r=new zn(i,this),o=r.u(this.options);r.p(e),this.T(o),this._$AH=r}}_$AC(t){let e=me.get(t.strings);return e===void 0&&me.set(t.strings,e=new Q(t)),e}k(t){Gt(this._$AH)||(this._$AH=[],this._$AR());const e=this._$AH;let n,i=0;for(const r of t)i===e.length?e.push(n=new et(this.O(Y()),this.O(Y()),this,this.options)):n=e[i],n._$AI(r),i++;i<e.length&&(this._$AR(n&&n._$AB.nextSibling,i),e.length=i)}_$AR(t=this._$AA.nextSibling,e){for(this._$AP?.(!1,!0,e);t!==this._$AB;){const n=de(t).nextSibling;de(t).remove(),t=n}}setConnected(t){this._$AM===void 0&&(this._$Cv=t,this._$AP?.(t))}}class yt{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(t,e,n,i,r){this.type=1,this._$AH=m,this._$AN=void 0,this.element=t,this.name=e,this._$AM=i,this.options=r,n.length>2||n[0]!==""||n[1]!==""?(this._$AH=Array(n.length-1).fill(new String),this.strings=n):this._$AH=m}_$AI(t,e=this,n,i){const r=this.strings;let o=!1;if(r===void 0)t=W(this,t,e,0),o=!Z(t)||t!==this._$AH&&t!==G,o&&(this._$AH=t);else{const a=t;let c,d;for(t=r[0],c=0;c<r.length-1;c++)d=W(this,a[n+c],e,c),d===G&&(d=this._$AH[c]),o||=!Z(d)||d!==this._$AH[c],d===m?t=m:t!==m&&(t+=(d??"")+r[c+1]),this._$AH[c]=d}o&&!i&&this.j(t)}j(t){t===m?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,t??"")}}class Fn extends yt{constructor(){super(...arguments),this.type=3}j(t){this.element[this.name]=t===m?void 0:t}}class Gn extends yt{constructor(){super(...arguments),this.type=4}j(t){this.element.toggleAttribute(this.name,!!t&&t!==m)}}class Wn extends yt{constructor(t,e,n,i,r){super(t,e,n,i,r),this.type=5}_$AI(t,e=this){if((t=W(this,t,e,0)??m)===G)return;const n=this._$AH,i=t===m&&n!==m||t.capture!==n.capture||t.once!==n.once||t.passive!==n.passive,r=t!==m&&(n===m||i);i&&this.element.removeEventListener(this.name,this,n),r&&this.element.addEventListener(this.name,this,t),this._$AH=t}handleEvent(t){typeof this._$AH=="function"?this._$AH.call(this.options?.host??this.element,t):this._$AH.handleEvent(t)}}class Jn{constructor(t,e,n){this.element=t,this.type=6,this._$AN=void 0,this._$AM=e,this.options=n}get _$AU(){return this._$AM._$AU}_$AI(t){W(this,t)}}const Kn=Ft.litHtmlPolyfillSupport;Kn?.(Q,et),(Ft.litHtmlVersions??=[]).push("3.3.2");const Vn=(s,t,e)=>{const n=e?.renderBefore??t;let i=n._$litPart$;if(i===void 0){const r=e?.renderBefore??null;n._$litPart$=i=new et(t.insertBefore(Y(),r),r,void 0,e??{})}return i._$AI(s),i};const Wt=globalThis;class O extends j{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){const t=super.createRenderRoot();return this.renderOptions.renderBefore??=t.firstChild,t}update(t){const e=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(t),this._$Do=Vn(e,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(!1)}render(){return G}}O._$litElement$=!0,O.finalized=!0,Wt.litElementHydrateSupport?.({LitElement:O});const Xn=Wt.litElementPolyfillSupport;Xn?.({LitElement:O});(Wt.litElementVersions??=[]).push("4.2.2");class Ge extends O{static properties={error:{type:String},loading:{type:Boolean}};static styles=zt`
		:host {
			display: block;
			max-width: 400px;
			margin: 2rem auto;
			padding: 2rem;
			border: 1px solid #ddd;
			border-radius: 8px;
		}

		h2 {
			margin-top: 0;
		}

		.form-group {
			margin-bottom: 1rem;
		}

		label {
			display: block;
			margin-bottom: 0.5rem;
			font-weight: bold;
		}

		input {
			width: 100%;
			padding: 0.5rem;
			border: 1px solid #ddd;
			border-radius: 4px;
			box-sizing: border-box;
		}

		button {
			width: 100%;
			padding: 0.75rem;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 1rem;
		}

		button:hover {
			background: #0056b3;
		}

		button:disabled {
			background: #ccc;
			cursor: not-allowed;
		}

		.error {
			color: red;
			margin-top: 0.5rem;
		}

		.switch {
			margin-top: 1rem;
			text-align: center;
		}

		.switch a {
			color: #007bff;
			cursor: pointer;
			text-decoration: underline;
		}
	`;constructor(){super(),this.error="",this.loading=!1}connectedCallback(){if(super.connectedCallback(),typeof window<"u"&&window.appContext){const t=window.appContext.actorRegistry.get("auth");t&&t.subscribe(e=>{e.context?.error?(this.error=e.context.error,this.loading=!1):e.matches("authenticated")?(this.loading=!1,this.error=""):(e.matches("loggingIn")||e.matches("signingUp"))&&(this.loading=!0,this.error=""),this.requestUpdate()})}}handleSubmit(t){t.preventDefault();const e=new FormData(t.target),n=e.get("username"),i=e.get("password");if(!n||!i){this.error="Please fill in all fields";return}this.loading=!0,this.error="";const r=new CustomEvent("auth-login",{detail:{username:n,password:i},bubbles:!0,composed:!0});this.dispatchEvent(r)}handleSwitchToSignup(){this.dispatchEvent(new CustomEvent("auth-switch-to-signup",{bubbles:!0,composed:!0}))}render(){return b`
			<h2>Login</h2>
			<form @submit=${this.handleSubmit}>
				<div class="form-group">
					<label for="username">Username</label>
					<input
						type="text"
						id="username"
						name="username"
						required
						?disabled=${this.loading}
					/>
				</div>
				<div class="form-group">
					<label for="password">Password</label>
					<input
						type="password"
						id="password"
						name="password"
						required
						?disabled=${this.loading}
					/>
				</div>
				${this.error?b`<div class="error">${this.error}</div>`:""}
				<button type="submit" ?disabled=${this.loading}>
					${this.loading?"Logging in...":"Login"}
				</button>
				<div class="switch">
					Don't have an account?
					<a @click=${this.handleSwitchToSignup}>Sign up</a>
				</div>
			</form>
		`}}class We extends O{static properties={error:{type:String},loading:{type:Boolean}};static styles=zt`
		:host {
			display: block;
			max-width: 400px;
			margin: 2rem auto;
			padding: 2rem;
			border: 1px solid #ddd;
			border-radius: 8px;
		}

		h2 {
			margin-top: 0;
		}

		.form-group {
			margin-bottom: 1rem;
		}

		label {
			display: block;
			margin-bottom: 0.5rem;
			font-weight: bold;
		}

		input {
			width: 100%;
			padding: 0.5rem;
			border: 1px solid #ddd;
			border-radius: 4px;
			box-sizing: border-box;
		}

		button {
			width: 100%;
			padding: 0.75rem;
			background: #28a745;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 1rem;
		}

		button:hover {
			background: #218838;
		}

		button:disabled {
			background: #ccc;
			cursor: not-allowed;
		}

		.error {
			color: red;
			margin-top: 0.5rem;
		}

		.switch {
			margin-top: 1rem;
			text-align: center;
		}

		.switch a {
			color: #007bff;
			cursor: pointer;
			text-decoration: underline;
		}
	`;constructor(){super(),this.error="",this.loading=!1}connectedCallback(){if(super.connectedCallback(),typeof window<"u"&&window.appContext){const t=window.appContext.actorRegistry.get("auth");t&&t.subscribe(e=>{e.context?.error?(this.error=e.context.error,this.loading=!1):e.matches("authenticated")?(this.loading=!1,this.error=""):(e.matches("loggingIn")||e.matches("signingUp"))&&(this.loading=!0,this.error=""),this.requestUpdate()})}}handleSubmit(t){t.preventDefault();const e=new FormData(t.target),n=e.get("username"),i=e.get("password");if(!n||!i){this.error="Please fill in all fields";return}this.loading=!0,this.error="";const r=new CustomEvent("auth-signup",{detail:{username:n,password:i},bubbles:!0,composed:!0});this.dispatchEvent(r)}handleSwitchToLogin(){this.dispatchEvent(new CustomEvent("auth-switch-to-login",{bubbles:!0,composed:!0}))}render(){return b`
			<h2>Sign Up</h2>
			<form @submit=${this.handleSubmit}>
				<div class="form-group">
					<label for="username">Username</label>
					<input
						type="text"
						id="username"
						name="username"
						required
						?disabled=${this.loading}
					/>
				</div>
				<div class="form-group">
					<label for="password">Password</label>
					<input
						type="password"
						id="password"
						name="password"
						required
						?disabled=${this.loading}
					/>
				</div>
				${this.error?b`<div class="error">${this.error}</div>`:""}
				<button type="submit" ?disabled=${this.loading}>
					${this.loading?"Signing up...":"Sign Up"}
				</button>
				<div class="switch">
					Already have an account?
					<a @click=${this.handleSwitchToLogin}>Login</a>
				</div>
			</form>
		`}}customElements.define("login-form",Ge);customElements.define("signup-form",We);const Yn=Object.freeze(Object.defineProperty({__proto__:null,LoginForm:Ge,SignupForm:We},Symbol.toStringTag,{value:"Module"}));class Je extends O{static properties={authState:{type:String},showSignup:{type:Boolean},error:{type:String}};static styles=zt`
		:host {
			display: block;
			min-height: 100vh;
			background: #f5f5f5;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
		}

		.header {
			background: white;
			padding: 1rem 2rem;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			margin-bottom: 2rem;
		}

		.header h1 {
			margin: 0;
			color: #333;
		}

		.content {
			background: white;
			padding: 2rem;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.authenticated {
			text-align: center;
			padding: 2rem;
		}

		.authenticated h2 {
			color: #28a745;
		}

		button {
			padding: 0.5rem 1rem;
			background: #dc3545;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			margin-top: 1rem;
		}

		button:hover {
			background: #c82333;
		}
	`;constructor(){super(),this.authState="checking",this.showSignup=!1,this.error=""}connectedCallback(){super.connectedCallback();const t=()=>{if(typeof window<"u"&&window.appContext){const e=window.appContext.actorRegistry.get("auth");if(e){const n=e.getSnapshot();this.authState=n.value,n.context?.error&&(this.error=n.context.error),e.subscribe(i=>{this.authState=i.value,i.context?.error?this.error=i.context.error:this.error="",this.requestUpdate()}),this.requestUpdate()}}else setTimeout(t,100)};t(),window.addEventListener("auth-switch-to-signup",()=>{this.showSignup=!0,this.requestUpdate()}),window.addEventListener("auth-switch-to-login",()=>{this.showSignup=!1,this.requestUpdate()})}handleLogout(){const t=window.appContext?.actorRegistry.get("auth");t&&t.send({type:"LOGOUT"})}render(){return b`
			<div class="container">
				<div class="header">
					<h1>Chat App</h1>
				</div>
				<div class="content">
					${this.authState==="checking"||this.authState==="checkingSession"?b`<p>Checking session...</p>`:this.authState==="authenticated"?b`
									<div class="authenticated">
										<h2>✅ Authenticated!</h2>
										<p>Welcome to the app!</p>
										<button @click=${this.handleLogout}>Logout</button>
									</div>
								`:b`
									${this.showSignup?b`<signup-form></signup-form>`:b`<login-form></login-form>`}
									${this.error?b`<div style="color: red; margin-top: 1rem;">
												${this.error}
											</div>`:""}
								`}
				</div>
			</div>
		`}}customElements.define("app-shell",Je);const Zn=Object.freeze(Object.defineProperty({__proto__:null,AppShell:Je},Symbol.toStringTag,{value:"Module"}));</script>
	</head>
	<body>
		<div id="app">
			<div style="padding: 2rem; text-align: center;">
				<p>Initializing...</p>
			</div>
		</div>
	</body>
</html>
