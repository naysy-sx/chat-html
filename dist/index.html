<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chat App</title>
		<script type="module">class as{constructor(){this.features=new Map,this.mounted=new Map,this.dependencies=new Map,this.context=null}register(t){if(this.features.has(t.id))throw new Error(`Feature ${t.id} already registered`);this.validateFeature(t),this.features.set(t.id,t),t.dependencies&&this.dependencies.set(t.id,t.dependencies),t.onRegister&&this.context&&t.onRegister(this.context),console.log(`âœ… Feature registered: ${t.id}`)}setContext(t){this.context=t}async mountAll(t){this.setContext(t);const e=this.topologicalSort();console.log("ðŸ”§ mountAll called, sorted features:",e);for(const s of e)console.log(`ðŸ”§ mountAll: about to mount ${s}`),await this.mount(s,t),console.log(`ðŸ”§ mountAll: finished mounting ${s}`);console.log("ðŸ”§ mountAll: all features mounted")}async mount(t,e){const s=this.features.get(t);if(!s)throw console.error(`âŒ Feature ${t} not found in registry!`),new Error(`Feature ${t} not found`);if(this.mounted.has(t)){console.log(`â­ï¸ Feature ${t} already mounted, skipping`);return}if(s.dependencies){console.log(`ðŸ”§ Feature ${t} has dependencies:`,s.dependencies);for(const r of s.dependencies)this.mounted.has(r)||(console.log(`ðŸ”§ Mounting dependency ${r} before ${t}`),await this.mount(r,e))}console.log(`â¬†ï¸ Mounting feature: ${t}`);try{const r=await s.onMount(e);console.log(`âœ… Feature mounted: ${t}, result:`,r),this.mounted.set(t,r||{})}catch(r){throw console.error(`âŒ Error mounting feature ${t}:`,r),r}s.subscribedEvents&&e.eventBus&&this.subscribeToEvents(s,e.eventBus)}async unmountAll(){const t=this.topologicalSort().reverse();for(const e of t)await this.unmount(e)}async unmount(t){const e=this.features.get(t),s=this.mounted.get(t);s&&(console.log(`â¬‡ï¸ Unmounting feature: ${t}`),e.onUnmount&&this.context&&await e.onUnmount({...this.context,...s}),this.mounted.delete(t))}subscribeToEvents(t,e){for(const s of t.subscribedEvents)e.on(s,r=>{const o=this.mounted.get(t.id);o?.actor&&o.actor.send(r)})}topologicalSort(){const t=[],e=new Set,s=new Set,r=o=>{if(e.has(o))return;if(s.has(o))throw new Error(`Circular dependency detected: ${o}`);s.add(o);const i=this.dependencies.get(o)||[];for(const a of i){if(!this.features.has(a))throw new Error(`Feature ${o} depends on ${a}, but ${a} is not registered`);r(a)}s.delete(o),e.add(o),t.push(o)};for(const o of this.features.keys())r(o);return t}validateFeature(t){if(!t.id||!t.name)throw new Error("Feature must have id and name");if(!t.onMount)throw new Error(`Feature ${t.id} must have onMount`)}get(t){return this.features.get(t)}has(t){return this.features.has(t)}isMounted(t){return this.mounted.has(t)}getAll(){return Array.from(this.features.values())}getMountResult(t){return this.mounted.get(t)}}const k=new as;class cs extends EventTarget{constructor(){super(),this.queues={HIGH:[],MEDIUM:[],LOW:[],DROPPED:[]},this.limits={HIGH:1e3,MEDIUM:500,LOW:100},this.processing=!1,this.stats={dropped:0,processed:0},this.frameStart=performance.now()}dispatch(t,e="MEDIUM"){if(this.queues[e].length>this.limits[e]&&this.canDrop(e)){this.queues.DROPPED.push(t),this.stats.dropped++;return}this.queues[e].push(t),this.scheduleProcess()}canDrop(t){return["LOW"].includes(t)}hasEvents(){return this.queues.HIGH.length>0||this.queues.MEDIUM.length>0||this.queues.LOW.length>0}getNextEvent(){return this.queues.HIGH.length>0?this.queues.HIGH.shift():this.queues.MEDIUM.length>0?this.queues.MEDIUM.shift():this.queues.LOW.length>0?this.queues.LOW.shift():null}async scheduleProcess(){if(!this.processing){for(this.processing=!0,this.frameStart=performance.now();this.hasEvents();){const t=this.getNextEvent();if(!t)break;performance.now()-this.frameStart>10&&(await new Promise(e=>setTimeout(e,0)),this.frameStart=performance.now()),this.dispatchEvent(new CustomEvent(t.type||"event",{detail:t})),this.stats.processed++}this.processing=!1}}on(t,e){this.addEventListener(t,s=>{e(s.detail||s)})}off(t,e){this.removeEventListener(t,e)}}const L=new cs;class ls{constructor(){this.actors=new Map,this.stats=new Map,this.listeners=new Set}subscribe(t){return this.listeners.add(t),t({type:"sync",actors:this.actors}),()=>{this.listeners.delete(t)}}_emit(t){for(const e of this.listeners)try{e(t)}catch(s){console.error("[ActorRegistry] listener error",s)}}register(t,e,s={}){if(!t)throw new Error("Actor id is required");if(!e)throw new Error("Actor instance is required");this.actors.has(t)&&this._internalUnregister(t,"replaced");const r={actor:e,meta:{...s,id:t,type:s.type||"unknown",spawnedAt:Date.now()}};return this.actors.set(t,r),this._updateStats(t,"spawned"),this._emit({type:"registered",id:t,entry:r,actors:this.actors}),this._attachLifecycle(t,e),e}unregister(t){return this._internalUnregister(t,"manual")}get(t){return this.actors.get(t)?.actor||null}getEntry(t){return this.actors.get(t)||null}getAll(t){return Array.from(this.actors.values()).filter(e=>!t||e.meta.type===t).map(e=>e.actor)}has(t){return this.actors.has(t)}clear(){for(const t of Array.from(this.actors.keys()))this._internalUnregister(t,"clear")}_internalUnregister(t,e="manual"){const s=this.actors.get(t);if(!s)return!1;const{actor:r,meta:o}=s;if(this.actors.delete(t),this._updateStats(t,"stopped"),typeof r.stop=="function")try{r.stop()}catch(a){console.error(`[ActorRegistry] stop error (${t})`,a)}const i=Date.now()-o.spawnedAt;return this._emit({type:"unregistered",id:t,entry:s,reason:e,lifetime:i,actors:this.actors}),console.debug(`[ActorRegistry] actor "${t}" stopped after ${i}ms (${e})`),!0}_attachLifecycle(t,e){e?.subscribe&&e.subscribe({complete:()=>{this._updateStats(t,"stopped"),this._internalUnregister(t,"completed")},error:s=>{this._updateStats(t,"error",s),this._emit({type:"error",id:t,error:s,entry:this.actors.get(t)||null}),this._internalUnregister(t,"error")}})}_updateStats(t,e,s=null){this.stats.has(t)||this.stats.set(t,{spawned:0,stopped:0,errors:[]});const r=this.stats.get(t);e==="spawned"&&r.spawned++,e==="stopped"&&r.stopped++,e==="error"&&s&&r.errors.push(s)}getStats(){return{active:this.actors.size,total:this.stats.size,byType:this._groupByType()}}_groupByType(){const t={};for(const{meta:e}of this.actors.values())t[e.type]=(t[e.type]||0)+1;return t}}const ds=new ls;function us(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function hs(){const n=us();if(n.__xstate__)return n.__xstate__}const ps=n=>{if(typeof window>"u")return;const t=hs();t&&t.register(n)};class se{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const e={value:t,next:null};if(this._current){this._last.next=e,this._last=e;return}this._current=e,this._last=e,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const ke=".",gs="",Te="",fs="#",vs="*",$e="xstate.init",ms="xstate.error",ot="xstate.stop";function ys(n,t){return{type:`xstate.after.${n}.${t}`}}function Tt(n,t){return{type:`xstate.done.state.${n}`,output:t}}function bs(n,t){return{type:`xstate.done.actor.${n}`,output:t,actorId:n}}function De(n,t){return{type:`xstate.error.actor.${n}`,error:t,actorId:n}}function Re(n){return{type:$e,input:n}}function $(n){setTimeout(()=>{throw n})}const _s=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Oe(n,t){const e=re(n),s=re(t);return typeof s=="string"?typeof e=="string"?s===e:!1:typeof e=="string"?e in s:Object.keys(e).every(r=>r in s?Oe(e[r],s[r]):!1)}function Ut(n){if(Pe(n))return n;const t=[];let e="";for(let s=0;s<n.length;s++){switch(n.charCodeAt(s)){case 92:e+=n[s+1],s++;continue;case 46:t.push(e),e="";continue}e+=n[s]}return t.push(e),t}function re(n){if(Zs(n))return n.value;if(typeof n!="string")return n;const t=Ut(n);return ws(t)}function ws(n){if(n.length===1)return n[0];const t={};let e=t;for(let s=0;s<n.length-1;s++)if(s===n.length-2)e[n[s]]=n[s+1];else{const r=e;e={},r[n[s]]=e}return t}function ne(n,t){const e={},s=Object.keys(n);for(let r=0;r<s.length;r++){const o=s[r];e[o]=t(n[o],o,n,r)}return e}function Ne(n){return Pe(n)?n:[n]}function O(n){return n===void 0?[]:Ne(n)}function $t(n,t,e,s){return typeof n=="function"?n({context:t,event:e,self:s}):n}function Pe(n){return Array.isArray(n)}function xs(n){return n.type.startsWith("xstate.error.actor")}function V(n){return Ne(n).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function Ue(n){if(!(n===void 0||n===gs))return O(n)}function Dt(n,t,e){const s=typeof n=="object",r=s?n:void 0;return{next:(s?n.next:n)?.bind(r),error:(s?n.error:t)?.bind(r),complete:(s?n.complete:e)?.bind(r)}}function oe(n,t){return`${t}.${n}`}function Lt(n,t){const e=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!e)return n.implementations.actors[t];const[,s,r]=e,i=n.getStateNodeById(r).config.invoke;return(Array.isArray(i)?i[s]:i).src}function Ss(n,t){if(t===n||t===vs)return!0;if(!t.endsWith(".*"))return!1;const e=t.split("."),s=n.split(".");for(let r=0;r<e.length;r++){const o=e[r],i=s[r];if(o==="*")return r===e.length-1;if(o!==i)return!1}return!0}function ie(n,t){return`${n.sessionId}.${t}`}let Es=0;function As(n,t){const e=new Map,s=new Map,r=new WeakMap,o=new Set,i={},{clock:a,logger:c}=t,l={schedule:(u,p,g,v,_=Math.random().toString(36).slice(2))=>{const C={source:u,target:p,event:g,delay:v,id:_,startedAt:Date.now()},y=ie(u,_);d._snapshot._scheduledEvents[y]=C;const S=a.setTimeout(()=>{delete i[y],delete d._snapshot._scheduledEvents[y],d._relay(u,p,g)},v);i[y]=S},cancel:(u,p)=>{const g=ie(u,p),v=i[g];delete i[g],delete d._snapshot._scheduledEvents[g],v!==void 0&&a.clearTimeout(v)},cancelAll:u=>{for(const p in d._snapshot._scheduledEvents){const g=d._snapshot._scheduledEvents[p];g.source===u&&l.cancel(u,g.id)}}},h=u=>{if(!o.size)return;const p={...u,rootId:n.sessionId};o.forEach(g=>g.next?.(p))},d={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${Es++}`,_register:(u,p)=>(e.set(u,p),u),_unregister:u=>{e.delete(u.sessionId);const p=r.get(u);p!==void 0&&(s.delete(p),r.delete(u))},get:u=>s.get(u),getAll:()=>Object.fromEntries(s.entries()),_set:(u,p)=>{const g=s.get(u);if(g&&g!==p)throw new Error(`Actor with system ID '${u}' already exists.`);s.set(u,p),r.set(p,u)},inspect:u=>{const p=Dt(u);return o.add(p),{unsubscribe(){o.delete(p)}}},_sendInspectionEvent:h,_relay:(u,p,g)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:u,actorRef:p,event:g}),p._send(g)},scheduler:l,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{const u=d._snapshot._scheduledEvents;d._snapshot._scheduledEvents={};for(const p in u){const{source:g,target:v,event:_,delay:C,id:y}=u[p];l.schedule(g,v,_,C,y)}},_clock:a,_logger:c};return d}let At=!1;const Mt=1;let I=(function(n){return n[n.NotStarted=0]="NotStarted",n[n.Running=1]="Running",n[n.Stopped=2]="Stopped",n})({});const Cs={clock:{setTimeout:(n,t)=>setTimeout(n,t),clearTimeout:n=>clearTimeout(n)},logger:console.log.bind(console),devTools:!1};class Is{constructor(t,e){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new se(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=I.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this.systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const s={...Cs,...e},{clock:r,logger:o,parent:i,syncSnapshot:a,id:c,systemId:l,inspect:h}=s;this.system=i?i.system:As(this,{clock:r,logger:o}),h&&!i&&this.system.inspect(Dt(h)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=e?.logger??this.system._logger,this.clock=e?.clock??this.system._clock,this._parent=i,this._syncSnapshot=a,this.options=s,this.src=s.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:d=>{this._deferred.push(d)},system:this.system,stopChild:d=>{if(d._parent!==this)throw new Error(`Cannot stop child actor ${d.id} of ${this.id} because it is not a child`);d._stop()},emit:d=>{const u=this.eventListeners.get(d.type),p=this.eventListeners.get("*");if(!u&&!p)return;const g=[...u?u.values():[],...p?p.values():[]];for(const v of g)try{v(d)}catch(_){$(_)}},actionExecutor:d=>{const u=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:d.type,params:d.params}}),!d.exec)return;const p=At;try{At=!0,d.exec(d.info,d.params)}finally{At=p}};this._processingStatus===I.Running?u():this._deferred.push(u)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),l&&(this.systemId=l,this.system._set(l,this)),this._initState(e?.snapshot??e?.state),l&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(e){this._snapshot={status:"error",output:void 0,error:e}}}update(t,e){this._snapshot=t;let s;for(;s=this._deferred.shift();)try{s()}catch(r){this._deferred.length=0,this._snapshot={...t,status:"error",error:r}}switch(this._snapshot.status){case"active":for(const r of this.observers)try{r.next?.(t)}catch(o){$(o)}break;case"done":for(const r of this.observers)try{r.next?.(t)}catch(o){$(o)}this._stopProcedure(),this._complete(),this._doneEvent=bs(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:e,snapshot:t})}subscribe(t,e,s){const r=Dt(t,e,s);if(this._processingStatus!==I.Stopped)this.observers.add(r);else switch(this._snapshot.status){case"done":try{r.complete?.()}catch(o){$(o)}break;case"error":{const o=this._snapshot.error;if(!r.error)$(o);else try{r.error(o)}catch(i){$(i)}break}}return{unsubscribe:()=>{this.observers.delete(r)}}}on(t,e){let s=this.eventListeners.get(t);s||(s=new Set,this.eventListeners.set(t,s));const r=e.bind(void 0);return s.add(r),{unsubscribe:()=>{s.delete(r)}}}start(){if(this._processingStatus===I.Running)return this;this._syncSnapshot&&this.subscribe({next:s=>{s.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:s})},error:()=>{}}),this.system._register(this.sessionId,this),this.systemId&&this.system._set(this.systemId,this),this._processingStatus=I.Running;const t=Re(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(s){return this._snapshot={...this._snapshot,status:"error",error:s},this._error(s),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let e,s;try{e=this.logic.transition(this._snapshot,t,this._actorScope)}catch(r){s={err:r}}if(s){const{err:r}=s;this._snapshot={...this._snapshot,status:"error",error:r},this._error(r);return}this.update(e,t),t.type===ot&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===I.Stopped?this:(this.mailbox.clear(),this._processingStatus===I.NotStarted?(this._processingStatus=I.Stopped,this):(this.mailbox.enqueue({type:ot}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(const t of this.observers)try{t.complete?.()}catch(e){$(e)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||$(t);return}let e=!1;for(const s of this.observers){const r=s.error;e||=!r;try{r?.(t)}catch(o){$(o)}}this.observers.clear(),e&&$(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,De(this.id,t))}_stopProcedure(){return this._processingStatus!==I.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new se(this._process.bind(this)),this._processingStatus=I.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==I.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:ps)(this)}toJSON(){return{xstate$$type:Mt,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[_s](){return this}getSnapshot(){return this._snapshot}}function T(n,...[t]){return new Is(n,t)}function ks(n,t,e,s,{sendId:r}){const o=typeof r=="function"?r(e,s):r;return[t,{sendId:o},void 0]}function Ts(n,t){n.defer(()=>{n.system.scheduler.cancel(n.self,t.sendId)})}function zt(n){function t(e,s){}return t.type="xstate.cancel",t.sendId=n,t.resolve=ks,t.execute=Ts,t}function $s(n,t,e,s,{id:r,systemId:o,src:i,input:a,syncSnapshot:c}){const l=typeof i=="string"?Lt(t.machine,i):i,h=typeof r=="function"?r(e):r;let d,u;return l&&(u=typeof a=="function"?a({context:t.context,event:e.event,self:n.self}):a,d=T(l,{id:h,src:i,parent:n.self,syncSnapshot:c,systemId:o,input:u})),[B(t,{children:{...t.children,[h]:d}}),{id:r,systemId:o,actorRef:d,src:i,input:u},void 0]}function Ds(n,{actorRef:t}){t&&n.defer(()=>{t._processingStatus!==I.Stopped&&t.start()})}function jt(...[n,{id:t,systemId:e,input:s,syncSnapshot:r=!1}={}]){function o(i,a){}return o.type="xstate.spawnChild",o.id=t,o.systemId=e,o.src=n,o.input=s,o.syncSnapshot=r,o.resolve=$s,o.execute=Ds,o}function Rs(n,t,e,s,{actorRef:r}){const o=typeof r=="function"?r(e,s):r,i=typeof o=="string"?t.children[o]:o;let a=t.children;return i&&(a={...a},delete a[i.id]),[B(t,{children:a}),i,void 0]}function Os(n,t){if(t){if(n.system._unregister(t),t._processingStatus!==I.Running){n.stopChild(t);return}n.defer(()=>{n.stopChild(t)})}}function _t(n){function t(e,s){}return t.type="xstate.stopChild",t.actorRef=n,t.resolve=Rs,t.execute=Os,t}function wt(n,t,e,s){const{machine:r}=s,o=typeof n=="function",i=o?n:r.implementations.guards[typeof n=="string"?n:n.type];if(!o&&!i)throw new Error(`Guard '${typeof n=="string"?n:n.type}' is not implemented.'.`);if(typeof i!="function")return wt(i,t,e,s);const a={context:t,event:e},c=o||typeof n=="string"?void 0:"params"in n?typeof n.params=="function"?n.params({context:t,event:e}):n.params:void 0;return"check"in i?i.check(s,a,i):i(a,c)}const Bt=n=>n.type==="atomic"||n.type==="final";function Y(n){return Object.values(n.states).filter(t=>t.type!=="history")}function lt(n,t){const e=[];if(t===n)return e;let s=n.parent;for(;s&&s!==t;)e.push(s),s=s.parent;return e}function ft(n){const t=new Set(n),e=Me(t);for(const s of t)if(s.type==="compound"&&(!e.get(s)||!e.get(s).length))ae(s).forEach(r=>t.add(r));else if(s.type==="parallel"){for(const r of Y(s))if(r.type!=="history"&&!t.has(r)){const o=ae(r);for(const i of o)t.add(i)}}for(const s of t){let r=s.parent;for(;r;)t.add(r),r=r.parent}return t}function Le(n,t){const e=t.get(n);if(!e)return{};if(n.type==="compound"){const r=e[0];if(r){if(Bt(r))return r.key}else return{}}const s={};for(const r of e)s[r.key]=Le(r,t);return s}function Me(n){const t=new Map;for(const e of n)t.has(e)||t.set(e,[]),e.parent&&(t.has(e.parent)||t.set(e.parent,[]),t.get(e.parent).push(e));return t}function ze(n,t){const e=ft(t);return Le(n,Me(e))}function Gt(n,t){return t.type==="compound"?Y(t).some(e=>e.type==="final"&&n.has(e)):t.type==="parallel"?Y(t).every(e=>Gt(n,e)):t.type==="final"}const xt=n=>n[0]===fs;function Ns(n,t){return n.transitions.get(t)||[...n.transitions.keys()].filter(s=>Ss(t,s)).sort((s,r)=>r.length-s.length).flatMap(s=>n.transitions.get(s))}function Ps(n){const t=n.config.after;if(!t)return[];const e=r=>{const o=ys(r,n.id),i=o.type;return n.entry.push(Ht(o,{id:i,delay:r})),n.exit.push(zt(i)),i};return Object.keys(t).flatMap(r=>{const o=t[r],i=typeof o=="string"?{target:o}:o,a=Number.isNaN(+r)?r:+r,c=e(a);return O(i).map(l=>({...l,event:c,delay:a}))}).map(r=>{const{delay:o}=r;return{...M(n,r.event,r),delay:o}})}function M(n,t,e){const s=Ue(e.target),r=e.reenter??!1,o=Ms(n,s),i={...e,actions:O(e.actions),guard:e.guard,target:o,source:n,reenter:r,eventType:t,toJSON:()=>({...i,source:`#${n.id}`,target:o?o.map(a=>`#${a.id}`):void 0})};return i}function Us(n){const t=new Map;if(n.config.on)for(const e of Object.keys(n.config.on)){if(e===Te)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const s=n.config.on[e];t.set(e,V(s).map(r=>M(n,e,r)))}if(n.config.onDone){const e=`xstate.done.state.${n.id}`;t.set(e,V(n.config.onDone).map(s=>M(n,e,s)))}for(const e of n.invoke){if(e.onDone){const s=`xstate.done.actor.${e.id}`;t.set(s,V(e.onDone).map(r=>M(n,s,r)))}if(e.onError){const s=`xstate.error.actor.${e.id}`;t.set(s,V(e.onError).map(r=>M(n,s,r)))}if(e.onSnapshot){const s=`xstate.snapshot.${e.id}`;t.set(s,V(e.onSnapshot).map(r=>M(n,s,r)))}}for(const e of n.after){let s=t.get(e.eventType);s||(s=[],t.set(e.eventType,s)),s.push(e)}return t}function Ls(n,t){const e=typeof t=="string"?n.states[t]:t?n.states[t.target]:void 0;if(!e&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${n.id}`);const s={source:n,actions:!t||typeof t=="string"?[]:O(t.actions),eventType:null,reenter:!1,target:e?[e]:[],toJSON:()=>({...s,source:`#${n.id}`,target:e?[`#${e.id}`]:[]})};return s}function Ms(n,t){if(t!==void 0)return t.map(e=>{if(typeof e!="string")return e;if(xt(e))return n.machine.getStateNodeById(e);const s=e[0]===ke;if(s&&!n.parent)return vt(n,e.slice(1));const r=s?n.key+e:e;if(n.parent)try{return vt(n.parent,r)}catch(o){throw new Error(`Invalid transition definition for state node '${n.id}':
${o.message}`)}else throw new Error(`Invalid target: "${e}" is not a valid target from the root node. Did you mean ".${e}"?`)})}function je(n){const t=Ue(n.config.target);return t?{target:t.map(e=>typeof e=="string"?vt(n.parent,e):e)}:n.parent.initial}function z(n){return n.type==="history"}function ae(n){const t=Be(n);for(const e of t)for(const s of lt(e,n))t.add(s);return t}function Be(n){const t=new Set;function e(s){if(!t.has(s)){if(t.add(s),s.type==="compound")e(s.initial.target[0]);else if(s.type==="parallel")for(const r of Y(s))e(r)}}return e(n),t}function J(n,t){if(xt(t))return n.machine.getStateNodeById(t);if(!n.states)throw new Error(`Unable to retrieve child state '${t}' from '${n.id}'; no child states exist.`);const e=n.states[t];if(!e)throw new Error(`Child state '${t}' does not exist on '${n.id}'`);return e}function vt(n,t){if(typeof t=="string"&&xt(t))try{return n.machine.getStateNodeById(t)}catch{}const e=Ut(t).slice();let s=n;for(;e.length;){const r=e.shift();if(!r.length)break;s=J(s,r)}return s}function mt(n,t){if(typeof t=="string"){const r=n.states[t];if(!r)throw new Error(`State '${t}' does not exist on '${n.id}'`);return[n,r]}const e=Object.keys(t),s=e.map(r=>J(n,r)).filter(Boolean);return[n.machine.root,n].concat(s,e.reduce((r,o)=>{const i=J(n,o);if(!i)return r;const a=mt(i,t[o]);return r.concat(a)},[]))}function zs(n,t,e,s){const o=J(n,t).next(e,s);return!o||!o.length?n.next(e,s):o}function js(n,t,e,s){const r=Object.keys(t),o=J(n,r[0]),i=qt(o,t[r[0]],e,s);return!i||!i.length?n.next(e,s):i}function Bs(n,t,e,s){const r=[];for(const o of Object.keys(t)){const i=t[o];if(!i)continue;const a=J(n,o),c=qt(a,i,e,s);c&&r.push(...c)}return r.length?r:n.next(e,s)}function qt(n,t,e,s){return typeof t=="string"?zs(n,t,e,s):Object.keys(t).length===1?js(n,t,e,s):Bs(n,t,e,s)}function Gs(n){return Object.keys(n.states).map(t=>n.states[t]).filter(t=>t.type==="history")}function N(n,t){let e=n;for(;e.parent&&e.parent!==t;)e=e.parent;return e.parent===t}function qs(n,t){const e=new Set(n),s=new Set(t);for(const r of e)if(s.has(r))return!0;for(const r of s)if(e.has(r))return!0;return!1}function Ge(n,t,e){const s=new Set;for(const r of n){let o=!1;const i=new Set;for(const a of s)if(qs(Rt([r],t,e),Rt([a],t,e)))if(N(r.source,a.source))i.add(a);else{o=!0;break}if(!o){for(const a of i)s.delete(a);s.add(r)}}return Array.from(s)}function Fs(n){const[t,...e]=n;for(const s of lt(t,void 0))if(e.every(r=>N(r,s)))return s}function Ft(n,t){if(!n.target)return[];const e=new Set;for(const s of n.target)if(z(s))if(t[s.id])for(const r of t[s.id])e.add(r);else for(const r of Ft(je(s),t))e.add(r);else e.add(s);return[...e]}function qe(n,t){const e=Ft(n,t);if(!e)return;if(!n.reenter&&e.every(r=>r===n.source||N(r,n.source)))return n.source;const s=Fs(e.concat(n.source));if(s)return s;if(!n.reenter)return n.source.machine.root}function Rt(n,t,e){const s=new Set;for(const r of n)if(r.target?.length){const o=qe(r,e);r.reenter&&r.source===o&&s.add(o);for(const i of t)N(i,o)&&s.add(i)}return[...s]}function Hs(n,t){if(n.length!==t.size)return!1;for(const e of n)if(!t.has(e))return!1;return!0}function Ot(n,t,e,s,r,o){if(!n.length)return t;const i=new Set(t._nodes);let a=t.historyValue;const c=Ge(n,i,a);let l=t;r||([l,a]=Ys(l,s,e,c,i,a,o,e.actionExecutor)),l=X(l,s,e,c.flatMap(d=>d.actions),o,void 0),l=Ks(l,s,e,c,i,o,a,r);const h=[...i];l.status==="done"&&(l=X(l,s,e,h.sort((d,u)=>u.order-d.order).flatMap(d=>d.exit),o,void 0));try{return a===t.historyValue&&Hs(t._nodes,i)?l:B(l,{_nodes:h,historyValue:a})}catch(d){throw d}}function Vs(n,t,e,s,r){if(s.output===void 0)return;const o=Tt(r.id,r.output!==void 0&&r.parent?$t(r.output,n.context,t,e.self):void 0);return $t(s.output,n.context,o,e.self)}function Ks(n,t,e,s,r,o,i,a){let c=n;const l=new Set,h=new Set;Ws(s,i,h,l),a&&h.add(n.machine.root);const d=new Set;for(const u of[...l].sort((p,g)=>p.order-g.order)){r.add(u);const p=[];p.push(...u.entry);for(const g of u.invoke)p.push(jt(g.src,{...g,syncSnapshot:!!g.onSnapshot}));if(h.has(u)){const g=u.initial.actions;p.push(...g)}if(c=X(c,t,e,p,o,u.invoke.map(g=>g.id)),u.type==="final"){const g=u.parent;let v=g?.type==="parallel"?g:g?.parent,_=v||u;for(g?.type==="compound"&&o.push(Tt(g.id,u.output!==void 0?$t(u.output,c.context,t,e.self):void 0));v?.type==="parallel"&&!d.has(v)&&Gt(r,v);)d.add(v),o.push(Tt(v.id)),_=v,v=v.parent;if(v)continue;c=B(c,{status:"done",output:Vs(c,t,e,c.machine.root,_)})}}return c}function Ws(n,t,e,s){for(const r of n){const o=qe(r,t);for(const a of r.target||[])!z(a)&&(r.source!==a||r.source!==o||r.reenter)&&(s.add(a),e.add(a)),W(a,t,e,s);const i=Ft(r,t);for(const a of i){const c=lt(a,o);o?.type==="parallel"&&c.push(o),Fe(s,t,e,c,!r.source.parent&&r.reenter?void 0:o)}}}function W(n,t,e,s){if(z(n))if(t[n.id]){const r=t[n.id];for(const o of r)s.add(o),W(o,t,e,s);for(const o of r)Ct(o,n.parent,s,t,e)}else{const r=je(n);for(const o of r.target)s.add(o),r===n.parent?.initial&&e.add(n.parent),W(o,t,e,s);for(const o of r.target)Ct(o,n.parent,s,t,e)}else if(n.type==="compound"){const[r]=n.initial.target;z(r)||(s.add(r),e.add(r)),W(r,t,e,s),Ct(r,n,s,t,e)}else if(n.type==="parallel")for(const r of Y(n).filter(o=>!z(o)))[...s].some(o=>N(o,r))||(z(r)||(s.add(r),e.add(r)),W(r,t,e,s))}function Fe(n,t,e,s,r){for(const o of s)if((!r||N(o,r))&&n.add(o),o.type==="parallel")for(const i of Y(o).filter(a=>!z(a)))[...n].some(a=>N(a,i))||(n.add(i),W(i,t,e,n))}function Ct(n,t,e,s,r){Fe(e,s,r,lt(n,t))}function Ys(n,t,e,s,r,o,i,a){let c=n;const l=Rt(s,r,o);l.sort((d,u)=>u.order-d.order);let h;for(const d of l)for(const u of Gs(d)){let p;u.history==="deep"?p=g=>Bt(g)&&N(g,d):p=g=>g.parent===d,h??={...o},h[u.id]=Array.from(r).filter(p)}for(const d of l)c=X(c,t,e,[...d.exit,...d.invoke.map(u=>_t(u.id))],i,void 0),r.delete(d);return[c,h||o]}function Js(n,t){return n.implementations.actions[t]}function He(n,t,e,s,r,o){const{machine:i}=n;let a=n;for(const c of s){const l=typeof c=="function",h=l?c:Js(i,typeof c=="string"?c:c.type),d={context:a.context,event:t,self:e.self,system:e.system},u=l||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:t}):c.params:void 0;if(!h||!("resolve"in h)){e.actionExecutor({type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",info:d,params:u,exec:h});continue}const p=h,[g,v,_]=p.resolve(e,a,d,u,h,r);a=g,"retryResolve"in p&&o?.push([p,v]),"execute"in p&&e.actionExecutor({type:p.type,info:d,params:v,exec:p.execute.bind(null,e,v)}),_&&(a=He(a,t,e,_,r,o))}return a}function X(n,t,e,s,r,o){const i=o?[]:void 0,a=He(n,t,e,s,{internalQueue:r,deferredActorIds:o},i);return i?.forEach(([c,l])=>{c.retryResolve(e,a,l)}),a}function It(n,t,e,s){let r=n;const o=[];function i(l,h,d){e.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:e.self,event:h,snapshot:l,_transitions:d}),o.push(l)}if(t.type===ot)return r=B(ce(r,t,e),{status:"stopped"}),i(r,t,[]),{snapshot:r,microstates:o};let a=t;if(a.type!==$e){const l=a,h=xs(l),d=le(l,r);if(h&&!d.length)return r=B(n,{status:"error",error:l.error}),i(r,l,[]),{snapshot:r,microstates:o};r=Ot(d,n,e,a,!1,s),i(r,l,d)}let c=!0;for(;r.status==="active";){let l=c?Xs(r,a):[];const h=l.length?r:void 0;if(!l.length){if(!s.length)break;a=s.shift(),l=le(a,r)}r=Ot(l,r,e,a,!1,s),c=r!==h,i(r,a,l)}return r.status!=="active"&&ce(r,a,e),{snapshot:r,microstates:o}}function ce(n,t,e){return X(n,t,e,Object.values(n.children).map(s=>_t(s)),[],void 0)}function le(n,t){return t.machine.getTransitionData(t,n)}function Xs(n,t){const e=new Set,s=n._nodes.filter(Bt);for(const r of s)t:for(const o of[r].concat(lt(r,void 0)))if(o.always){for(const i of o.always)if(i.guard===void 0||wt(i.guard,n.context,t,n)){e.add(i);break t}}return Ge(Array.from(e),new Set(n._nodes),n.historyValue)}function Qs(n,t){const e=ft(mt(n,t));return ze(n,[...e])}function Zs(n){return!!n&&typeof n=="object"&&"machine"in n&&"value"in n}const tr=function(t){return Oe(t,this.value)},er=function(t){return this.tags.has(t)},sr=function(t){const e=this.machine.getTransitionData(this,t);return!!e?.length&&e.some(s=>s.target!==void 0||s.actions.length)},rr=function(){const{_nodes:t,tags:e,machine:s,getMeta:r,toJSON:o,can:i,hasTag:a,matches:c,...l}=this;return{...l,tags:Array.from(e)}},nr=function(){return this._nodes.reduce((t,e)=>(e.meta!==void 0&&(t[e.id]=e.meta),t),{})};function pt(n,t){return{status:n.status,output:n.output,error:n.error,machine:t,context:n.context,_nodes:n._nodes,value:ze(t.root,n._nodes),tags:new Set(n._nodes.flatMap(e=>e.tags)),children:n.children,historyValue:n.historyValue||{},matches:tr,hasTag:er,can:sr,getMeta:nr,toJSON:rr}}function B(n,t={}){return pt({...n,...t},n.machine)}function or(n){if(typeof n!="object"||n===null)return{};const t={};for(const e in n){const s=n[e];Array.isArray(s)&&(t[e]=s.map(r=>({id:r.id})))}return t}function ir(n,t){const{_nodes:e,tags:s,machine:r,children:o,context:i,can:a,hasTag:c,matches:l,getMeta:h,toJSON:d,...u}=n,p={};for(const v in o){const _=o[v];p[v]={snapshot:_.getPersistedSnapshot(t),src:_.src,systemId:_.systemId,syncSnapshot:_._syncSnapshot}}return{...u,context:Ve(i),children:p,historyValue:or(u.historyValue)}}function Ve(n){let t;for(const e in n){const s=n[e];if(s&&typeof s=="object")if("sessionId"in s&&"send"in s&&"ref"in s)t??=Array.isArray(n)?n.slice():{...n},t[e]={xstate$$type:Mt,id:s.id};else{const r=Ve(s);r!==s&&(t??=Array.isArray(n)?n.slice():{...n},t[e]=r)}}return t??n}function ar(n,t,e,s,{event:r,id:o,delay:i},{internalQueue:a}){const c=t.machine.implementations.delays;if(typeof r=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${r}" }) instead`);const l=typeof r=="function"?r(e,s):r;let h;if(typeof i=="string"){const d=c&&c[i];h=typeof d=="function"?d(e,s):d}else h=typeof i=="function"?i(e,s):i;return typeof h!="number"&&a.push(l),[t,{event:l,id:o,delay:h},void 0]}function cr(n,t){const{event:e,delay:s,id:r}=t;if(typeof s=="number"){n.defer(()=>{const o=n.self;n.system.scheduler.schedule(o,o,e,s,r)});return}}function Ht(n,t){function e(s,r){}return e.type="xstate.raise",e.event=n,e.id=t?.id,e.delay=t?.delay,e.resolve=ar,e.execute=cr,e}const de=new WeakMap;function ue(n){return{config:n,start:(e,s)=>{const{self:r,system:o,emit:i}=s,a={receivers:void 0,dispose:void 0};de.set(r,a),a.dispose=n({input:e.input,system:o,self:r,sendBack:c=>{r.getSnapshot().status!=="stopped"&&r._parent&&o._relay(r,r._parent,c)},receive:c=>{a.receivers??=new Set,a.receivers.add(c)},emit:i})},transition:(e,s,r)=>{const o=de.get(r.self);return s.type===ot?(e={...e,status:"stopped",error:void 0},o.dispose?.(),e):(o.receivers?.forEach(i=>i(s)),e)},getInitialSnapshot:(e,s)=>({status:"active",output:void 0,error:void 0,input:s}),getPersistedSnapshot:e=>e,restoreSnapshot:e=>e}}const he="xstate.promise.resolve",pe="xstate.promise.reject",ht=new WeakMap;function x(n){return{config:n,transition:(e,s,r)=>{if(e.status!=="active")return e;switch(s.type){case he:{const o=s.data;return{...e,status:"done",output:o,input:void 0}}case pe:return{...e,status:"error",error:s.data,input:void 0};case ot:return ht.get(r.self)?.abort(),{...e,status:"stopped",input:void 0};default:return e}},start:(e,{self:s,system:r,emit:o})=>{if(e.status!=="active")return;const i=new AbortController;ht.set(s,i),Promise.resolve(n({input:e.input,system:r,self:s,signal:i.signal,emit:o})).then(c=>{s.getSnapshot().status==="active"&&(ht.delete(s),r._relay(s,s,{type:he,data:c}))},c=>{s.getSnapshot().status==="active"&&(ht.delete(s),r._relay(s,s,{type:pe,data:c}))})},getInitialSnapshot:(e,s)=>({status:"active",output:void 0,error:void 0,input:s}),getPersistedSnapshot:e=>e,restoreSnapshot:e=>e}}function lr(n,{machine:t,context:e},s,r){const o=(i,a)=>{if(typeof i=="string"){const c=Lt(t,i);if(!c)throw new Error(`Actor logic '${i}' not implemented in machine '${t.id}'`);const l=T(c,{id:a?.id,parent:n.self,syncSnapshot:a?.syncSnapshot,input:typeof a?.input=="function"?a.input({context:e,event:s,self:n.self}):a?.input,src:i,systemId:a?.systemId});return r[l.id]=l,l}else return T(i,{id:a?.id,parent:n.self,syncSnapshot:a?.syncSnapshot,input:a?.input,src:i,systemId:a?.systemId})};return(i,a)=>{const c=o(i,a);return r[c.id]=c,n.defer(()=>{c._processingStatus!==I.Stopped&&c.start()}),c}}function dr(n,t,e,s,{assignment:r}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const o={},i={context:t.context,event:e.event,spawn:lr(n,t,e.event,o),self:n.self,system:n.system};let a={};if(typeof r=="function")a=r(i,s);else for(const l of Object.keys(r)){const h=r[l];a[l]=typeof h=="function"?h(i,s):h}const c=Object.assign({},t.context,a);return[B(t,{context:c,children:Object.keys(o).length?{...t.children,...o}:t.children}),void 0,void 0]}function m(n){function t(e,s){}return t.type="xstate.assign",t.assignment=n,t.resolve=dr,t}const ge=new WeakMap;function H(n,t,e){let s=ge.get(n);return s?t in s||(s[t]=e()):(s={[t]:e()},ge.set(n,s)),s[t]}const ur={},et=n=>typeof n=="string"?{type:n}:typeof n=="function"?"resolve"in n?{type:n.type}:{type:n.name}:n;class yt{constructor(t,e){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=e._parent,this.key=e._key,this.machine=e._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(ke),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?ne(this.config.states,(s,r)=>new yt(s,{_parent:this,_key:r,_machine:this.machine})):ur,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=O(this.config.entry).slice(),this.exit=O(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=O(t.tags).slice()}_initialize(){this.transitions=Us(this),this.config.always&&(this.always=V(this.config.always).map(t=>M(this,Te,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(et),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(et),eventType:null})}:void 0,history:this.history,states:ne(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(et)})),entry:this.entry.map(et),exit:this.exit.map(et),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return H(this,"invoke",()=>O(this.config.invoke).map((t,e)=>{const{src:s,systemId:r}=t,o=t.id??oe(this.id,e),i=typeof s=="string"?s:`xstate.invoke.${oe(this.id,e)}`;return{...t,src:i,id:o,systemId:r,toJSON(){const{onDone:a,onError:c,...l}=t;return{...l,type:"xstate.invoke",src:i,id:o}}}}))}get on(){return H(this,"on",()=>[...this.transitions].flatMap(([e,s])=>s.map(r=>[e,r])).reduce((e,[s,r])=>(e[s]=e[s]||[],e[s].push(r),e),{}))}get after(){return H(this,"delayedTransitions",()=>Ps(this))}get initial(){return H(this,"initial",()=>Ls(this,this.config.initial))}next(t,e){const s=e.type,r=[];let o;const i=H(this,`candidates-${s}`,()=>Ns(this,s));for(const a of i){const{guard:c}=a,l=t.context;let h=!1;try{h=!c||wt(c,l,e,t)}catch(d){const u=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${u?`'${u}' `:""}in transition for event '${s}' in state node '${this.id}':
${d.message}`)}if(h){r.push(...a.actions),o=a;break}}return o?[o]:void 0}get events(){return H(this,"events",()=>{const{states:t}=this,e=new Set(this.ownEvents);if(t)for(const s of Object.keys(t)){const r=t[s];if(r.states)for(const o of r.events)e.add(`${o}`)}return Array.from(e)})}get ownEvents(){const t=Object.keys(Object.fromEntries(this.transitions)),e=new Set(t.filter(s=>this.transitions.get(s).some(r=>!(!r.target&&!r.actions.length&&!r.reenter))));return Array.from(e)}}const hr="#";class Vt{constructor(t,e){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=t.id||"(machine)",this.implementations={actors:e?.actors??{},actions:e?.actions??{},delays:e?.delays??{},guards:e?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new yt(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:e,guards:s,actors:r,delays:o}=this.implementations;return new Vt(this.config,{actions:{...e,...t.actions},guards:{...s,...t.guards},actors:{...r,...t.actors},delays:{...o,...t.delays}})}resolveState(t){const e=Qs(this.root,t.value),s=ft(mt(this.root,e));return pt({_nodes:[...s],context:t.context||{},children:{},status:Gt(s,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,e,s){return It(t,e,s,[]).snapshot}microstep(t,e,s){return It(t,e,s,[]).microstates}getTransitionData(t,e){return qt(this.root,t.value,t,e)||[]}getPreInitialState(t,e,s){const{context:r}=this.config,o=pt({context:typeof r!="function"&&r?r:{},_nodes:[this.root],children:{},status:"active"},this);return typeof r=="function"?X(o,e,t,[m(({spawn:a,event:c,self:l})=>r({spawn:a,input:c.input,self:l}))],s,void 0):o}getInitialSnapshot(t,e){const s=Re(e),r=[],o=this.getPreInitialState(t,s,r),i=Ot([{target:[...Be(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],o,t,s,!0,r),{snapshot:a}=It(i,s,t,r);return a}start(t){Object.values(t.children).forEach(e=>{e.getSnapshot().status==="active"&&e.start()})}getStateNodeById(t){const e=Ut(t),s=e.slice(1),r=xt(e[0])?e[0].slice(hr.length):e[0],o=this.idMap.get(r);if(!o)throw new Error(`Child state node '#${r}' does not exist on machine '${this.id}'`);return vt(o,s)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,e){return ir(t,e)}restoreSnapshot(t,e){const s={},r=t.children;Object.keys(r).forEach(d=>{const u=r[d],p=u.snapshot,g=u.src,v=typeof g=="string"?Lt(this,g):g;if(!v)return;const _=T(v,{id:d,parent:e.self,syncSnapshot:u.syncSnapshot,snapshot:p,src:g,systemId:u.systemId});s[d]=_});function o(d,u){if(u instanceof yt)return u;try{return d.machine.getStateNodeById(u.id)}catch{}}function i(d,u){if(!u||typeof u!="object")return{};const p={};for(const g in u){const v=u[g];for(const _ of v){const C=o(d,_);C&&(p[g]??=[],p[g].push(C))}}return p}const a=i(this.root,t.historyValue),c=pt({...t,children:s,_nodes:Array.from(ft(mt(this.root,t.value))),historyValue:a},this),l=new Set;function h(d,u){if(!l.has(d)){l.add(d);for(const p in d){const g=d[p];if(g&&typeof g=="object"){if("xstate$$type"in g&&g.xstate$$type===Mt){d[p]=u[g.id];continue}h(g,u)}}}}return h(c.context,s),c}}function pr(n,t,e,s,{event:r}){const o=typeof r=="function"?r(e,s):r;return[t,{event:o},void 0]}function gr(n,{event:t}){n.defer(()=>n.emit(t))}function Ke(n){function t(e,s){}return t.type="xstate.emit",t.event=n,t.resolve=pr,t.execute=gr,t}let Nt=(function(n){return n.Parent="#_parent",n.Internal="#_internal",n})({});function fr(n,t,e,s,{to:r,event:o,id:i,delay:a},c){const l=t.machine.implementations.delays;if(typeof o=="string")throw new Error(`Only event objects may be used with sendTo; use sendTo({ type: "${o}" }) instead`);const h=typeof o=="function"?o(e,s):o;let d;if(typeof a=="string"){const g=l&&l[a];d=typeof g=="function"?g(e,s):g}else d=typeof a=="function"?a(e,s):a;const u=typeof r=="function"?r(e,s):r;let p;if(typeof u=="string"){if(u===Nt.Parent?p=n.self._parent:u===Nt.Internal?p=n.self:u.startsWith("#_")?p=t.children[u.slice(2)]:p=c.deferredActorIds?.includes(u)?u:t.children[u],!p)throw new Error(`Unable to send event to actor '${u}' from machine '${t.machine.id}'.`)}else p=u||n.self;return[t,{to:p,targetId:typeof u=="string"?u:void 0,event:h,id:i,delay:d},void 0]}function vr(n,t,e){typeof e.to=="string"&&(e.to=t.children[e.to])}function mr(n,t){n.defer(()=>{const{to:e,event:s,delay:r,id:o}=t;if(typeof r=="number"){n.system.scheduler.schedule(n.self,e,s,r,o);return}n.system._relay(n.self,e,s.type===ms?De(n.self.id,s.data):s)})}function Kt(n,t,e){function s(r,o){}return s.type="xstate.sendTo",s.to=n,s.event=t,s.id=e?.id,s.delay=e?.delay,s.resolve=fr,s.retryResolve=vr,s.execute=mr,s}function yr(n,t){return Kt(Nt.Parent,n,t)}function br(n,t,e,s,{collect:r}){const o=[],i=function(c){o.push(c)};return i.assign=(...a)=>{o.push(m(...a))},i.cancel=(...a)=>{o.push(zt(...a))},i.raise=(...a)=>{o.push(Ht(...a))},i.sendTo=(...a)=>{o.push(Kt(...a))},i.sendParent=(...a)=>{o.push(yr(...a))},i.spawnChild=(...a)=>{o.push(jt(...a))},i.stopChild=(...a)=>{o.push(_t(...a))},i.emit=(...a)=>{o.push(Ke(...a))},r({context:e.context,event:e.event,enqueue:i,check:a=>wt(a,t.context,e.event,t),self:n.self,system:n.system},s),[t,void 0,o]}function _r(n){function t(e,s){}return t.type="xstate.enqueueActions",t.collect=n,t.resolve=br,t}function wr(n,t,e,s,{value:r,label:o}){return[t,{value:typeof r=="function"?r(e,s):r,label:o},void 0]}function xr({logger:n},{value:t,label:e}){e?n(e,t):n(t)}function Sr(n=({context:e,event:s})=>({context:e,event:s}),t){function e(s,r){}return e.type="xstate.log",e.value=n,e.label=t,e.resolve=wr,e.execute=xr,e}function Er(n,t){return new Vt(n,t)}function P({schemas:n,actors:t,actions:e,guards:s,delays:r}){return{assign:m,sendTo:Kt,raise:Ht,log:Sr,cancel:zt,stopChild:_t,enqueueActions:_r,emit:Ke,spawnChild:jt,createStateConfig:o=>o,createAction:o=>o,createMachine:o=>Er({...o,schemas:n},{actors:t,actions:e,guards:s,delays:r}),extend:o=>P({schemas:n,actors:t,actions:{...e,...o.actions},guards:{...s,...o.guards},delays:{...r,...o.delays}})}}let rt=null;function Ar(n){rt=n}const Cr=P({actors:{mountFeatures:x(async({input:n})=>{const t=rt||n;if(console.log("mountFeatures - using context:",t),!t||!t.actorRegistry)throw new Error("Missing required context: actorRegistry");return await k.mountAll(t),{success:!0}}),unmountFeatures:x(async()=>(await k.unmountAll(),{success:!0})),detectStartupType:x(async()=>{const n=localStorage.getItem("session")!==null,t=navigator.onLine;return n?t?"warm":"offline":"cold"}),loadSettings:x(async()=>{const n=localStorage.getItem("settings");return n?JSON.parse(n):{}})}}).createMachine({id:"app",initial:"booting",context:{features:[],mountedFeatures:new Set,startupType:"cold",settings:{}},states:{booting:{initial:"detecting",states:{detecting:{invoke:{src:"detectStartupType",onDone:{target:"loadingSettings",actions:m({startupType:({event:n})=>n.output})}}},loadingSettings:{invoke:{src:"loadSettings",onDone:{target:"mounting",actions:m({settings:({event:n})=>n.output})}}},mounting:{invoke:{src:"mountFeatures",input:({self:n})=>(rt&&(rt.appActor=n),rt||{}),onDone:{target:"#app.ready",actions:m({mountedFeatures:()=>new Set(k.getAll().map(n=>n.id))})},onError:{target:"#app.error",actions:({event:n})=>{console.error("Mounting failed:",n.error)}}}}}},ready:{on:{LOGOUT:{target:"shuttingDown"},ERROR_CRITICAL:{target:"error"}}},shuttingDown:{invoke:{src:"unmountFeatures",onDone:{target:"terminated"}}},error:{on:{RETRY:{target:"booting"}}},terminated:{type:"final"}}});class Ir{constructor(){this.db=null,this.dbName="ChatAppDB",this.dbVersion=2,this.writeQueue=[],this.flushTimer=null,this.flushInterval=100,this.maxBatchSize=50}async init(){return new Promise((t,e)=>{const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>{e(new Error("Failed to open IndexedDB"))},s.onsuccess=()=>{this.db=s.result,console.log("ðŸ“¦ IndexedDB opened:",this.dbName),t()},s.onupgradeneeded=r=>{const o=r.target.result;this.createStores(o)}})}createStores(t){if(t.objectStoreNames.contains("data")||t.createObjectStore("data",{keyPath:"key"}),!t.objectStoreNames.contains("messages")){const e=t.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});e.createIndex("contactId","contactId",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains("contacts")||t.createObjectStore("contacts",{keyPath:"id"}),t.objectStoreNames.contains("users")||t.createObjectStore("users",{keyPath:"username"}).createIndex("createdAt","createdAt",{unique:!1}),console.log("ðŸ“¦ Stores created")}async get(t,e="data"){return new Promise((s,r)=>{const a=this.db.transaction([e],"readonly").objectStore(e).get(t);a.onsuccess=()=>{s(a.result?.value||null)},a.onerror=()=>{r(new Error(`Failed to get ${t}`))}})}async set(t,e,s="data"){return new Promise((r,o)=>{this.writeQueue.push({key:t,value:e,storeName:s,resolve:r,reject:o}),this.writeQueue.length>=this.maxBatchSize?this.flush():this.scheduleFlush()})}async delete(t,e="data"){return new Promise((s,r)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).delete(t);a.onsuccess=()=>s(),a.onerror=()=>r(new Error(`Failed to delete ${t}`))})}async getAll(t="data"){return new Promise((e,s)=>{const i=this.db.transaction([t],"readonly").objectStore(t).getAll();i.onsuccess=()=>{e(i.result)},i.onerror=()=>{s(new Error("Failed to getAll"))}})}scheduleFlush(){this.flushTimer||(this.flushTimer=setTimeout(()=>{this.flush()},this.flushInterval))}async flush(){if(this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.writeQueue.length===0)return;const t=this.writeQueue.splice(0);try{const e={};for(const s of t)e[s.storeName]||(e[s.storeName]=[]),e[s.storeName].push(s);for(const[s,r]of Object.entries(e))await this.writeBatch(s,r)}catch(e){console.error("Batch write failed:",e);for(const s of t)try{await this.writeSingle(s.storeName,s.key,s.value),s.resolve()}catch(r){s.reject(r)}}}async writeBatch(t,e){return new Promise((s,r)=>{const o=this.db.transaction([t],"readwrite"),i=o.objectStore(t),a=e.map(({key:c,value:l,resolve:h,reject:d})=>new Promise((u,p)=>{const g=i.put({key:c,value:l});g.onsuccess=()=>{h(),u()},g.onerror=()=>{d(g.error),p(g.error)}}));o.oncomplete=()=>s(),o.onerror=()=>r(o.error),Promise.all(a).catch(r)})}async writeSingle(t,e,s){return new Promise((r,o)=>{const c=this.db.transaction([t],"readwrite").objectStore(t).put({key:e,value:s});c.onsuccess=()=>r(),c.onerror=()=>o(c.error)})}async saveMessage(t){return new Promise((e,s)=>{const i=this.db.transaction(["messages"],"readwrite").objectStore("messages").add(t);i.onsuccess=()=>e(i.result),i.onerror=()=>s(i.error)})}async getMessages(t,e=50){return new Promise((s,r)=>{const c=this.db.transaction(["messages"],"readonly").objectStore("messages").index("contactId").getAll(t);c.onsuccess=()=>{const l=c.result;l.sort((h,d)=>d.timestamp-h.timestamp),s(l.slice(0,e))},c.onerror=()=>r(c.error)})}async saveContact(t){return new Promise((e,s)=>{const i=this.db.transaction(["contacts"],"readwrite").objectStore("contacts").put(t);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)})}async getContacts(){return this.getAll("contacts")}async close(){await this.flush(),this.db&&(this.db.close(),this.db=null)}async clear(t="data"){return new Promise((e,s)=>{const i=this.db.transaction([t],"readwrite").objectStore(t).clear();i.onsuccess=()=>e(),i.onerror=()=>s(i.error)})}async clearAll(){await this.clear("data"),await this.clear("messages"),await this.clear("contacts")}async getUser(t){return new Promise((e,s)=>{const i=this.db.transaction(["users"],"readonly").objectStore("users").get(t);i.onsuccess=()=>e(i.result||null),i.onerror=()=>s(i.error)})}async saveUser(t){return new Promise((e,s)=>{const r=this.db.transaction(["users"],"readwrite"),i=r.objectStore("users").put(t);r.oncomplete=()=>{console.log("ðŸ’¾ Transaction commited for user:",t.username),e()},r.onerror=()=>s(r.error),i.onerror=()=>s(i.error)})}async deleteUser(t){return new Promise((e,s)=>{const i=this.db.transaction(["users"],"readwrite").objectStore("users").delete(t);i.onsuccess=()=>e(),i.onerror=()=>s(i.error)})}async getAllUsers(){return new Promise((t,e)=>{const o=this.db.transaction(["users"],"readonly").objectStore("users").getAll();o.onsuccess=()=>t(o.result),o.onerror=()=>e(o.error)})}async userExists(t){return await this.getUser(t)!==null}}const kr={id:"persistence",name:"Persistence",version:"1.0.0",dependencies:[],ui:{diagnostics:"persistence-diagnostics"},async onMount(n){console.log("ðŸ’¾ Mounting Persistence feature...");const t=new Ir;return await t.init(),console.log("âœ… Persistence ready"),{service:t}},async onUnmount(n){const{service:t}=n;t&&await t.close(),console.log("ðŸ’¾ Persistence unmounted")},subscribedEvents:[],emittedEvents:["STORAGE_ERROR","STORAGE_QUOTA_EXCEEDED"]};function Tr({repo:n,crypto:t}){return P({actors:{loadIdentity:x(async({input:e})=>{console.log("ðŸ” loadIdentity: Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸...");const s=await e.repo.load();if(console.log("ðŸ” loadIdentity: Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:",s),!s)throw new Error("Identity not found");return s}),generateIdentity:x(async({input:e})=>{console.log("ðŸ” generateIdentity: Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð¹ identity...");const s=await e.crypto.generateIdentity();console.log("ðŸ” generateIdentity: ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾, userId:",s.userId?.slice(0,16)+"...");const r={version:2,userId:s.userId,identity:s.identity,exchange:s.exchange,createdAt:Date.now()};return await e.repo.save(r),console.log("ðŸ” generateIdentity: ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð² Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ"),r})},actions:{assignIdentity:m(({event:e})=>{const s=e.output;return{userId:s.userId,identity:s.identity,exchange:s.exchange,version:s.version,createdAt:s.createdAt,error:null}}),assignError:m({error:({event:e})=>e.error?.message||"Unknown error"}),logReady:({context:e})=>{console.log("âœ… Identity ready! userId:",e.userId?.slice(0,16)+"...")},logError:({context:e})=>{console.error("âŒ Identity error:",e.error)}}}).createMachine({id:"identity",initial:"loading",context:{repo:n,crypto:t,userId:null,identity:null,exchange:null,version:null,createdAt:null,error:null},states:{loading:{invoke:{src:"loadIdentity",input:({context:e})=>({repo:e.repo}),onDone:{target:"ready",actions:"assignIdentity"},onError:{target:"generating"}}},generating:{invoke:{src:"generateIdentity",input:({context:e})=>({repo:e.repo,crypto:e.crypto}),onDone:{target:"ready",actions:"assignIdentity"},onError:{target:"error",actions:"assignError"}}},ready:{entry:"logReady",on:{REGENERATE:"generating"}},error:{entry:"logError",on:{RETRY:"loading"}}}})}class $r{constructor(t="/workers/crypto.worker.js"){this.workerUrl=t,this.worker=null,this.pending=new Map,this.requestId=0}async init(){this.worker||(this.worker=new Worker(new URL(this.workerUrl,window.location.origin)),this.worker.onmessage=t=>{const{requestId:e,result:s,error:r}=t.data,o=this.pending.get(e);o&&(r?o.reject(new Error(r)):o.resolve(s),this.pending.delete(e))},this.worker.onerror=t=>{console.error("[CryptoService] Worker error:",t);for(const{reject:e}of this.pending.values())e(new Error("CryptoWorker crashed"));this.pending.clear()})}async request(t,e={}){await this.init();const s=this.requestId++;return new Promise((r,o)=>{this.pending.set(s,{resolve:r,reject:o}),this.worker.postMessage({requestId:s,method:t,params:e}),setTimeout(()=>{this.pending.has(s)&&(this.pending.delete(s),o(new Error(`Crypto timeout: ${t}`)))},3e4)})}generateIdentity(){return this.request("generateIdentity")}encrypt(t,e){return this.request("encrypt",{plaintext:t,recipientExchangePublicKey:e})}decrypt(t,e){const s=t.senderEphemeralPublicKey||t.ephemeralPublicKey;return s?e?this.request("decrypt",{ciphertext:t.ciphertext,iv:t.iv,senderEphemeralPublicKey:s,myExchangePrivateKey:e}):Promise.reject(new Error("Missing private key for decryption")):Promise.reject(new Error("Missing ephemeral public key in encrypted data"))}async destroy(){this.worker&&(this.worker.terminate(),this.worker=null)}}class Dr{constructor(t){this.storage=t,this.KEY="identity"}async load(){return this.storage.get(this.KEY)}async save(t){await this.storage.set(this.KEY,t)}async clear(){await this.storage.remove(this.KEY)}}const Rr={id:"identity",name:"Identity",dependencies:["persistence"],ui:{diagnostics:"identity-diagnostics"},async onMount(n){const t=n.featureRegistry.getMountResult("persistence");if(!t?.service)throw new Error("Persistence not mounted or service not exposed");const e=new Dr(t.service),s=new $r("/workers/crypto.worker.js");await s.init(),console.log("ðŸ” Crypto worker initialized");const r=Tr({repo:e,crypto:s}),o=T(r,{inspect:i=>{i.type==="@xstate.snapshot"&&console.log("ðŸ“ Identity state:",i.snapshot.value)}});return o.start(),{actor:o,crypto:s,repo:e,waitForReady:()=>new Promise((i,a)=>{(()=>{const h=o.getSnapshot();h.matches("ready")?i(h.context):h.matches("error")&&a(new Error(h.context.error))})();const l=o.subscribe(h=>{h.matches("ready")?(l.unsubscribe(),i(h.context)):h.matches("error")&&(l.unsubscribe(),a(new Error(h.context.error)))})})}}};function Or({authService:n,authRepo:t,cryptoService:e}){return P({actors:{registerUser:x(async({input:s})=>{const{username:r,password:o,authService:i,authRepo:a,cryptoService:c}=s;console.log("ðŸ“ Registering user:",r);const l=i.validateUsername(r);if(!l.valid)throw new Error(l.error);const h=i.validatePassword(o);if(!h.valid)throw new Error(h.error);if(await a.userExists(r))throw new Error("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚");const{hash:d,salt:u}=await i.hashPassword(o),p={username:r,passwordHash:d,salt:u,createdAt:Date.now()};await a.createUser(p);const g=await c.generateIdentity(),v=await i.encryptUserData(g,o,u);return await a.saveUserData(r,"identity",v),console.log("âœ… User registered:",r),{username:r,identity:g,salt:u}}),loginUser:x(async({input:s})=>{const{username:r,password:o,authService:i,authRepo:a}=s;console.log("ðŸ” Logging in:",r);const c=await a.getUser(r);if(!c)throw new Error("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ");if(!await i.verifyPassword(o,c.passwordHash,c.salt))throw new Error("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ");const h=await a.getUserData(r,"identity");if(!h)throw new Error("Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾Ð²Ñ€ÐµÐ¶Ð´ÐµÐ½Ñ‹");const d=await i.decryptUserData(h,o,c.salt);return console.log("âœ… Logged in:",r),{username:r,identity:d,salt:c.salt}}),deleteAccount:x(async({input:s})=>{const{username:r,authRepo:o}=s;return console.log("ðŸ—‘ï¸ Deleting account:",r),await o.deleteUser(r),console.log("âœ… Account deleted:",r),{success:!0}}),loadUsers:x(async({input:s})=>{const{authRepo:r}=s;return r.getAllUsernames()})},actions:{assignUser:m(({event:s})=>({username:s.output.username,identity:s.output.identity,salt:s.output.salt,error:null})),assignError:m({error:({event:s})=>s.error?.message||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°"}),clearError:m({error:null}),clearUser:m({username:null,identity:null,salt:null,password:null}),assignUsers:m({availableUsers:({event:s})=>s.output}),logAuthenticated:({context:s})=>{console.log("ðŸŽ‰ Authenticated as:",s.username)},logLogout:({context:s})=>{console.log("ðŸ‘‹ Logged out:",s.username)}},guards:{hasUsers:({context:s})=>s.availableUsers?.length>0}}).createMachine({id:"auth",initial:"initializing",context:{authService:n,authRepo:t,cryptoService:e,username:null,identity:null,salt:null,error:null,availableUsers:[]},states:{initializing:{invoke:{src:"loadUsers",input:({context:s})=>({authRepo:s.authRepo}),onDone:{target:"guest",actions:"assignUsers"},onError:{target:"guest"}}},guest:{entry:"clearUser",on:{LOGIN:{target:"loggingIn",actions:"clearError"},REGISTER:{target:"registering",actions:"clearError"}}},registering:{invoke:{src:"registerUser",input:({context:s,event:r})=>({username:r.username,password:r.password,authService:s.authService,authRepo:s.authRepo,cryptoService:s.cryptoService}),onDone:{target:"authenticated",actions:"assignUser"},onError:{target:"guest",actions:"assignError"}}},loggingIn:{invoke:{src:"loginUser",input:({context:s,event:r})=>({username:r.username,password:r.password,authService:s.authService,authRepo:s.authRepo}),onDone:{target:"authenticated",actions:"assignUser"},onError:{target:"guest",actions:"assignError"}}},authenticated:{entry:"logAuthenticated",on:{LOGOUT:{target:"guest",actions:"logLogout"},DELETE_ACCOUNT:{target:"deletingAccount"}}},deletingAccount:{invoke:{src:"deleteAccount",input:({context:s})=>({username:s.username,authRepo:s.authRepo}),onDone:{target:"initializing",actions:["clearUser","logLogout"]},onError:{target:"authenticated",actions:"assignError"}}}}})}class Nr{constructor(t){this.crypto=t}async hashPassword(t){const e=await this.crypto.request("deriveKeyFromPassword",{password:t,salt:null,usage:"verification"});return{hash:e.keyHash,salt:e.salt}}async verifyPassword(t,e,s){return(await this.crypto.request("deriveKeyFromPassword",{password:t,salt:s,usage:"verification"})).keyHash===e}async encryptUserData(t,e,s){return this.crypto.request("encryptWithPassword",{data:t,password:e,salt:s})}async decryptUserData(t,e,s){return this.crypto.request("decryptWithPassword",{encryptedData:t,password:e,salt:s})}validateUsername(t){return!t||t.length<2?{valid:!1,error:"ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 2 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°"}:t.length>32?{valid:!1,error:"ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 32 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°"}:/^[a-zA-Z0-9_Ð°-ÑÐ-Ð¯Ñ‘Ð]+$/.test(t)?{valid:!0}:{valid:!1,error:"Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð±ÑƒÐºÐ²Ñ‹, Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð¸ _"}}validatePassword(t){return!t||t.length<4?{valid:!1,error:"ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 4 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°"}:t.length>128?{valid:!1,error:"ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 128 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"}:{valid:!0}}}class Pr{constructor(t){this.storage=t}async getUser(t){return this.storage.getUser(t)}async userExists(t){return this.storage.userExists(t)}async createUser(t){if(await this.userExists(t.username))throw new Error("USER_EXISTS");return await this.storage.saveUser(t),t}async updateUser(t,e){const s=await this.getUser(t);if(!s)throw new Error("USER_NOT_FOUND");const r={...s,...e,updatedAt:Date.now()};return await this.storage.saveUser(r),r}async saveUserData(t,e,s){const r=`${t}:${e}`;await this.storage.set(r,s)}async getUserData(t,e){const s=`${t}:${e}`;return this.storage.get(s)}async deleteUser(t){await this.storage.deleteUser(t);const e=await this.storage.getAll("data"),s=`${t}:`;for(const r of e)r.key.startsWith(s)&&await this.storage.delete(r.key)}async getAllUsernames(){return(await this.storage.getAllUsers()).map(e=>({username:e.username,createdAt:e.createdAt}))}}const gt=globalThis,Wt=gt.ShadowRoot&&(gt.ShadyCSS===void 0||gt.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Yt=Symbol(),fe=new WeakMap;let We=class{constructor(t,e,s){if(this._$cssResult$=!0,s!==Yt)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=t,this.t=e}get styleSheet(){let t=this.o;const e=this.t;if(Wt&&t===void 0){const s=e!==void 0&&e.length===1;s&&(t=fe.get(e)),t===void 0&&((this.o=t=new CSSStyleSheet).replaceSync(this.cssText),s&&fe.set(e,t))}return t}toString(){return this.cssText}};const Ur=n=>new We(typeof n=="string"?n:n+"",void 0,Yt),b=(n,...t)=>{const e=n.length===1?n[0]:t.reduce((s,r,o)=>s+(i=>{if(i._$cssResult$===!0)return i.cssText;if(typeof i=="number")return i;throw Error("Value passed to 'css' function must be a 'css' function result: "+i+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(r)+n[o+1],n[0]);return new We(e,n,Yt)},Lr=(n,t)=>{if(Wt)n.adoptedStyleSheets=t.map(e=>e instanceof CSSStyleSheet?e:e.styleSheet);else for(const e of t){const s=document.createElement("style"),r=gt.litNonce;r!==void 0&&s.setAttribute("nonce",r),s.textContent=e.cssText,n.appendChild(s)}},ve=Wt?n=>n:n=>n instanceof CSSStyleSheet?(t=>{let e="";for(const s of t.cssRules)e+=s.cssText;return Ur(e)})(n):n;const{is:Mr,defineProperty:zr,getOwnPropertyDescriptor:jr,getOwnPropertyNames:Br,getOwnPropertySymbols:Gr,getPrototypeOf:qr}=Object,St=globalThis,me=St.trustedTypes,Fr=me?me.emptyScript:"",Hr=St.reactiveElementPolyfillSupport,nt=(n,t)=>n,Pt={toAttribute(n,t){switch(t){case Boolean:n=n?Fr:null;break;case Object:case Array:n=n==null?n:JSON.stringify(n)}return n},fromAttribute(n,t){let e=n;switch(t){case Boolean:e=n!==null;break;case Number:e=n===null?null:Number(n);break;case Object:case Array:try{e=JSON.parse(n)}catch{e=null}}return e}},Ye=(n,t)=>!Mr(n,t),ye={attribute:!0,type:String,converter:Pt,reflect:!1,useDefault:!1,hasChanged:Ye};Symbol.metadata??=Symbol("metadata"),St.litPropertyMetadata??=new WeakMap;let K=class extends HTMLElement{static addInitializer(t){this._$Ei(),(this.l??=[]).push(t)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(t,e=ye){if(e.state&&(e.attribute=!1),this._$Ei(),this.prototype.hasOwnProperty(t)&&((e=Object.create(e)).wrapped=!0),this.elementProperties.set(t,e),!e.noAccessor){const s=Symbol(),r=this.getPropertyDescriptor(t,s,e);r!==void 0&&zr(this.prototype,t,r)}}static getPropertyDescriptor(t,e,s){const{get:r,set:o}=jr(this.prototype,t)??{get(){return this[e]},set(i){this[e]=i}};return{get:r,set(i){const a=r?.call(this);o?.call(this,i),this.requestUpdate(t,a,s)},configurable:!0,enumerable:!0}}static getPropertyOptions(t){return this.elementProperties.get(t)??ye}static _$Ei(){if(this.hasOwnProperty(nt("elementProperties")))return;const t=qr(this);t.finalize(),t.l!==void 0&&(this.l=[...t.l]),this.elementProperties=new Map(t.elementProperties)}static finalize(){if(this.hasOwnProperty(nt("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(nt("properties"))){const e=this.properties,s=[...Br(e),...Gr(e)];for(const r of s)this.createProperty(r,e[r])}const t=this[Symbol.metadata];if(t!==null){const e=litPropertyMetadata.get(t);if(e!==void 0)for(const[s,r]of e)this.elementProperties.set(s,r)}this._$Eh=new Map;for(const[e,s]of this.elementProperties){const r=this._$Eu(e,s);r!==void 0&&this._$Eh.set(r,e)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(t){const e=[];if(Array.isArray(t)){const s=new Set(t.flat(1/0).reverse());for(const r of s)e.unshift(ve(r))}else t!==void 0&&e.push(ve(t));return e}static _$Eu(t,e){const s=e.attribute;return s===!1?void 0:typeof s=="string"?s:typeof t=="string"?t.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise(t=>this.enableUpdating=t),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach(t=>t(this))}addController(t){(this._$EO??=new Set).add(t),this.renderRoot!==void 0&&this.isConnected&&t.hostConnected?.()}removeController(t){this._$EO?.delete(t)}_$E_(){const t=new Map,e=this.constructor.elementProperties;for(const s of e.keys())this.hasOwnProperty(s)&&(t.set(s,this[s]),delete this[s]);t.size>0&&(this._$Ep=t)}createRenderRoot(){const t=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return Lr(t,this.constructor.elementStyles),t}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach(t=>t.hostConnected?.())}enableUpdating(t){}disconnectedCallback(){this._$EO?.forEach(t=>t.hostDisconnected?.())}attributeChangedCallback(t,e,s){this._$AK(t,s)}_$ET(t,e){const s=this.constructor.elementProperties.get(t),r=this.constructor._$Eu(t,s);if(r!==void 0&&s.reflect===!0){const o=(s.converter?.toAttribute!==void 0?s.converter:Pt).toAttribute(e,s.type);this._$Em=t,o==null?this.removeAttribute(r):this.setAttribute(r,o),this._$Em=null}}_$AK(t,e){const s=this.constructor,r=s._$Eh.get(t);if(r!==void 0&&this._$Em!==r){const o=s.getPropertyOptions(r),i=typeof o.converter=="function"?{fromAttribute:o.converter}:o.converter?.fromAttribute!==void 0?o.converter:Pt;this._$Em=r;const a=i.fromAttribute(e,o.type);this[r]=a??this._$Ej?.get(r)??a,this._$Em=null}}requestUpdate(t,e,s,r=!1,o){if(t!==void 0){const i=this.constructor;if(r===!1&&(o=this[t]),s??=i.getPropertyOptions(t),!((s.hasChanged??Ye)(o,e)||s.useDefault&&s.reflect&&o===this._$Ej?.get(t)&&!this.hasAttribute(i._$Eu(t,s))))return;this.C(t,e,s)}this.isUpdatePending===!1&&(this._$ES=this._$EP())}C(t,e,{useDefault:s,reflect:r,wrapped:o},i){s&&!(this._$Ej??=new Map).has(t)&&(this._$Ej.set(t,i??e??this[t]),o!==!0||i!==void 0)||(this._$AL.has(t)||(this.hasUpdated||s||(e=void 0),this._$AL.set(t,e)),r===!0&&this._$Em!==t&&(this._$Eq??=new Set).add(t))}async _$EP(){this.isUpdatePending=!0;try{await this._$ES}catch(e){Promise.reject(e)}const t=this.scheduleUpdate();return t!=null&&await t,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[r,o]of this._$Ep)this[r]=o;this._$Ep=void 0}const s=this.constructor.elementProperties;if(s.size>0)for(const[r,o]of s){const{wrapped:i}=o,a=this[r];i!==!0||this._$AL.has(r)||a===void 0||this.C(r,void 0,o,a)}}let t=!1;const e=this._$AL;try{t=this.shouldUpdate(e),t?(this.willUpdate(e),this._$EO?.forEach(s=>s.hostUpdate?.()),this.update(e)):this._$EM()}catch(s){throw t=!1,this._$EM(),s}t&&this._$AE(e)}willUpdate(t){}_$AE(t){this._$EO?.forEach(e=>e.hostUpdated?.()),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(t)),this.updated(t)}_$EM(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(t){return!0}update(t){this._$Eq&&=this._$Eq.forEach(e=>this._$ET(e,this[e])),this._$EM()}updated(t){}firstUpdated(t){}};K.elementStyles=[],K.shadowRootOptions={mode:"open"},K[nt("elementProperties")]=new Map,K[nt("finalized")]=new Map,Hr?.({ReactiveElement:K}),(St.reactiveElementVersions??=[]).push("2.1.2");const Jt=globalThis,be=n=>n,bt=Jt.trustedTypes,_e=bt?bt.createPolicy("lit-html",{createHTML:n=>n}):void 0,Je="$lit$",R=`lit$${Math.random().toFixed(9).slice(2)}$`,Xe="?"+R,Vr=`<${Xe}>`,G=document,it=()=>G.createComment(""),at=n=>n===null||typeof n!="object"&&typeof n!="function",Xt=Array.isArray,Kr=n=>Xt(n)||typeof n?.[Symbol.iterator]=="function",kt=`[ 	
\f\r]`,st=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,we=/-->/g,xe=/>/g,U=RegExp(`>|${kt}(?:([^\\s"'>=/]+)(${kt}*=${kt}*(?:[^ 	
\f\r"'\`<>=]|("|')|))|$)`,"g"),Se=/'/g,Ee=/"/g,Qe=/^(?:script|style|textarea|title)$/i,Wr=n=>(t,...e)=>({_$litType$:n,strings:t,values:e}),f=Wr(1),Q=Symbol.for("lit-noChange"),E=Symbol.for("lit-nothing"),Ae=new WeakMap,j=G.createTreeWalker(G,129);function Ze(n,t){if(!Xt(n)||!n.hasOwnProperty("raw"))throw Error("invalid template strings array");return _e!==void 0?_e.createHTML(t):t}const Yr=(n,t)=>{const e=n.length-1,s=[];let r,o=t===2?"<svg>":t===3?"<math>":"",i=st;for(let a=0;a<e;a++){const c=n[a];let l,h,d=-1,u=0;for(;u<c.length&&(i.lastIndex=u,h=i.exec(c),h!==null);)u=i.lastIndex,i===st?h[1]==="!--"?i=we:h[1]!==void 0?i=xe:h[2]!==void 0?(Qe.test(h[2])&&(r=RegExp("</"+h[2],"g")),i=U):h[3]!==void 0&&(i=U):i===U?h[0]===">"?(i=r??st,d=-1):h[1]===void 0?d=-2:(d=i.lastIndex-h[2].length,l=h[1],i=h[3]===void 0?U:h[3]==='"'?Ee:Se):i===Ee||i===Se?i=U:i===we||i===xe?i=st:(i=U,r=void 0);const p=i===U&&n[a+1].startsWith("/>")?" ":"";o+=i===st?c+Vr:d>=0?(s.push(l),c.slice(0,d)+Je+c.slice(d)+R+p):c+R+(d===-2?a:p)}return[Ze(n,o+(n[e]||"<?>")+(t===2?"</svg>":t===3?"</math>":"")),s]};class ct{constructor({strings:t,_$litType$:e},s){let r;this.parts=[];let o=0,i=0;const a=t.length-1,c=this.parts,[l,h]=Yr(t,e);if(this.el=ct.createElement(l,s),j.currentNode=this.el.content,e===2||e===3){const d=this.el.content.firstChild;d.replaceWith(...d.childNodes)}for(;(r=j.nextNode())!==null&&c.length<a;){if(r.nodeType===1){if(r.hasAttributes())for(const d of r.getAttributeNames())if(d.endsWith(Je)){const u=h[i++],p=r.getAttribute(d).split(R),g=/([.?@])?(.*)/.exec(u);c.push({type:1,index:o,name:g[2],strings:p,ctor:g[1]==="."?Xr:g[1]==="?"?Qr:g[1]==="@"?Zr:Et}),r.removeAttribute(d)}else d.startsWith(R)&&(c.push({type:6,index:o}),r.removeAttribute(d));if(Qe.test(r.tagName)){const d=r.textContent.split(R),u=d.length-1;if(u>0){r.textContent=bt?bt.emptyScript:"";for(let p=0;p<u;p++)r.append(d[p],it()),j.nextNode(),c.push({type:2,index:++o});r.append(d[u],it())}}}else if(r.nodeType===8)if(r.data===Xe)c.push({type:2,index:o});else{let d=-1;for(;(d=r.data.indexOf(R,d+1))!==-1;)c.push({type:7,index:o}),d+=R.length-1}o++}}static createElement(t,e){const s=G.createElement("template");return s.innerHTML=t,s}}function Z(n,t,e=n,s){if(t===Q)return t;let r=s!==void 0?e._$Co?.[s]:e._$Cl;const o=at(t)?void 0:t._$litDirective$;return r?.constructor!==o&&(r?._$AO?.(!1),o===void 0?r=void 0:(r=new o(n),r._$AT(n,e,s)),s!==void 0?(e._$Co??=[])[s]=r:e._$Cl=r),r!==void 0&&(t=Z(n,r._$AS(n,t.values),r,s)),t}class Jr{constructor(t,e){this._$AV=[],this._$AN=void 0,this._$AD=t,this._$AM=e}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(t){const{el:{content:e},parts:s}=this._$AD,r=(t?.creationScope??G).importNode(e,!0);j.currentNode=r;let o=j.nextNode(),i=0,a=0,c=s[0];for(;c!==void 0;){if(i===c.index){let l;c.type===2?l=new dt(o,o.nextSibling,this,t):c.type===1?l=new c.ctor(o,c.name,c.strings,this,t):c.type===6&&(l=new tn(o,this,t)),this._$AV.push(l),c=s[++a]}i!==c?.index&&(o=j.nextNode(),i++)}return j.currentNode=G,r}p(t){let e=0;for(const s of this._$AV)s!==void 0&&(s.strings!==void 0?(s._$AI(t,s,e),e+=s.strings.length-2):s._$AI(t[e])),e++}}class dt{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(t,e,s,r){this.type=2,this._$AH=E,this._$AN=void 0,this._$AA=t,this._$AB=e,this._$AM=s,this.options=r,this._$Cv=r?.isConnected??!0}get parentNode(){let t=this._$AA.parentNode;const e=this._$AM;return e!==void 0&&t?.nodeType===11&&(t=e.parentNode),t}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(t,e=this){t=Z(this,t,e),at(t)?t===E||t==null||t===""?(this._$AH!==E&&this._$AR(),this._$AH=E):t!==this._$AH&&t!==Q&&this._(t):t._$litType$!==void 0?this.$(t):t.nodeType!==void 0?this.T(t):Kr(t)?this.k(t):this._(t)}O(t){return this._$AA.parentNode.insertBefore(t,this._$AB)}T(t){this._$AH!==t&&(this._$AR(),this._$AH=this.O(t))}_(t){this._$AH!==E&&at(this._$AH)?this._$AA.nextSibling.data=t:this.T(G.createTextNode(t)),this._$AH=t}$(t){const{values:e,_$litType$:s}=t,r=typeof s=="number"?this._$AC(t):(s.el===void 0&&(s.el=ct.createElement(Ze(s.h,s.h[0]),this.options)),s);if(this._$AH?._$AD===r)this._$AH.p(e);else{const o=new Jr(r,this),i=o.u(this.options);o.p(e),this.T(i),this._$AH=o}}_$AC(t){let e=Ae.get(t.strings);return e===void 0&&Ae.set(t.strings,e=new ct(t)),e}k(t){Xt(this._$AH)||(this._$AH=[],this._$AR());const e=this._$AH;let s,r=0;for(const o of t)r===e.length?e.push(s=new dt(this.O(it()),this.O(it()),this,this.options)):s=e[r],s._$AI(o),r++;r<e.length&&(this._$AR(s&&s._$AB.nextSibling,r),e.length=r)}_$AR(t=this._$AA.nextSibling,e){for(this._$AP?.(!1,!0,e);t!==this._$AB;){const s=be(t).nextSibling;be(t).remove(),t=s}}setConnected(t){this._$AM===void 0&&(this._$Cv=t,this._$AP?.(t))}}class Et{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(t,e,s,r,o){this.type=1,this._$AH=E,this._$AN=void 0,this.element=t,this.name=e,this._$AM=r,this.options=o,s.length>2||s[0]!==""||s[1]!==""?(this._$AH=Array(s.length-1).fill(new String),this.strings=s):this._$AH=E}_$AI(t,e=this,s,r){const o=this.strings;let i=!1;if(o===void 0)t=Z(this,t,e,0),i=!at(t)||t!==this._$AH&&t!==Q,i&&(this._$AH=t);else{const a=t;let c,l;for(t=o[0],c=0;c<o.length-1;c++)l=Z(this,a[s+c],e,c),l===Q&&(l=this._$AH[c]),i||=!at(l)||l!==this._$AH[c],l===E?t=E:t!==E&&(t+=(l??"")+o[c+1]),this._$AH[c]=l}i&&!r&&this.j(t)}j(t){t===E?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,t??"")}}class Xr extends Et{constructor(){super(...arguments),this.type=3}j(t){this.element[this.name]=t===E?void 0:t}}class Qr extends Et{constructor(){super(...arguments),this.type=4}j(t){this.element.toggleAttribute(this.name,!!t&&t!==E)}}class Zr extends Et{constructor(t,e,s,r,o){super(t,e,s,r,o),this.type=5}_$AI(t,e=this){if((t=Z(this,t,e,0)??E)===Q)return;const s=this._$AH,r=t===E&&s!==E||t.capture!==s.capture||t.once!==s.once||t.passive!==s.passive,o=t!==E&&(s===E||r);r&&this.element.removeEventListener(this.name,this,s),o&&this.element.addEventListener(this.name,this,t),this._$AH=t}handleEvent(t){typeof this._$AH=="function"?this._$AH.call(this.options?.host??this.element,t):this._$AH.handleEvent(t)}}class tn{constructor(t,e,s){this.element=t,this.type=6,this._$AN=void 0,this._$AM=e,this.options=s}get _$AU(){return this._$AM._$AU}_$AI(t){Z(this,t)}}const en=Jt.litHtmlPolyfillSupport;en?.(ct,dt),(Jt.litHtmlVersions??=[]).push("3.3.2");const sn=(n,t,e)=>{const s=e?.renderBefore??t;let r=s._$litPart$;if(r===void 0){const o=e?.renderBefore??null;s._$litPart$=r=new dt(t.insertBefore(it(),o),o,void 0,e??{})}return r._$AI(n),r};const Qt=globalThis;class w extends K{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){const t=super.createRenderRoot();return this.renderOptions.renderBefore??=t.firstChild,t}update(t){const e=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(t),this._$Do=sn(e,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(!1)}render(){return Q}}w._$litElement$=!0,w.finalized=!0,Qt.litElementHydrateSupport?.({LitElement:w});const rn=Qt.litElementPolyfillSupport;rn?.({LitElement:w});(Qt.litElementVersions??=[]).push("4.2.2");const nn=b`
	:host {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: var(--space-m);
		font-family: var(--font-ui);
	}

	.card {
		background: var(--color-surface);
		border-radius: var(--radius-xl);
		padding: var(--space-xl);
		box-shadow: var(--shadow-lg);
		width: 100%;
		max-width: 400px;
	}

	h1 {
		margin: 0 0 var(--space-l) 0;
		font-size: var(--text-xl);
		text-align: center;
		color: var(--color-text-main);
	}

	.error {
		background: var(--color-danger-soft);
		color: var(--color-danger-text);
		padding: var(--space-s) var(--space-m);
		border-radius: var(--radius-m);
		margin-bottom: var(--space-m);
		text-align: center;
		font-size: var(--text-sm);
	}
`;b`
	/* ===== Universal Reset ===== */
	*,
	*::before,
	*::after {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	html {
		font-size: 16px;
		-webkit-font-smoothing: antialiased;
		-moz-osx-font-smoothing: grayscale;
		scroll-behavior: smooth;
	}

	body {
		margin: 0;
		padding: 0;
		background: var(--color-bg);
		color: var(--color-text-main);
		font-family: var(--font-family);
		font-size: var(--text-body);
		line-height: var(--line-normal);
		overflow-x: hidden;
	}

	/* ===== Headings ===== */
	h1,
	h2,
	h3,
	h4,
	h5,
	h6 {
		margin: 0;
		padding: 0;
		font-weight: 600;
		line-height: var(--line-tight, 1.2);
	}

	h1 {
		font-size: var(--text-2xl, 2rem);
	}

	h2 {
		font-size: var(--text-xl, 1.5rem);
	}

	h3 {
		font-size: var(--text-lg, 1.25rem);
	}

	h4 {
		font-size: var(--text-md, 1.125rem);
	}

	h5 {
		font-size: var(--text-body, 1rem);
	}

	h6 {
		font-size: var(--text-sm, 0.875rem);
	}

	/* ===== Paragraph & Text ===== */
	p {
		margin: 0;
		padding: 0;
	}

	a {
		color: var(--color-primary);
		text-decoration: none;
		transition: color var(--transition-fast);
	}

	a:hover {
		color: var(--color-primary-dark);
	}

	/* ===== Lists ===== */
	ul,
	ol {
		margin: 0;
		padding-left: 1.5em;
	}

	li {
		margin: 0;
		padding: 0;
	}

	/* ===== Form Elements ===== */
	button,
	input,
	textarea,
	select {
		font-family: inherit;
		font-size: inherit;
		color: inherit;
	}

	button {
		cursor: pointer;
		border: none;
		background: none;
		padding: 0;
	}

	input,
	textarea,
	select {
		border: none;
		background: none;
		padding: 0;
		margin: 0;
	}

	input[type='checkbox'],
	input[type='radio'] {
		cursor: pointer;
	}

	textarea {
		resize: none;
	}

	/* ===== Tables ===== */
	table {
		border-collapse: collapse;
		border-spacing: 0;
		width: 100%;
	}

	th,
	td {
		padding: 0;
		text-align: left;
		border-collapse: collapse;
	}

	/* ===== Media ===== */
	img,
	video,
	iframe {
		max-width: 100%;
		height: auto;
		display: block;
	}

	/* ===== Pre & Code ===== */
	pre,
	code,
	kbd,
	samp {
		font-family: var(--font-mono, 'Courier New', monospace);
		font-size: 0.875em;
	}

	pre {
		overflow-x: auto;
		background: var(--color-surface-raised);
		padding: 1em;
		border-radius: var(--radius-m);
	}

	/* ===== Blockquote ===== */
	blockquote {
		margin: 0;
		padding-left: 1em;
		border-left: 4px solid var(--color-primary);
		color: var(--color-text-muted);
	}

	/* ===== Hr ===== */
	hr {
		margin: 1em 0;
		border: none;
		border-top: 1px solid var(--color-border);
	}

	/* ===== Focus Visible (Accessibility) ===== */
	:focus-visible {
		outline: 2px solid var(--color-primary);
		outline-offset: 2px;
	}

	/* ===== Disabled State ===== */
	:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}
`;b`
	/* ===== Font Sizes (Fluid/Adaptive) ===== */
	:host {
		--text-xs: clamp(0.75rem, 0.7rem + 0.15vw, 0.8125rem);
		--text-sm: clamp(0.8125rem, 0.78rem + 0.15vw, 0.875rem);
		--text-body: clamp(0.9375rem, 0.875rem + 0.25vw, 1.0625rem);
		--text-base: var(--text-body);
		--text-md: clamp(1rem, 0.95rem + 0.3vw, 1.125rem);
		--text-lg: clamp(1.0625rem, 0.95rem + 0.5vw, 1.25rem);
		--text-xl: clamp(1.25rem, 1.1rem + 0.7vw, 1.5rem);
		--text-2xl: clamp(1.5rem, 1.25rem + 1vw, 2rem);
		--text-3xl: clamp(1.875rem, 1.5rem + 1.5vw, 2.5rem);

		/* ===== Line Heights ===== */
		--line-tight: 1.2;
		--line-normal: 1.5;
		--line-loose: 1.8;

		/* ===== Font Weights ===== */
		--font-weight-light: 300;
		--font-weight-normal: 400;
		--font-weight-medium: 500;
		--font-weight-semibold: 600;
		--font-weight-bold: 700;

		/* ===== Font Families ===== */
		--font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
			Roboto, Helvetica, Arial, sans-serif;
		--font-mono: ui-monospace, 'Cascadia Mono', 'Segoe UI Mono', 'Courier New',
			monospace;

		/* ===== Spacing (Fluid/Adaptive) ===== */
		--space-3xs: clamp(0.25rem, 0.2rem + 0.2vw, 0.375rem);
		--space-2xs: clamp(0.375rem, 0.3rem + 0.3vw, 0.5rem);
		--space-xs: clamp(0.5rem, 0.45rem + 0.25vw, 0.625rem);
		--space-s: clamp(0.625rem, 0.55rem + 0.35vw, 0.875rem);
		--space-m: clamp(0.875rem, 0.8rem + 0.4vw, 1.125rem);
		--space-l: clamp(1.25rem, 1.1rem + 0.7vw, 1.75rem);
		--space-xl: clamp(1.75rem, 1.5rem + 1.2vw, 2.5rem);
		--space-2xl: clamp(2.5rem, 2rem + 2vw, 4rem);
	}

	/* ===== Text Utilities ===== */
	.text-xs {
		font-size: var(--text-xs);
		line-height: var(--line-normal);
	}

	.text-sm {
		font-size: var(--text-sm);
		line-height: var(--line-normal);
	}

	.text-body,
	.text-base {
		font-size: var(--text-body);
		line-height: var(--line-normal);
	}

	.text-md {
		font-size: var(--text-md);
		line-height: var(--line-normal);
	}

	.text-lg {
		font-size: var(--text-lg);
		line-height: var(--line-normal);
	}

	.text-xl {
		font-size: var(--text-xl);
		line-height: var(--line-tight);
	}

	.text-2xl {
		font-size: var(--text-2xl);
		line-height: var(--line-tight);
	}

	.text-3xl {
		font-size: var(--text-3xl);
		line-height: var(--line-tight);
	}

	/* ===== Font Weight Utilities ===== */
	.font-light {
		font-weight: var(--font-weight-light);
	}

	.font-normal {
		font-weight: var(--font-weight-normal);
	}

	.font-medium {
		font-weight: var(--font-weight-medium);
	}

	.font-semibold {
		font-weight: var(--font-weight-semibold);
	}

	.font-bold {
		font-weight: var(--font-weight-bold);
	}

	/* ===== Line Height Utilities ===== */
	.leading-tight {
		line-height: var(--line-tight);
	}

	.leading-normal {
		line-height: var(--line-normal);
	}

	.leading-loose {
		line-height: var(--line-loose);
	}

	/* ===== Text Decorations ===== */
	.text-underline {
		text-decoration: underline;
	}

	.text-line-through {
		text-decoration: line-through;
	}

	.text-truncate {
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
	}

	/* ===== Text Alignment ===== */
	.text-left {
		text-align: left;
	}

	.text-center {
		text-align: center;
	}

	.text-right {
		text-align: right;
	}

	.text-justify {
		text-align: justify;
	}

	/* ===== Text Transform ===== */
	.text-uppercase {
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.text-lowercase {
		text-transform: lowercase;
	}

	.text-capitalize {
		text-transform: capitalize;
	}

	/* ===== Text Colors ===== */
	.text-main {
		color: var(--color-text-main);
	}

	.text-muted {
		color: var(--color-text-muted);
	}

	.text-secondary {
		color: var(--color-text-muted);
	}

	.text-primary {
		color: var(--color-primary);
	}

	.text-success {
		color: var(--color-success);
	}

	.text-warning {
		color: var(--color-warning);
	}

	.text-danger {
		color: var(--color-danger);
	}

	/* ===== Headings Utilities ===== */
	.heading-xs {
		font-size: var(--text-sm);
		font-weight: var(--font-weight-semibold);
		line-height: var(--line-tight);
	}

	.heading-sm {
		font-size: var(--text-md);
		font-weight: var(--font-weight-semibold);
		line-height: var(--line-tight);
	}

	.heading-base {
		font-size: var(--text-lg);
		font-weight: var(--font-weight-semibold);
		line-height: var(--line-tight);
	}

	.heading-md {
		font-size: var(--text-xl);
		font-weight: var(--font-weight-semibold);
		line-height: var(--line-tight);
	}

	.heading-lg {
		font-size: var(--text-2xl);
		font-weight: var(--font-weight-bold);
		line-height: var(--line-tight);
	}

	/* ===== Word Wrap & Break ===== */
	.break-words {
		word-break: break-word;
		overflow-wrap: break-word;
	}

	.break-all {
		word-break: break-all;
	}

	.no-wrap {
		white-space: nowrap;
	}

	/* ===== Letter Spacing ===== */
	.tracking-tight {
		letter-spacing: -0.02em;
	}

	.tracking-normal {
		letter-spacing: 0;
	}

	.tracking-wide {
		letter-spacing: 0.05em;
	}

	.tracking-wider {
		letter-spacing: 0.1em;
	}

	/* ===== Selection ===== */
	::selection {
		background-color: var(--color-primary-soft);
		color: var(--color-text-main);
	}
`;const ut=b`
	.section {
		background: var(--color-surface);
		border-radius: var(--radius-l);
		padding: var(--space-l);
		box-shadow: var(--shadow-card);
	}

	.section-header {
		margin: 0 0 var(--space-m) 0;
	}

	.section-title {
		margin: 0;
		font-size: var(--text-xl);
		font-weight: 600;
		color: var(--color-text-main);
		line-height: var(--line-tight);
	}

	.section-subtitle {
		margin: var(--space-xs) 0 0 0;
		font-size: var(--text-sm);
		color: var(--color-text-muted);
	}

	.section-divider {
		margin: var(--space-l) 0;
		padding-top: var(--space-l);
		border-top: 1px solid var(--color-border);
	}

	.subsection-title {
		margin: 0 0 var(--space-m) 0;
		font-size: var(--text-lg);
		font-weight: 600;
		color: var(--color-text-main);
	}

	/* Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚: Ð²Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ð°Ñ ÑÐµÐºÑ†Ð¸Ñ */
	.section--highlighted {
		border: 2px dashed var(--color-primary);
		background: var(--color-primary-soft);
	}

	.section--highlighted .section-title {
		color: var(--color-primary);
	}
`,tt=b`
	/* ===== Form Group ===== */
	.form-group {
		margin-bottom: var(--space-m);
	}

	.form-group:last-child {
		margin-bottom: 0;
	}

	/* ===== Labels ===== */
	.label {
		display: block;
		margin-bottom: var(--space-xs);
		font-weight: 500;
		font-size: var(--text-sm);
		color: var(--color-text-main);
	}

	.label--required::after {
		content: ' *';
		color: var(--color-danger);
	}

	/* ===== Inputs ===== */
	.input,
	.textarea,
	.select {
		width: 100%;
		padding: var(--space-s) var(--space-m);
		border: 1px solid var(--color-border);
		border-radius: var(--radius-m);
		font-size: var(--text-body);
		font-family: inherit;
		background: var(--color-bg);
		color: var(--color-text-main);
		transition: border-color var(--transition-fast),
			box-shadow var(--transition-fast);
		box-sizing: border-box;
	}

	.input:focus,
	.textarea:focus,
	.select:focus {
		outline: none;
		border-color: var(--color-primary);
		box-shadow: 0 0 0 3px var(--color-primary-soft);
	}

	.input::placeholder,
	.textarea::placeholder {
		color: var(--color-text-muted);
		opacity: 0.7;
	}

	.textarea {
		resize: vertical;
		min-height: 80px;
	}

	/* ===== Validation States ===== */
	.input--valid,
	.input.valid {
		border-color: var(--color-success);
		box-shadow: 0 0 0 1px var(--color-success);
	}

	.input--invalid,
	.input.invalid {
		border-color: var(--color-danger);
		box-shadow: 0 0 0 1px var(--color-danger);
	}

	/* ===== Disabled State ===== */
	.input:disabled,
	.textarea:disabled,
	.select:disabled {
		opacity: 0.6;
		cursor: not-allowed;
		background: var(--color-surface-raised);
	}

	/* ===== Help Text ===== */
	.help-text {
		margin-top: var(--space-xs);
		font-size: var(--text-xs);
		color: var(--color-text-muted);
		line-height: var(--line-normal);
	}

	.help-text--error {
		color: var(--color-danger-text);
	}

	/* ===== Checkbox Group ===== */
	.checkbox-group {
		display: flex;
		align-items: flex-start;
		gap: var(--space-s);
		padding: var(--space-m);
		background: var(--color-surface-raised);
		border-radius: var(--radius-m);
		cursor: pointer;
		transition: background var(--transition-fast);
	}

	.checkbox-group:hover {
		background: var(--color-bg-hover);
	}

	.checkbox-input {
		width: 20px;
		height: 20px;
		margin: 0;
		cursor: pointer;
		accent-color: var(--color-primary);
		flex-shrink: 0;
	}

	.checkbox-content {
		flex: 1;
		min-width: 0;
	}

	.checkbox-label {
		font-weight: 500;
		color: var(--color-text-main);
		margin-bottom: var(--space-3xs);
	}

	.checkbox-description {
		font-size: var(--text-xs);
		color: var(--color-text-muted);
		line-height: var(--line-normal);
	}

	/* ===== File Input ===== */
	.file-input {
		display: none;
	}
`,q=b`
	/* ===== Base Button ===== */
	.btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: var(--space-xs);
		padding: var(--space-s) var(--space-m);
		border: none;
		border-radius: var(--radius-m);
		font-family: inherit;
		font-size: var(--text-sm);
		font-weight: 500;
		cursor: pointer;
		transition: background var(--transition-fast),
			transform var(--transition-fast), box-shadow var(--transition-fast);
		box-shadow: var(--shadow-sm);
		text-decoration: none;
	}

	.btn:disabled {
		opacity: 0.5;
		cursor: not-allowed;
		transform: none !important;
	}

	/* ===== Primary ===== */
	.btn--primary {
		background: var(--color-primary);
		color: white;
	}

	.btn--primary:hover:not(:disabled) {
		background: var(--color-primary-dark);
		transform: translateY(-1px);
		box-shadow: var(--shadow-md);
	}

	.btn--primary:active:not(:disabled) {
		transform: translateY(0);
	}

	/* ===== Secondary ===== */
	.btn--secondary {
		background: var(--color-surface-raised);
		color: var(--color-text-main);
		border: 1px solid var(--color-border);
		box-shadow: none;
	}

	.btn--secondary:hover:not(:disabled) {
		background: var(--color-bg-hover);
		border-color: var(--color-primary-muted);
	}

	/* ===== Danger ===== */
	.btn--danger {
		background: var(--color-danger-soft);
		color: var(--color-danger-text);
		box-shadow: none;
	}

	.btn--danger:hover:not(:disabled) {
		background: var(--color-danger-border);
	}

	/* ===== Ghost ===== */
	.btn--ghost {
		background: transparent;
		color: var(--color-text-main);
		box-shadow: none;
	}

	.btn--ghost:hover:not(:disabled) {
		background: var(--color-bg-hover);
	}

	/* ===== Link Style ===== */
	.btn--link {
		background: transparent;
		color: var(--color-primary);
		box-shadow: none;
		padding: var(--space-xs) var(--space-s);
	}

	.btn--link:hover:not(:disabled) {
		background: var(--color-primary-soft);
	}

	/* ===== Icon Button ===== */
	.btn--icon {
		padding: var(--space-xs);
		background: transparent;
		box-shadow: none;
		color: var(--color-text-muted);
		border-radius: var(--radius-s);
	}

	.btn--icon:hover:not(:disabled) {
		background: var(--color-bg-hover);
		color: var(--color-text-main);
		transform: none;
	}

	/* ===== Sizes ===== */
	.btn--sm {
		padding: var(--space-xs) var(--space-s);
		font-size: var(--text-xs);
	}

	.btn--lg {
		padding: var(--space-m) var(--space-l);
		font-size: var(--text-body);
	}

	/* ===== Full Width ===== */
	.btn--full {
		width: 100%;
	}

	/* ===== Legacy aliases (Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾Ð¹ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸) ===== */
	.button {
		/* ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ .btn */
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: var(--space-xs);
		padding: var(--space-s) var(--space-m);
		border: none;
		border-radius: var(--radius-m);
		font-family: inherit;
		font-size: var(--text-sm);
		font-weight: 500;
		cursor: pointer;
		transition: background var(--transition-fast),
			transform var(--transition-fast), box-shadow var(--transition-fast);
		box-shadow: var(--shadow-sm);
	}

	.button:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}
	.button-primary {
		background: var(--color-primary);
		color: white;
	}
	.button-primary:hover:not(:disabled) {
		background: var(--color-primary-dark);
	}
	.button-secondary {
		background: var(--color-surface-raised);
		color: var(--color-text-main);
		border: 1px solid var(--color-border);
		box-shadow: none;
	}
	.button-secondary:hover:not(:disabled) {
		background: var(--color-bg-hover);
	}
	.button-danger {
		background: var(--color-danger-soft);
		color: var(--color-danger-text);
		box-shadow: none;
	}
	.button-danger:hover:not(:disabled) {
		background: var(--color-danger-border);
	}
`,ts=b`
	.avatar {
		width: var(--avatar-size, 48px);
		height: var(--avatar-size, 48px);
		border-radius: var(--radius-full);
		background: var(--color-primary);
		display: flex;
		align-items: center;
		justify-content: center;
		color: white;
		font-weight: 600;
		font-size: calc(var(--avatar-size, 48px) * 0.4);
		overflow: hidden;
		flex-shrink: 0;
	}

	.avatar img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.avatar--sm {
		--avatar-size: 32px;
	}

	.avatar--lg {
		--avatar-size: 64px;
	}

	.avatar--xl {
		--avatar-size: 80px;
	}
`,es=b`
	/* ===== Flex helpers ===== */
	.flex {
		display: flex;
	}

	.flex-col {
		flex-direction: column;
	}

	.flex-center {
		align-items: center;
		justify-content: center;
	}

	.flex-between {
		justify-content: space-between;
	}

	.flex-1 {
		flex: 1;
	}

	.gap-xs {
		gap: var(--space-xs);
	}
	.gap-s {
		gap: var(--space-s);
	}
	.gap-m {
		gap: var(--space-m);
	}
	.gap-l {
		gap: var(--space-l);
	}

	/* ===== Common states ===== */
	.loading {
		display: flex;
		align-items: center;
		justify-content: center;
		padding: var(--space-xl);
		color: var(--color-text-muted);
	}

	.empty-state {
		text-align: center;
		padding: var(--space-xl);
		color: var(--color-text-muted);
	}

	/* ===== Spinner ===== */
	.spinner {
		width: var(--spinner-size, 40px);
		height: var(--spinner-size, 40px);
		border: 4px solid var(--color-border);
		border-top-color: var(--color-primary);
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}

	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}

	/* ===== Messages ===== */
	.error-message {
		padding: var(--space-s) var(--space-m);
		background: var(--color-danger-soft);
		border: 1px solid var(--color-danger-border);
		border-radius: var(--radius-m);
		color: var(--color-danger-text);
	}

	.success-message {
		padding: var(--space-s) var(--space-m);
		background: var(--color-success-soft);
		border: 1px solid var(--color-success);
		border-radius: var(--radius-m);
		color: var(--color-text-main);
	}
`;b`
	:host {
		/* ===== Color Palette Base (Hue Values) ===== */
		--hue-primary: 270;
		--hue-danger: 0;
		--hue-success: 142;
		--hue-warning: 38;

		/* ===== Lightness Scale (Light Mode) ===== */
		--l-bg: 99%;
		--l-surface: 100%;
		--l-raised: 97%;
		--l-hover: 95%;
		--l-border: 90%;
		--l-muted: 52%;
		--l-text: 18%;

		/* ===== Semantic Colors ===== */
		--color-bg: oklch(var(--l-bg) 0 0);
		--color-surface: oklch(var(--l-surface) 0 0);
		--color-surface-raised: oklch(var(--l-raised) 0 0);
		--color-bg-hover: oklch(var(--l-hover) 0 0);
		--color-text-main: oklch(var(--l-text) 0 0);
		--color-text-muted: oklch(var(--l-muted) 0 0);
		--color-text-secondary: oklch(var(--l-muted) 0 0);
		--color-border: oklch(var(--l-border) 0 0);
		--border-color: var(--color-border);
		--color-white: oklch(100% 0 0);
		--color-black: oklch(0% 0 0);

		/* ===== Primary Color (Vibrant, High Visibility) ===== */
		--color-primary: oklch(60% 0.3 var(--hue-primary));
		--color-primary-dark: oklch(48% 0.28 var(--hue-primary));
		--color-primary-soft: oklch(93% 0.08 var(--hue-primary));
		--color-primary-muted: oklch(72% 0.12 var(--hue-primary));

		/* ===== Danger Color (Red, Clear Distinction) ===== */
		--color-danger: oklch(56% 0.22 var(--hue-danger));
		--color-danger-soft: oklch(93% 0.08 var(--hue-danger));
		--color-danger-border: oklch(82% 0.1 var(--hue-danger));
		--color-danger-text: oklch(42% 0.18 var(--hue-danger));

		/* ===== Success Color (Green, Clear Distinction) ===== */
		--color-success: oklch(60% 0.18 var(--hue-success));
		--color-success-soft: oklch(93% 0.06 var(--hue-success));
		--color-success-border: oklch(82% 0.09 var(--hue-success));
		--color-success-text: oklch(42% 0.14 var(--hue-success));

		/* ===== Warning Color (Amber/Orange, High Visibility) ===== */
		--color-warning: oklch(60% 0.24 var(--hue-warning));
		--color-warning-soft: oklch(93% 0.08 var(--hue-warning));
		--color-warning-border: oklch(82% 0.12 var(--hue-warning));
		--color-warning-text: oklch(42% 0.18 var(--hue-warning));

		/* ===== Border Radius ===== */
		--radius-xs: 4px;
		--radius-s: 6px;
		--radius-m: 8px;
		--radius-l: 12px;
		--radius-xl: 16px;
		--radius-full: 9999px;

		/* ===== Indicator Sizes ===== */
		--indicator-size-sm: 8px;
		--indicator-size-md: 12px;
		--indicator-size-lg: 16px;

		/* ===== Shadows ===== */
		--shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
		--shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
		--shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.05);
		--shadow-lg: 0 4px 24px rgba(0, 0, 0, 0.1);
		--shadow-card: 0 2px 8px rgba(0, 0, 0, 0.05);

		/* ===== Transitions ===== */
		--transition-fast: 0.15s ease;
		--transition-normal: 0.2s ease;
		--transition-slow: 0.3s ease;

		/* ===== Avatar Sizes ===== */
		--avatar-size-sm: 32px;
		--avatar-size-md: 48px;
		--avatar-size-lg: 64px;

		/* ===== Gradient Variables ===== */
		--gradient-auth: linear-gradient(135deg, oklch(60% 0.3 270) 0%, oklch(50% 0.25 280) 100%);

		/* ===== Z-Index ===== */
		--z-dropdown: 100;
		--z-sticky: 200;
		--z-modal: 300;
		--z-toast: 400;
	}

	/* ===== Dark Mode ===== */
	@media (prefers-color-scheme: dark) {
		:host {
			--l-bg: 13%;
			--l-surface: 18%;
			--l-raised: 22%;
			--l-hover: 28%;
			--l-border: 32%;
			--l-muted: 58%;
			--l-text: 87%;

			/* Primary â€” Ð±Ð¾Ð»ÐµÐµ ÑÑ€ÐºÐ¸Ð¹ Ð´Ð»Ñ Ñ‚Ñ‘Ð¼Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ð½Ð° */
			--color-primary: oklch(70% 0.3 var(--hue-primary));
			--color-primary-dark: oklch(60% 0.28 var(--hue-primary));
			--color-primary-soft: oklch(30% 0.1 var(--hue-primary));
			--color-primary-muted: oklch(45% 0.12 var(--hue-primary));

			/* Danger â€” Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐºÐ¸Ð¹, Ð½Ð¾ Ð½Ðµ Ñ€ÐµÐ¶ÑƒÑ‰Ð¸Ð¹ */
			--color-danger: oklch(68% 0.22 var(--hue-danger));
			--color-danger-soft: oklch(28% 0.08 var(--hue-danger));
			--color-danger-border: oklch(40% 0.12 var(--hue-danger));

			/* Success â€” Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐºÐ¸Ð¹ */
			--color-success: oklch(70% 0.18 var(--hue-success));
			--color-success-soft: oklch(28% 0.07 var(--hue-success));
			--color-success-border: oklch(40% 0.1 var(--hue-success));

			/* Warning â€” Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾ Ð²Ð¸Ð´Ð¸Ð¼Ñ‹Ð¹ */
			--color-warning: oklch(70% 0.24 var(--hue-warning));
			--color-warning-soft: oklch(28% 0.1 var(--hue-warning));
			--color-warning-border: oklch(40% 0.12 var(--hue-warning));

		/* ===== Avatar Sizes (Dark Mode) ===== */
		--avatar-size-sm: 32px;
		--avatar-size-md: 48px;
		--avatar-size-lg: 64px;

		/* ===== Gradient Variables (Dark Mode) ===== */
		--gradient-auth: linear-gradient(135deg, oklch(70% 0.3 270) 0%, oklch(60% 0.25 280) 100%);
	}
`;class on extends w{static properties={message:{type:String}};static styles=[es,b`
			:host {
				display: block;
			}

			.loading-container {
				text-align: center;
				padding: var(--space-xl);
				color: var(--color-text-muted);
			}

			.loading-container p {
				margin-top: var(--space-m);
			}
		`];constructor(){super(),this.message="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."}render(){return f`
			<div class="loading-container">
				<div class="spinner"></div>
				<p>${this.message}</p>
			</div>
		`}}customElements.define("auth-loading",on);class an extends w{static properties={mode:{type:String}};static styles=b`
		:host {
			display: block;
		}

		.tabs {
			display: flex;
			gap: var(--space-xs);
			margin-bottom: var(--space-l);
		}

		.tab {
			flex: 1;
			padding: var(--space-s);
			border: none;
			background: var(--color-surface-raised);
			border-radius: var(--radius-m);
			cursor: pointer;
			font-weight: 500;
			font-family: inherit;
			font-size: var(--text-body);
			color: var(--color-text-main);
			transition: background var(--transition-fast),
				color var(--transition-fast);
		}

		.tab.active {
			background: var(--color-primary);
			color: white;
		}

		.tab:not(.active):hover {
			background: var(--color-bg-hover);
		}
	`;constructor(){super(),this.mode="login"}render(){return f`
			<div class="tabs">
				<button
					class="tab ${this.mode==="login"?"active":""}"
					@click=${()=>this._setMode("login")}
				>
					Ð’Ð¾Ð¹Ñ‚Ð¸
				</button>
				<button
					class="tab ${this.mode==="register"?"active":""}"
					@click=${()=>this._setMode("register")}
				>
					Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ
				</button>
			</div>
		`}_setMode(t){this.dispatchEvent(new CustomEvent("mode-change",{detail:{mode:t},bubbles:!0,composed:!0}))}}customElements.define("auth-tabs",an);class cn extends w{static properties={mode:{type:String},username:{type:String},password:{type:String},disabled:{type:Boolean}};static styles=[tt,q,b`
			:host {
				display: block;
			}

			.submit-btn {
				width: 100%;
				padding: var(--space-m);
				font-size: var(--text-body);
				font-weight: 600;
			}
		`];constructor(){super(),this.mode="login",this.username="",this.password="",this.disabled=!1}render(){const t=this.mode==="register"?"new-password":"current-password",e=this.mode==="login"?"Ð’Ð¾Ð¹Ñ‚Ð¸":"Ð—Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ";return f`
			<form @submit=${this._handleSubmit}>
				<div class="form-group">
					<label class="label" for="username">Ð˜Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ</label>
					<input
						id="username"
						type="text"
						class="input"
						.value=${this.username}
						@input=${this._onUsernameInput}
						placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ"
						autocomplete="username"
						?disabled=${this.disabled}
						required
					/>
				</div>

				<div class="form-group">
					<label class="label" for="password">ÐŸÐ°Ñ€Ð¾Ð»ÑŒ</label>
					<input
						id="password"
						type="password"
						class="input"
						.value=${this.password}
						@input=${this._onPasswordInput}
						placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
						autocomplete=${t}
						?disabled=${this.disabled}
						required
					/>
				</div>

				<button
					type="submit"
					class="btn btn--primary submit-btn"
					?disabled=${this.disabled}
				>
					${e}
				</button>
			</form>
		`}_onUsernameInput(t){this.username=t.target.value,this._dispatchChange()}_onPasswordInput(t){this.password=t.target.value,this._dispatchChange()}_dispatchChange(){this.dispatchEvent(new CustomEvent("form-change",{detail:{username:this.username,password:this.password},bubbles:!0,composed:!0}))}_handleSubmit(t){t.preventDefault(),!(!this.username.trim()||!this.password)&&this.dispatchEvent(new CustomEvent("form-submit",{detail:{mode:this.mode,username:this.username.trim(),password:this.password},bubbles:!0,composed:!0}))}focusPassword(){this.updateComplete.then(()=>{this.shadowRoot.getElementById("password")?.focus()})}clearPassword(){this.password=""}}customElements.define("auth-form",cn);class ln extends w{static properties={users:{type:Array}};static styles=b`
		:host {
			display: block;
		}

		.users-list {
			margin-top: var(--space-l);
			padding-top: var(--space-l);
			border-top: 1px solid var(--color-border);
		}

		h3 {
			margin: 0 0 var(--space-s) 0;
			font-size: var(--text-sm);
			color: var(--color-text-muted);
			font-weight: 500;
		}

		.chips {
			display: flex;
			flex-wrap: wrap;
			gap: var(--space-2xs);
		}

		.user-chip {
			display: inline-block;
			padding: var(--space-xs) var(--space-s);
			background: var(--color-surface-raised);
			border-radius: var(--radius-s);
			font-size: var(--text-sm);
			cursor: pointer;
			transition: background var(--transition-fast);
			border: none;
			font-family: inherit;
			color: var(--color-text-main);
		}

		.user-chip:hover {
			background: var(--color-bg-hover);
		}
	`;constructor(){super(),this.users=[]}render(){return!this.users||this.users.length===0?null:f`
			<div class="users-list">
				<h3>Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸:</h3>
				<div class="chips">
					${this.users.map(t=>f`
							<button
								class="user-chip"
								@click=${()=>this._selectUser(t.username)}
							>
								${t.username}
							</button>
						`)}
				</div>
			</div>
		`}_selectUser(t){this.dispatchEvent(new CustomEvent("user-select",{detail:{username:t},bubbles:!0,composed:!0}))}}customElements.define("users-list",ln);class ss extends w{static properties={actor:{type:Object},_state:{state:!0},_error:{state:!0},_availableUsers:{state:!0},_mode:{state:!0},_username:{state:!0},_password:{state:!0}};static styles=nn;constructor(){super(),this._state="initializing",this._error=null,this._availableUsers=[],this._mode="login",this._username="",this._password="",this._subscription=null}connectedCallback(){super.connectedCallback(),this._subscribe()}disconnectedCallback(){super.disconnectedCallback(),this._subscription?.unsubscribe()}updated(t){t.has("actor")&&this.actor&&this._subscribe()}_subscribe(){if(!this.actor)return;this._subscription?.unsubscribe();const t=e=>{this._state=e.value,this._error=e.context.error,this._availableUsers=e.context.availableUsers||[]};t(this.actor.getSnapshot()),this._subscription=this.actor.subscribe(t)}render(){if(this._state==="initializing")return this._renderCard(f`
				<auth-loading message="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."></auth-loading>
			`);if(this._state==="loggingIn"||this._state==="registering"){const t=this._state==="loggingIn"?"Ð’Ñ…Ð¾Ð´...":"Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ...";return this._renderCard(f`
				<auth-loading message=${t}></auth-loading>
			`)}return this._renderCard(f`
			<h1>ðŸ” Ð’Ñ…Ð¾Ð´</h1>

			<auth-tabs
				.mode=${this._mode}
				@mode-change=${this._handleModeChange}
			></auth-tabs>

			${this._error?f`<div class="error">âš ï¸ ${this._error}</div>`:""}

			<auth-form
				.mode=${this._mode}
				.username=${this._username}
				.password=${this._password}
				@form-change=${this._handleFormChange}
				@form-submit=${this._handleFormSubmit}
			></auth-form>

			<users-list
				.users=${this._availableUsers}
				@user-select=${this._handleUserSelect}
			></users-list>
		`)}_renderCard(t){return f`<div class="card">${t}</div>`}_handleModeChange(t){this._mode=t.detail.mode}_handleFormChange(t){this._username=t.detail.username,this._password=t.detail.password}_handleFormSubmit(t){const{mode:e,username:s,password:r}=t.detail,o=e==="login"?"LOGIN":"REGISTER";this.actor?.send({type:o,username:s,password:r}),this._password=""}_handleUserSelect(t){this._username=t.detail.username,this._mode="login",this.updateComplete.then(()=>{this.shadowRoot.querySelector("auth-form")?.focusPassword()})}}customElements.define("auth-screen",ss);const dn=b`
	:host {
		display: block;
		padding: var(--space-m);
	}

	.profile-header {
		display: flex;
		align-items: center;
		gap: var(--space-m);
		margin-bottom: var(--space-xl);
	}

	.avatar {
		width: var(--avatar-size-lg);
		height: var(--avatar-size-lg);
		background: var(--color-primary);
		border-radius: var(--radius-full);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: var(--text-xl);
		color: var(--color-white);
		font-weight: 600;
	}

	.user-info h2 {
		margin: 0;
		font-size: var(--text-xl);
		color: var(--color-text-main);
	}

	.user-info p {
		margin: var(--space-xs) 0 0;
		color: var(--color-text-muted);
	}

	.actions {
		display: flex;
		flex-direction: column;
		gap: var(--space-s);
	}

	/* Dialog Overlay */
	.confirm-dialog {
		position: fixed;
		inset: 0;
		background: rgba(0, 0, 0, 0.5);
		display: flex;
		align-items: center;
		justify-content: center;
		padding: var(--space-m);
		z-index: var(--z-modal);
	}

	.confirm-content {
		background: var(--color-surface);
		padding: var(--space-xl);
		border-radius: var(--radius-l);
		max-width: 400px;
		width: 100%;
		box-shadow: var(--shadow-lg);
	}

	.confirm-content h3 {
		margin: 0 0 var(--space-m) 0;
		color: var(--color-text-main);
	}

	.confirm-content p {
		color: var(--color-text-muted);
		margin-bottom: var(--space-l);
		line-height: var(--line-normal);
	}

	.confirm-buttons {
		display: flex;
		gap: var(--space-s);
	}

	.confirm-buttons button {
		flex: 1;
	}
`;class rs extends w{static properties={actor:{type:Object},username:{type:String},_showDeleteConfirm:{state:!0}};static styles=[q,dn];constructor(){super(),this._showDeleteConfirm=!1}render(){const t=this.username?.[0]?.toUpperCase()||"?";return f`
			<div class="profile-header">
				<div class="avatar">${t}</div>
				<div class="user-info">
					<h2>${this.username}</h2>
					<p>Ð’Ñ‹ Ð²Ð¾ÑˆÐ»Ð¸ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ</p>
				</div>
			</div>

			<div class="actions">
				<button class="btn btn--secondary" @click=${this._handleLogout}>
					ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸
				</button>
				<button class="btn btn--danger" @click=${this._showConfirm}>
					ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚
				</button>
			</div>

			${this._showDeleteConfirm?this._renderConfirmDialog():""}
		`}_renderConfirmDialog(){return f`
			<div class="confirm-dialog" @click=${this._closeDialog}>
				<div class="confirm-content" @click=${t=>t.stopPropagation()}>
					<h3>âš ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚?</h3>
					<p>
						Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ. Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ, Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸
						Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸, Ð±ÑƒÐ´ÑƒÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹.
					</p>
					<div class="confirm-buttons">
						<button class="btn btn--secondary" @click=${this._closeDialog}>
							ÐžÑ‚Ð¼ÐµÐ½Ð°
						</button>
						<button class="btn btn--danger" @click=${this._handleDelete}>
							Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
						</button>
					</div>
				</div>
			</div>
		`}_handleLogout(){this.actor?.send({type:"LOGOUT"})}_showConfirm(){this._showDeleteConfirm=!0}_closeDialog(){this._showDeleteConfirm=!1}_handleDelete(){this.actor?.send({type:"DELETE_ACCOUNT"}),this._showDeleteConfirm=!1}}customElements.define("profile-screen",rs);const un=Object.freeze(Object.defineProperty({__proto__:null,AuthScreen:ss,ProfileScreen:rs},Symbol.toStringTag,{value:"Module"}));class hn{constructor(t="/workers/crypto.worker.js"){this.workerUrl=t,this.worker=null,this.pending=new Map,this.requestId=0}async init(){this.worker||(this.worker=new Worker(new URL(this.workerUrl,window.location.origin)),this.worker.onmessage=t=>{const{requestId:e,result:s,error:r}=t.data,o=this.pending.get(e);o&&(r?o.reject(new Error(r)):o.resolve(s),this.pending.delete(e))},this.worker.onerror=t=>{console.error("[AuthCryptoService] Worker error:",t);for(const{reject:e}of this.pending.values())e(new Error("CryptoWorker crashed"));this.pending.clear()})}async request(t,e={}){await this.init();const s=this.requestId++;return new Promise((r,o)=>{this.pending.set(s,{resolve:r,reject:o}),this.worker.postMessage({requestId:s,method:t,params:e}),setTimeout(()=>{this.pending.has(s)&&(this.pending.delete(s),o(new Error(`Crypto timeout: ${t}`)))},3e4)})}generateIdentity(){return this.request("generateIdentity")}async destroy(){this.worker&&(this.worker.terminate(),this.worker=null)}}const pn={id:"auth",name:"Authentication",version:"1.0.0",dependencies:["persistence"],ui:{screen:"auth-screen",profile:"profile-screen"},async onMount(n){console.log("ðŸ” Mounting Auth feature...");const t=n.featureRegistry.getMountResult("persistence");if(!t?.service)throw new Error("Persistence service not available");const e=t.service,s=new hn;await s.init();const r=new Nr(s),o=new Pr(e),i=Or({authService:r,authRepo:o,cryptoService:s}),a=T(i,{inspect:c=>{c.type==="@xstate.snapshot"&&console.log("ðŸ” Auth state:",c.snapshot.value)}});return a.start(),console.log("âœ… Auth feature mounted"),{actor:a,authService:r,authRepo:o,cryptoService:s,isAuthenticated:()=>a.getSnapshot().matches("authenticated"),getUser:()=>{const c=a.getSnapshot();return c.matches("authenticated")?{username:c.context.username,identity:c.context.identity}:null},waitForAuth:()=>new Promise((c,l)=>{(()=>{const u=a.getSnapshot();u.matches("authenticated")&&c(u.context)})();const d=a.subscribe(u=>{u.matches("authenticated")&&(d.unsubscribe(),c(u.context))})})}},async onUnmount(n){const{actor:t,cryptoService:e}=n;t.getSnapshot().matches("authenticated")&&t.send({type:"LOGOUT"}),t.stop(),e&&await e.destroy(),console.log("ðŸ” Auth feature unmounted")}};function gn({repo:n,service:t,username:e,identity:s,authService:r,authRepo:o,eventBus:i}){return P({actors:{loadProfile:x(async({input:a})=>{const c=await a.repo.getProfile(a.username);return c?{...c,showInDiscovery:c?.showInDiscovery??!1}:{username:a.username,displayName:a.username,bio:"",avatar:null,showInDiscovery:!1}}),saveProfile:x(async({input:a})=>{const{profile:c,repo:l,service:h,eventBus:d,username:u}=a,p=h.validateUsername(c.displayName||c.username);if(!p.valid)throw new Error(p.error);const g=h.validateBio(c.bio);if(!g.valid)throw new Error(g.error);return await l.saveProfile(u,c),d&&d.dispatch({type:"PROFILE_UPDATED",username:u,profile:{...c}},"HIGH"),c}),processAvatar:x(async({input:a})=>{const{file:c,service:l}=a;return l.processAvatar(c)}),loadServers:x(async({input:a})=>{const c=await a.repo.getSignalingServers(a.username);return!c||c.length===0?a.service.getInitialServers():c}),saveServers:x(async({input:a})=>(await a.repo.saveSignalingServers(a.username,a.servers),a.servers)),changePassword:x(async({input:a})=>{const{oldPassword:c,newPassword:l,username:h,identity:d,authService:u,authRepo:p}=a;console.log("ðŸ” Changing password for:",h);const g=u.validatePassword(l);if(!g.valid)throw new Error(g.error);const v=await p.getUser(h);if(!v)throw new Error("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½");if(!await u.verifyPassword(c,v.passwordHash,v.salt))throw new Error("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ");const{hash:C,salt:y}=await u.hashPassword(l);if(!d)throw new Error("ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: Identity Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚");const S=await u.encryptUserData(d,l,y);await p.saveUserData(h,"identity",S),await p.updateUser(h,{passwordHash:C,salt:y}),await p.updateUser(h,{passwordHash:C,salt:y});const D=await p.getUser(h);if(console.log("ðŸ” DB Verification:",{expectedHash:C.substring(0,10)+"...",savedHash:D.passwordHash.substring(0,10)+"...",match:D.passwordHash===C}),D.passwordHash!==C)throw new Error("CRITICAL: Password save failed! DB returned old hash.");return console.log("âœ… Password and Identity re-encrypted successfully"),{success:!0}})},actions:{assignProfile:m(({event:a})=>({profile:a.output,error:null})),assignServers:m(({event:a})=>({signalingServers:a.output,activeServerId:a.output[0]?.id||null,error:null})),updateProfile:m(({context:a,event:c})=>({profile:{...a.profile,...c.updates}})),addServer:m(({context:a,event:c})=>{const l=a.service.addCustomServer(a.signalingServers,c.url);return{signalingServers:l,activeServerId:l[l.length-1].id}}),removeServer:m(({context:a,event:c})=>{const l=a.service.removeServer(a.signalingServers,c.serverId);let h=a.activeServerId;return h===c.serverId&&(h=l.find(d=>d.isDefault)?.id||null),{signalingServers:l,activeServerId:h}}),setActiveServer:m(({event:a,context:c})=>{const l=a.serverId,h=c.signalingServers.find(d=>d.id===l);return h&&c.eventBus&&setTimeout(()=>{c.eventBus.dispatch({type:"SIGNALING_SERVER_CHANGED",serverUrl:h.url,serverId:l})},0),{activeServerId:l}}),assignError:m({error:({event:a})=>a.error?.message||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°",passwordSuccess:!1}),clearError:m({error:null,passwordSuccess:!1}),logSaved:()=>{console.log("âœ… Settings saved")},setPasswordSuccess:m({passwordSuccess:!0,error:null}),notifyProfileLoaded:({context:a})=>{a.eventBus&&a.profile&&a.eventBus.dispatch({type:"PROFILE_UPDATED",username:a.username,profile:{...a.profile}},"MEDIUM")}},guards:{hasProfile:({context:a})=>!!a.profile}}).createMachine({id:"settings",initial:"loading",context:{repo:n,service:t,username:e,identity:s,authService:r,authRepo:o,eventBus:i,profile:null,signalingServers:[],activeServerId:null,error:null,passwordSuccess:!1},states:{loading:{type:"parallel",states:{profile:{initial:"loading",states:{loading:{invoke:{src:"loadProfile",input:({context:a})=>({repo:a.repo,username:a.username}),onDone:{target:"loaded",actions:["assignProfile","notifyProfileLoaded"]},onError:{target:"error",actions:"assignError"}}},loaded:{type:"final"},error:{}}},servers:{initial:"loading",states:{loading:{invoke:{src:"loadServers",input:({context:a})=>({repo:a.repo,service:a.service,username:a.username}),onDone:{target:"loaded",actions:"assignServers"},onError:{target:"error",actions:"assignError"}}},loaded:{type:"final"},error:{}}}},onDone:"ready"},ready:{on:{UPDATE_PROFILE:{actions:["updateProfile","clearError"]},SAVE_PROFILE:"savingProfile",UPLOAD_AVATAR:"processingAvatar",ADD_SERVER:{actions:["addServer","clearError"],target:"savingServers"},REMOVE_SERVER:{actions:["removeServer","clearError"],target:"savingServers"},SET_ACTIVE_SERVER:{actions:["setActiveServer","clearError"],target:"savingServers"},CHANGE_PASSWORD:{target:"changingPassword",actions:"clearError"}}},savingProfile:{invoke:{src:"saveProfile",input:({context:a})=>({profile:a.profile,repo:a.repo,service:a.service,eventBus:a.eventBus,username:a.username}),onDone:{target:"ready",actions:["assignProfile","logSaved"]},onError:{target:"ready",actions:"assignError"}}},processingAvatar:{invoke:{src:"processAvatar",input:({context:a,event:c})=>({file:c.file,service:a.service}),onDone:{target:"savingProfile",actions:m(({context:a,event:c})=>({profile:{...a.profile,avatar:c.output}}))},onError:{target:"ready",actions:"assignError"}}},savingServers:{invoke:{src:"saveServers",input:({context:a})=>({servers:a.signalingServers,repo:a.repo,username:a.username}),onDone:{target:"ready",actions:"logSaved"},onError:{target:"ready",actions:"assignError"}}},changingPassword:{invoke:{src:"changePassword",input:({context:a,event:c})=>({oldPassword:c.oldPassword,newPassword:c.newPassword,username:a.username,identity:a.identity,authService:a.authService,authRepo:a.authRepo}),onDone:{target:"ready",actions:["setPasswordSuccess"]},onError:{target:"ready",actions:"assignError"}}}}})}class fn{constructor(t){this.storage=t}async getProfile(t){return this.storage.get(`settings:${t}:profile`,"data")}async saveProfile(t,e){return this.storage.set(`settings:${t}:profile`,e,"data")}async getSignalingServers(t){return await this.storage.get(`settings:${t}:servers`,"data")||[]}async saveSignalingServers(t,e){return this.storage.set(`settings:${t}:servers`,e,"data")}}class Zt{static DEFAULT_SIGNALING_SERVER="https://functions.yandexcloud.net/d4eembfgfpdabtj2no3m";validateUsername(t){return!t||t.trim().length===0?{valid:!1,error:"Ð˜Ð¼Ñ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼"}:t.length<3?{valid:!1,error:"Ð˜Ð¼Ñ Ð´Ð¾Ð»Ð¶Ð½Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 3 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°"}:t.length>32?{valid:!1,error:"Ð˜Ð¼Ñ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 32 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°"}:/^[a-zA-Z0-9_-]+$/.test(t)?{valid:!0}:{valid:!1,error:"Ð˜Ð¼Ñ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð±ÑƒÐºÐ²Ñ‹, Ñ†Ð¸Ñ„Ñ€Ñ‹, Ð´ÐµÑ„Ð¸Ñ Ð¸ Ð¿Ð¾Ð´Ñ‡Ñ‘Ñ€ÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ"}}validatePassword(t){return!t||t.length<4?{valid:!1,error:"ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 4 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°"}:t.length>128?{valid:!1,error:"ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 128 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"}:{valid:!0}}validateBio(t){return t?t.length>500?{valid:!1,error:"Ð‘Ð¸Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 500 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"}:{valid:!0}:{valid:!0}}validateSignalingServerUrl(t){if(!t||t.trim().length===0)return{valid:!1,error:"URL Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼"};try{const e=new URL(t);return e.protocol!=="wss:"&&e.protocol!=="ws:"&&e.protocol!=="https:"?{valid:!1,error:"URL Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ‚ÑŒÑÑ Ñ https://, wss:// Ð¸Ð»Ð¸ ws://"}:{valid:!0}}catch{return{valid:!1,error:"ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ URL"}}}generateInvitationKey(t){if(!t||!t.userId)throw new Error("Invalid identity");const e={v:1,uid:t.userId,ts:Date.now()};return btoa(JSON.stringify(e))}parseInvitationKey(t){try{const e=JSON.parse(atob(t));if(!e.uid)throw new Error("Invalid key format");return{version:e.v||1,userId:e.uid,timestamp:e.ts}}catch{throw new Error("ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ")}}async processAvatar(t){return new Promise((e,s)=>{if(!t.type.startsWith("image/"))return s(new Error("Ð¤Ð°Ð¹Ð» Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼"));if(t.size>5*1024*1024)return s(new Error("Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð° Ð½Ðµ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°Ñ‚ÑŒ 5MB"));const r=new FileReader;r.onload=o=>{const i=new Image;i.onload=()=>{const a=document.createElement("canvas"),c=a.getContext("2d"),l=200;a.width=l,a.height=l;const h=Math.max(l/i.width,l/i.height),d=i.width*h,u=i.height*h,p=(l-d)/2,g=(l-u)/2;c.drawImage(i,p,g,d,u);const v=a.toDataURL("image/jpeg",.9);e(v)},i.onerror=()=>s(new Error("ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ")),i.src=o.target.result},r.onerror=()=>s(new Error("ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð°")),r.readAsDataURL(t)})}getInitialServers(){return[{id:"default",url:Zt.DEFAULT_SIGNALING_SERVER,isDefault:!0,label:"Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°"}]}addCustomServer(t,e){const s=this.validateSignalingServerUrl(e);if(!s.valid)throw new Error(s.error);if(t.some(o=>o.url===e))throw new Error("Ð­Ñ‚Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€ ÑƒÐ¶Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½");const r={id:`custom_${Date.now()}`,url:e,isDefault:!1,label:new URL(e).hostname,addedAt:Date.now()};return[...t,r]}removeServer(t,e){if(t.find(r=>r.id===e)?.isDefault)throw new Error("ÐÐµÐ»ÑŒÐ·Ñ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°");return t.filter(r=>r.id!==e)}}const vn={id:"settings",name:"Settings",version:"1.0.0",dependencies:["persistence","auth"],async onMount(n){console.log("âš™ï¸ Mounting Settings feature...");const t=n.featureRegistry.getMountResult("persistence"),e=n.featureRegistry.getMountResult("auth");if(!t?.service||!e?.actor)throw new Error("Required dependencies missing");let s=null;const r=(c,l)=>{if(s){if(s.getSnapshot().context.username===c)return s;o()}console.log("ðŸ‘¤ Initializing Settings for user:",c);const h=new fn(t.service),d=new Zt,u=e.authService,p=e.authRepo,g=gn({repo:h,service:d,username:c,identity:l,authService:u,authRepo:p,eventBus:n.eventBus}),v=T(g);return v.start(),s=v,n.actorRegistry&&n.actorRegistry.register("settings",v,{type:"feature",feature:"settings",username:c}),n.eventBus&&n.eventBus.dispatch({type:"SETTINGS_READY",actor:v,username:c}),v},o=()=>{s&&(console.log("ðŸ›‘ Stopping Settings Actor (Logout/Switch)..."),s.stop(),s=null)},i=e.actor.getSnapshot();if(i.matches("authenticated")){const{username:c,identity:l}=i.context;r(c,l)}const a=e.actor.subscribe(c=>{if(c.matches("authenticated")){const{username:l,identity:h}=c.context;r(l,h)}else o()});return{actor:s,getActor:()=>s,subscription:a,stopActor:o}},async onUnmount(n){console.log("âš™ï¸ Settings feature unmounting..."),n.subscription&&(console.log("  - Unsubscribing from auth"),n.subscription.unsubscribe());const t=n.getActor?.()||n.actor;if(t){console.log("  - Stopping settings actor");try{t.stop()}catch(e){console.error("[Settings] Error stopping actor:",e)}}console.log("âš™ï¸ Settings feature unmounted")}};function mn({service:n,identity:t,profile:e,eventBus:s}){const r=t?.userId,o=t?.exchange?.publicKey?JSON.stringify(t.exchange.publicKey):null;return console.log("ðŸ” createSignalingMachine:",{userId:r?.slice(0,16)+"...",hasExchangeKey:!!o,fullIdentity:t}),P({actors:{register:x(async({input:i})=>{const{service:a,userId:c,exchangePublicKey:l}=i;if(!c)throw new Error("Missing userId");if(!l)throw new Error("Missing exchange public key");return await a.register(c,l),console.log("âœ… Registered on signaling server:",c.slice(0,16)+"..."),{success:!0}}),pollEvents:ue(({input:i,sendBack:a})=>{const{service:c,userId:l}=i;let h=!0,d=null,u=0;return(async()=>{for(;h;)try{d=new AbortController;const g=await c.poll(l,d.signal);u=0,g.length>0&&(console.log(`ðŸ“¨ Received ${g.length} events`),a({type:"EVENTS_RECEIVED",events:g}))}catch(g){if(g.name==="AbortError")continue;if(h){if(u++,console.error(`âŒ Poll error (${u}):`,g.message),u>=3){a({type:"POLL_ERROR",error:g.message});break}await yn(Math.min(1e3*Math.pow(2,u-1),8e3))}}})(),()=>{h=!1,d?.abort()}}),heartbeat:ue(({input:i,sendBack:a})=>{const{service:c,userId:l}=i;let h=0;const d=async()=>{try{await c.heartbeat(l),h=0}catch(p){h++,console.warn(`âš ï¸ Heartbeat failed (${h}):`,p.message),h>=3&&a({type:"HEARTBEAT_FAILED",error:p.message})}};d();const u=setInterval(d,3e4);return()=>clearInterval(u)})},actions:{processEvents:({context:i,event:a})=>{const c=a.events||[];for(const l of c){console.log("ðŸ“© Processing event:",l.type,"from:",l.from?.slice(0,16)+"...");const d={invite:"SIGNALING_INVITE_RECEIVED",invite_accepted:"SIGNALING_INVITE_ACCEPTED",invite_rejected:"SIGNALING_INVITE_REJECTED",message:"SIGNALING_MESSAGE_RECEIVED",contact_deleted:"SIGNALING_CONTACT_DELETED",contact_blocked:"SIGNALING_CONTACT_BLOCKED",profile_updated:"SIGNALING_PROFILE_UPDATED"}[l.type]||`SIGNALING_${l.type.toUpperCase()}`;i.eventBus?.dispatch({type:d,payload:l})}},assignError:m({error:({event:i})=>i.error||"Unknown error"}),clearError:m({error:null}),resetRetryCount:m({retryCount:0}),incrementRetryCount:m({retryCount:({context:i})=>i.retryCount+1}),logConnected:({context:i})=>{console.log("ðŸ”— Signaling connected:",i.userId?.slice(0,16)+"...")},logDisconnected:()=>{console.log("ðŸ”Œ Signaling disconnected")},notifyConnected:({context:i})=>{i.eventBus?.dispatch({type:"SIGNALING_CONNECTED",userId:i.userId})},notifyDisconnected:({context:i})=>{i.eventBus?.dispatch({type:"SIGNALING_DISCONNECTED"})},sendInvite:({context:i,event:a})=>{const{toUserId:c}=a,l=i.profile;i.service.sendInvite(i.userId,l?.displayName||l?.username||"User",c,i.exchangePublicKey,l).then(()=>{console.log("âœ… Invite sent to:",c.slice(0,16)+"..."),i.eventBus?.dispatch({type:"SIGNALING_INVITE_SENT",toUserId:c})}).catch(h=>{console.error("âŒ Failed to send invite:",h),i.eventBus?.dispatch({type:"SIGNALING_INVITE_FAILED",toUserId:c,error:h.message})})},acceptInvite:({context:i,event:a})=>{const{toUserId:c}=a,l=i.profile;i.service.acceptInvite(i.userId,l?.displayName||l?.username||"User",c,i.exchangePublicKey,l).then(()=>{console.log("âœ… Invite accepted for:",c.slice(0,16)+"...")}).catch(h=>{console.error("âŒ Failed to accept invite:",h)})},blockContact:({context:i,event:a})=>{const{toUserId:c}=a;i.service.blockContact(i.userId,c).then(()=>{console.log("ðŸš« Contact blocked:",c.slice(0,16)+"...")}).catch(l=>{console.error("âŒ Failed to block contact:",l)})},rejectInvite:({context:i,event:a})=>{const{toUserId:c}=a;i.service.rejectInvite(i.userId,i.profile?.displayName||i.profile?.username||"User",c).then(()=>{console.log("âœ… Invite rejected for:",c.slice(0,16)+"...")}).catch(l=>{console.error("âŒ Failed to reject invite:",l)})},sendMessage:({context:i,event:a})=>{const{toUserId:c,messageData:l}=a;i.service.sendMessage(i.userId,c,l).catch(h=>{console.error("âŒ Failed to send message:",h),i.eventBus?.dispatch({type:"SIGNALING_MESSAGE_FAILED",toUserId:c,error:h.message})})},sendProfile:({context:i,event:a})=>{const{toUserId:c,profile:l}=a;i.service.sendProfile(i.userId,c,l||i.profile).catch(h=>{console.error("âŒ Failed to send profile:",h)})},notifyContactDeleted:({context:i,event:a})=>{const{toUserId:c}=a;i.service.sendContactDeleted(i.userId,c).catch(l=>{console.error("âŒ Failed to notify contact deleted:",l)})},updateProfile:m({profile:({event:i})=>i.profile}),updateService:m({service:({event:i})=>i.service})},guards:{canRetry:({context:i})=>i.retryCount<5,hasIdentity:({context:i})=>{const a=!!i.userId&&!!i.exchangePublicKey;return console.log("ðŸ” Guard hasIdentity:",{userId:!!i.userId,exchangePublicKey:!!i.exchangePublicKey,result:a}),a}},delays:{RETRY_DELAY:({context:i})=>Math.min(1e3*Math.pow(2,i.retryCount),16e3)}}).createMachine({id:"signaling",initial:"idle",context:{service:n,eventBus:s,userId:r,exchangePublicKey:o,profile:e,error:null,retryCount:0},states:{idle:{entry:()=>{console.log("ðŸ“¡ Machine: entering idle state")},on:{CONNECT:{target:"connecting",guard:"hasIdentity"}}},connecting:{entry:["clearError",()=>{console.log("ðŸ“¡ Machine: entering connecting state, registering...")}],invoke:{src:"register",input:({context:i})=>({service:i.service,userId:i.userId,exchangePublicKey:i.exchangePublicKey}),onDone:{target:"connected",actions:["resetRetryCount","logConnected","notifyConnected"]},onError:{target:"reconnecting",actions:"assignError"}}},connected:{entry:()=>console.log("ðŸ“¡ Machine: entering connected state"),type:"parallel",states:{polling:{invoke:{src:"pollEvents",input:({context:i})=>({service:i.service,userId:i.userId})},on:{EVENTS_RECEIVED:{actions:"processEvents"},POLL_ERROR:{target:"#signaling.reconnecting",actions:"assignError"}}},heartbeat:{invoke:{src:"heartbeat",input:({context:i})=>({service:i.service,userId:i.userId})},on:{HEARTBEAT_FAILED:{target:"#signaling.reconnecting",actions:"assignError"}}}},on:{DISCONNECT:{target:"idle",actions:["logDisconnected","notifyDisconnected"]},SEND_INVITE:{actions:"sendInvite"},ACCEPT_INVITE:{actions:"acceptInvite"},REJECT_INVITE:{actions:"rejectInvite"},SEND_MESSAGE:{actions:"sendMessage"},SEND_PROFILE:{actions:"sendProfile"},CONTACT_DELETED:{actions:"notifyContactDeleted"},UPDATE_PROFILE:{actions:"updateProfile"},CHANGE_SERVER:{target:"idle",actions:["logDisconnected","notifyDisconnected","updateService"]}}},reconnecting:{entry:"incrementRetryCount",after:{RETRY_DELAY:[{target:"connecting",guard:"canRetry"},{target:"error"}]},on:{DISCONNECT:{target:"idle",actions:["logDisconnected","notifyDisconnected"]}}},error:{entry:({context:i})=>{console.error("âŒ Signaling error after max retries:",i.error),i.eventBus?.dispatch({type:"SIGNALING_ERROR",error:i.error})},on:{RETRY:{target:"connecting",actions:"resetRetryCount"},DISCONNECT:{target:"idle"}}}}})}function yn(n){return new Promise(t=>setTimeout(t,n))}class bn{constructor(t){this.serverUrl=t,this.pollAbortController=null}setServerUrl(t){this.serverUrl=t}async register(t,e){return this._request("register",{userId:t,publicKey:e})}async heartbeat(t){return this._request("heartbeat",{userId:t})}async poll(t,e){const s=new URL(this.serverUrl);s.searchParams.set("action","poll"),s.searchParams.set("userId",t),console.log("ðŸ“¡ Poll request:",t.slice(0,16)+"...","URL:",s.toString());try{const r=await fetch(s.toString(),{method:"GET",signal:e});if(!r.ok)throw new Error(`Poll failed: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.error||"Poll failed");const i=o.data?.events||[];return i.length>0&&console.log("ðŸ“¨ Poll got",i.length,"event(s) for",t.slice(0,16)+"..."),i}catch(r){if(r.name==="AbortError")return[];throw r}}async sendInvite(t,e,s,r,o=null){return this._request("invite",{from:t,fromName:e,to:s,publicKey:r,avatar:o?.avatar||null,bio:o?.bio||null})}async acceptInvite(t,e,s,r,o=null){return this._request("accept_invite",{from:t,fromName:e,to:s,publicKey:r,avatar:o?.avatar||null,bio:o?.bio||null})}async rejectInvite(t,e,s){return this._request("reject_invite",{from:t,fromName:e,to:s})}async sendMessage(t,e,s){return this._request("send_message",{from:t,to:e,...s})}async sendProfile(t,e,s){return this._request("send_profile",{from:t,to:e,name:s.displayName||s.name,avatar:s.avatar||null,bio:s.bio||null})}async sendContactDeleted(t,e){return this._request("contact_deleted",{from:t,to:e})}async blockContact(t,e){return this._request("block_contact",{from:t,to:e})}async getStatuses(t,e){return(await this._request("status",{userId:t,contacts:e})).statuses||{}}async _request(t,e){const s=new URL(this.serverUrl);s.searchParams.set("action",t);const r=await fetch(s.toString(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw new Error(`Request failed: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.error||`Action ${t} failed`);return o.data}}const Ce="https://functions.yandexcloud.net/d4eembfgfpdabtj2no3m",_n={id:"signaling",name:"Signaling",version:"2.0.0",dependencies:["persistence","auth"],async onMount(n){console.log("ðŸ“¡ Mounting Signaling feature...");const{featureRegistry:t,eventBus:e,actorRegistry:s}=n,r=t.getMountResult("auth");let o=t.getMountResult("settings");if(!r?.actor){console.error("âŒ Auth feature required for signaling");return}let i=null,a=null;const c=()=>{if(!o?.actor)return Ce;const y=o.actor.getSnapshot(),S=y.context.activeServerId;return(y.context.signalingServers||[]).find(is=>is.id===S)?.url||Ce},l=()=>o?.actor?.getSnapshot().context.profile||null,h=()=>{const S=r.actor.getSnapshot().context.identity;return S?(console.log("ðŸ“¡ Getting identity from auth:",{hasUserId:!!S.userId,hasExchange:!!S.exchange,keys:Object.keys(S)}),{userId:S.userId,identity:S.identity,exchange:S.exchange,version:S.version}):(console.warn("âš ï¸ No identity in auth context"),null)},d=()=>{i&&(console.log("ðŸ“¡ Stopping Signaling Actor..."),i.send({type:"DISCONNECT"}),i.stop(),s&&s.unregister("signaling"),i=null,a=null)},u=()=>{if(i)return;const y=h();if(!y||!y.userId){console.warn("âš ï¸ Cannot start signaling: no identity in auth");return}console.log("ðŸ“¡ Starting Signaling Actor..."),console.log("ðŸ“¡ Identity from AUTH:",{userId:y.userId?.slice(0,16)+"...",hasExchangeKey:!!y.exchange?.publicKey});const S=c();console.log("ðŸ“¡ Target URL:",S),a=new bn(S);const D=mn({service:a,identity:y,profile:l(),eventBus:e});i=T(D),i.start(),console.log("ðŸ“¡ Sending CONNECT event"),i.send({type:"CONNECT"}),s&&s.register("signaling",i,{type:"feature",feature:"signaling"}),console.log("ðŸ“¡ Dispatching SIGNALING_READY event"),e.dispatch({type:"SIGNALING_READY",actor:i});const F=i.getSnapshot();console.log("ðŸ“¡ Machine initial state:",F.value)},p=y=>{const S=y.value,D=S==="authenticated"||typeof S=="object"&&"authenticated"in S;if(console.log("ðŸ“¡ Auth state changed:",S,"isAuthenticated:",D),D){const F=y.context.identity;console.log("ðŸ“¡ Auth identity available:",!!F,F?.userId?.slice(0,16)+"..."),!i&&F&&u()}else d()},g=r.actor.subscribe(p);p(r.actor.getSnapshot());const v=y=>{i&&i.send({type:"UPDATE_PROFILE",profile:y.profile})};e.on("PROFILE_UPDATED",v);const _=y=>{console.log("ðŸ“¡ Settings ready, updating reference"),y.actor&&(o={actor:y.actor})};e.on("SETTINGS_READY",_);const C=y=>{console.log("ðŸ“¡ Switching signaling server to:",y.serverUrl),i&&(d(),setTimeout(()=>{u()},100))};return e.on("SIGNALING_SERVER_CHANGED",C),{getActor:()=>i,getService:()=>a,cleanup:()=>{g.unsubscribe(),e.off("PROFILE_UPDATED",v),e.off("SETTINGS_READY",_),e.off("SIGNALING_SERVER_CHANGED",C),d()}}},async onUnmount(n){n.cleanup?.(),console.log("ðŸ“¡ Signaling feature unmounted")}},wn="ChatAppDB",A="contacts",xn=1;class Sn{constructor(){this.db=null}async init(){return new Promise((t,e)=>{const s=indexedDB.open(wn,xn);s.onerror=()=>{console.error("âŒ IndexedDB open error:",s.error),e(s.error)},s.onsuccess=()=>{this.db=s.result,console.log("âœ… Contacts repository initialized"),t()},s.onupgradeneeded=r=>{const o=r.target.result;if(!o.objectStoreNames.contains(A)){const i=o.createObjectStore(A,{keyPath:"id"});i.createIndex("username","username",{unique:!1}),i.createIndex("status","status",{unique:!1}),i.createIndex("addedAt","addedAt",{unique:!1}),console.log("ðŸ“Š Contacts store created")}}})}async addContact(t){return new Promise((e,s)=>{const i=this.db.transaction([A],"readwrite").objectStore(A).add(t);i.onerror=()=>s(i.error),i.onsuccess=()=>{console.log("âœ… Contact added:",t.id?.slice(0,16)),e()}})}async updateContact(t){return new Promise((e,s)=>{const i=this.db.transaction([A],"readwrite").objectStore(A).put(t);i.onerror=()=>s(i.error),i.onsuccess=()=>{console.log("âœ… Contact updated:",t.id?.slice(0,16)),e()}})}async getContact(t){return new Promise((e,s)=>{const i=this.db.transaction([A],"readonly").objectStore(A).get(t);i.onerror=()=>s(i.error),i.onsuccess=()=>e(i.result||null)})}async getAllContacts(){return new Promise((t,e)=>{const o=this.db.transaction([A],"readonly").objectStore(A).getAll();o.onerror=()=>e(o.error),o.onsuccess=()=>{const i=o.result||[];console.log(`ðŸ“Š Loaded ${i.length} contacts from storage`),t(i)}})}async getContactsByStatus(t){return new Promise((e,s)=>{const a=this.db.transaction([A],"readonly").objectStore(A).index("status").getAll(t);a.onerror=()=>s(a.error),a.onsuccess=()=>e(a.result||[])})}async deleteContact(t){return new Promise((e,s)=>{const i=this.db.transaction([A],"readwrite").objectStore(A).delete(t);i.onerror=()=>s(i.error),i.onsuccess=()=>{console.log("âœ… Contact deleted:",t?.slice(0,16)),e()}})}async blockContact(t){console.log("ðŸš« blockContact (stub):",t?.slice(0,16));const e=this._getBlockedFromStorage();e.add(t),this._saveBlockedToStorage(e)}async addBlockedBy(t){console.log("ðŸš« addBlockedBy (stub):",t?.slice(0,16));const e=this._getBlockedByFromStorage();e.add(t),this._saveBlockedByToStorage(e)}async isBlocked(t){const e=this._getBlockedFromStorage(),s=this._getBlockedByFromStorage();return e.has(t)||s.has(t)}async getBlockedContacts(){const t=this._getBlockedFromStorage();return Array.from(t).map(e=>({id:e,type:"blocked"}))}_getBlockedFromStorage(){try{const t=localStorage.getItem("blocked_contacts");return new Set(t?JSON.parse(t):[])}catch{return new Set}}_saveBlockedToStorage(t){localStorage.setItem("blocked_contacts",JSON.stringify(Array.from(t)))}_getBlockedByFromStorage(){try{const t=localStorage.getItem("blocked_by_contacts");return new Set(t?JSON.parse(t):[])}catch{return new Set}}_saveBlockedByToStorage(t){localStorage.setItem("blocked_by_contacts",JSON.stringify(Array.from(t)))}async clear(){return new Promise((t,e)=>{const o=this.db.transaction([A],"readwrite").objectStore(A).clear();o.onerror=()=>e(o.error),o.onsuccess=()=>{console.log("âœ… All contacts cleared"),t()}})}close(){this.db&&(this.db.close(),console.log("ðŸ”Œ Contacts repository closed"))}}class En{constructor(t,e,s){this.repository=t,this.signalingActor=e,this.eventBus=s}async loadContacts(){return{contacts:await this.repository.getAllContacts()}}async addContact({userId:t,exchangePublicKey:e,group:s}){if(await this.repository.getContact(t))throw new Error("CONTACT_ALREADY_EXISTS");if(await this.repository.isBlocked(t))throw new Error("CONTACT_IS_BLOCKED");const i={id:t,username:"ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ...",avatar:null,bio:null,group:s||null,exchangePublicKey:e,status:"pending_outgoing",addedAt:Date.now(),lastSeen:null,isOnline:!1,unreadCount:0,lastMessage:null};return await this.repository.addContact(i),this.signalingActor.send({type:"SEND_INVITE",toUserId:t}),console.log("âœ… Contact added (pending_outgoing):",t.slice(0,16)+"..."),i}async acceptContact(t,e){const s=await this.repository.getContact(t);if(!s)throw new Error("CONTACT_NOT_FOUND");if(s.status!=="pending_incoming")throw new Error("CONTACT_NOT_PENDING_INCOMING");return s.status="accepted",s.group=e||"Default",await this.repository.updateContact(s),this.signalingActor.send({type:"ACCEPT_INVITE",toUserId:t}),console.log("âœ… Contact accepted:",t.slice(0,16)+"..."),s}async rejectContact(t){if(!await this.repository.getContact(t))throw new Error("CONTACT_NOT_FOUND");await this.repository.deleteContact(t),this.signalingActor.send({type:"REJECT_INVITE",toUserId:t}),console.log("âŒ Contact rejected:",t.slice(0,16)+"...")}async cancelOutgoing(t){const e=await this.repository.getContact(t);if(!e)throw new Error("CONTACT_NOT_FOUND");if(e.status!=="pending_outgoing")throw new Error("CONTACT_NOT_PENDING_OUTGOING");await this.repository.deleteContact(t),console.log("âŒ Outgoing request cancelled:",t.slice(0,16)+"...")}async deleteAndBlockContact(t){await this.repository.blockContact(t),await this.repository.deleteContact(t),this.signalingActor.send({type:"BLOCK_CONTACT",toUserId:t}),console.log("ðŸš« Contact deleted and blocked:",t.slice(0,16)+"...")}async deleteContact(t){await this.repository.deleteContact(t),this.signalingActor.send({type:"CONTACT_DELETED",toUserId:t}),console.log("ðŸ—‘ï¸ Contact deleted:",t.slice(0,16)+"...")}async updateContactGroup(t,e){const s=await this.repository.getContact(t);if(!s)throw new Error("CONTACT_NOT_FOUND");return s.group=e,await this.repository.updateContact(s),console.log("ðŸ“ Contact group updated:",t.slice(0,16)+"...",e),s}async getGroups(){return this.repository.getGroups()}async handleIncomingInvite({from:t,fromName:e,publicKey:s,avatar:r,bio:o}){if(await this.repository.isBlocked(t)){console.warn("âš ï¸ Invite from blocked contact, ignoring:",t.slice(0,16)+"...");return}if(await this.repository.getContact(t)){console.warn("âš ï¸ Invite from existing contact, ignoring");return}let c=null;if(s)try{c=JSON.parse(s)}catch{try{const d=v=>v.replace(/-/g,"+").replace(/_/g,"/");let u=String(s).trim();for(u=d(u);u.length%4!==0;)u+="=";const p=atob(u),g=new Uint8Array(Array.from(p).map(v=>v.charCodeAt(0)));c=new TextDecoder().decode(g),c=JSON.parse(c)}catch(d){console.warn("Could not parse publicKey payload:",d?.message||d),c=null}}const l={id:t,username:e||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ",avatar:r||null,bio:o||null,group:null,exchangePublicKey:c,status:"pending_incoming",addedAt:Date.now(),lastSeen:Date.now(),isOnline:!0,unreadCount:0,lastMessage:null};await this.repository.addContact(l),console.log("ðŸ“¨ Incoming invite received:",t.slice(0,16)+"...","name:",e,"hasAvatar:",!!r),this.eventBus?.dispatch({type:"CONTACTS_INVITE_RECEIVED",contact:l})}async handleInviteAccepted({from:t,fromName:e,avatar:s,bio:r}){const o=await this.repository.getContact(t);if(!o){console.warn("âš ï¸ Invite accepted from unknown contact");return}o.status="accepted",o.group=o.group||"Default",o.username=e||o.username||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ",o.avatar=s||o.avatar,o.bio=r||o.bio,o.lastSeen=Date.now(),o.isOnline=!0,await this.repository.updateContact(o),console.log("âœ… Invite accepted by:",t.slice(0,16)+"...","name:",e,"hasAvatar:",!!s),this.eventBus?.dispatch({type:"CONTACTS_INVITE_ACCEPTED",contact:o})}async handleInviteRejected({from:t}){await this.repository.getContact(t)&&(await this.repository.deleteContact(t),console.log("âŒ Invite rejected by:",t.slice(0,16)+"..."),this.eventBus?.dispatch({type:"CONTACTS_INVITE_REJECTED",contactId:t}))}async handleProfileUpdate({from:t,name:e,avatar:s,bio:r}){const o=await this.repository.getContact(t);if(!o){console.warn("âš ï¸ Profile update from unknown contact:",t.slice(0,16)+"...");return}e&&(o.username=e),s!==void 0&&(o.avatar=s),r!==void 0&&(o.bio=r),await this.repository.updateContact(o),console.log("ðŸ“ Profile updated for:",t.slice(0,16)+"..."),this.eventBus?.dispatch({type:"CONTACTS_PROFILE_UPDATED",contactId:t})}async handleContactBlocked({from:t}){await this.repository.addBlockedBy(t),await this.repository.deleteContact(t),console.log("ðŸš« Blocked by:",t.slice(0,16)+"..."),this.eventBus?.dispatch({type:"CONTACTS_BLOCKED_BY",contactId:t})}async handleContactDeleted({from:t}){await this.repository.deleteContact(t),console.log("ðŸ—‘ï¸ Contact deleted remotely:",t.slice(0,16)+"..."),this.eventBus?.dispatch({type:"CONTACTS_CONTACT_DELETED",contactId:t})}async markAsRead(t){await this.repository.markAsRead(t)}async updateLastMessage(t,e,s=!1){await this.repository.updateLastMessage(t,e,s)}}function An({service:n,eventBus:t}){return P({actors:{loadContacts:x(async({input:e})=>{const{service:s}=e,r=await s.loadContacts();let o=[];return Array.isArray(r)?o=r:r&&Array.isArray(r.contacts)&&(o=r.contacts),{contacts:o}}),addContact:x(async({input:e})=>{const{service:s,data:r}=e;return{contact:await s.addContact(r)}}),acceptContact:x(async({input:e})=>{const{service:s,contactId:r,group:o}=e;return{contact:await s.acceptContact(r,o)}}),rejectContact:x(async({input:e})=>{const{service:s,contactId:r}=e;return await s.rejectContact(r),{contactId:r}}),cancelOutgoing:x(async({input:e})=>{const{service:s,contactId:r}=e;return await s.cancelOutgoing(r),{contactId:r}}),deleteContact:x(async({input:e})=>{const{service:s,contactId:r}=e;return await s.deleteContact(r),{contactId:r}}),updateGroup:x(async({input:e})=>{const{service:s,contactId:r,group:o}=e;return{contact:await s.updateContactGroup(r,o)}}),loadGroups:x(async({input:e})=>{const{service:s}=e;return{groups:await s.getGroups()}})},actions:{assignContacts:m({contacts:({event:e})=>{const s=e?.output;return Array.isArray(s)?s:s&&Array.isArray(s.contacts)?s.contacts:[]}}),addContactToList:m({contacts:({context:e,event:s})=>{const r=s?.output?.contact;return[...Array.isArray(e.contacts)?e.contacts:[],r].filter(Boolean)}}),updateContactInList:m({contacts:({context:e,event:s})=>{const r=s?.output?.contact,o=Array.isArray(e.contacts)?e.contacts:[];return r?o.map(i=>i.id===r.id?r:i):o}}),removeContactFromList:m({contacts:({context:e,event:s})=>{const r=s?.output?.contactId,o=Array.isArray(e.contacts)?e.contacts:[];return r?o.filter(i=>i.id!==r):o}}),clearActiveContactIfDeleted:m({activeContactId:({context:e,event:s})=>{const r=s?.output?.contactId;return e.activeContactId===r?null:e.activeContactId}}),setActiveContact:m({activeContactId:({event:e})=>e.contactId}),clearActiveContact:m({activeContactId:null}),assignGroups:m({groups:({event:e})=>e.output.groups}),assignError:m({error:(e={})=>{const s=e.event||e;return s?.error?.message||s?.data?.message||"Unknown error"}}),clearError:m({error:null}),logLoaded:(e={})=>{const s=e.context||{};console.log("ðŸ“‡ Contacts loaded:",(s.contacts||[]).length)},logError:(e={})=>{const s=e.context||{};console.error("âŒ Contacts error:",s.error||e.error||e.event?.error||"Unknown")},notifyContactAdded:(e={})=>{const s=e.context||{},o=(e.event||{}).output?.contact;s.eventBus?.dispatch({type:"CONTACTS_CONTACT_ADDED",contact:o})},notifyContactUpdated:(e={})=>{const s=e.context||{},o=(e.event||{}).output?.contact;s.eventBus?.dispatch({type:"CONTACTS_CONTACT_UPDATED",contact:o})},notifyContactDeleted:(e={})=>{const s=e.context||{},o=(e.event||{}).output?.contactId;s.eventBus?.dispatch({type:"CONTACTS_CONTACT_DELETED",contactId:o})},notifyContactsLoaded:(e={})=>{const s=e.context||{};s.eventBus?.dispatch({type:"CONTACTS_LOADED",contacts:s.contacts||[]})},handleIncomingInvite:({context:e,event:s})=>{const r=s.payload;console.log("ðŸ“¨ handleIncomingInvite called with:",{hasContext:!!e,hasService:!!e.service,payload:r}),e.service&&e.service.handleIncomingInvite(r).then(()=>{console.log("ðŸ“¨ Invite processed, sending RELOAD to machine"),e.eventBus?.dispatch({type:"CONTACTS_RELOAD_REQUESTED"})}).catch(o=>{console.error("Failed to handle incoming invite:",o)})},handleInviteAccepted:({context:e,event:s})=>{const r=s.payload;e.service&&e.service.handleInviteAccepted(r).then(()=>{console.log("ðŸ“¨ Invite accepted processed, sending RELOAD"),e.eventBus?.dispatch({type:"CONTACTS_RELOAD_REQUESTED"})}).catch(o=>{console.error("Failed to handle invite accepted:",o)})},handleInviteRejected:({context:e,event:s})=>{const r=s.payload;e.service&&e.service.handleInviteRejected(r).then(()=>{console.log("ðŸ“¨ Invite rejected processed, sending RELOAD"),e.eventBus?.dispatch({type:"CONTACTS_RELOAD_REQUESTED"})}).catch(o=>{console.error("Failed to handle invite rejected:",o)})},handleContactDeleted:({context:e,event:s})=>{const r=s.payload;e.service&&e.service.handleContactDeleted(r).then(()=>{console.log("ðŸ“¨ Contact deleted processed, sending RELOAD"),e.eventBus?.dispatch({type:"CONTACTS_RELOAD_REQUESTED"})}).catch(o=>{console.error("Failed to handle contact deleted:",o)})},handleContactBlocked:({context:e,event:s})=>{const r=s.payload;e.service&&e.service.handleContactBlocked(r).then(()=>{console.log("ðŸš« Contact blocked processed, sending RELOAD"),e.eventBus?.dispatch({type:"CONTACTS_RELOAD_REQUESTED"})}).catch(o=>{console.error("Failed to handle contact blocked:",o)})},handleProfileUpdated:({context:e,event:s})=>{const r=s.payload;e.service&&e.service.handleProfileUpdate(r).then(()=>{console.log("ðŸ“¨ Profile updated processed, sending RELOAD"),e.eventBus?.dispatch({type:"CONTACTS_RELOAD_REQUESTED"})}).catch(o=>{console.error("Failed to handle profile update:",o)})}}}).createMachine({id:"contacts",initial:"loading",context:{service:n,eventBus:t,contacts:[],groups:[],activeContactId:null,error:null},states:{loading:{invoke:{src:"loadContacts",input:({context:e})=>({service:e.service}),onDone:{target:"ready",actions:["assignContacts","logLoaded","notifyContactsLoaded"]},onError:{target:"error",actions:["assignError","logError"]}}},ready:{on:{ADD_CONTACT:{target:"adding"},ACCEPT_CONTACT:{target:"accepting"},REJECT_CONTACT:{target:"rejecting"},CANCEL_OUTGOING:{target:"cancelling"},DELETE_CONTACT:{target:"deleting"},DELETE_AND_BLOCK_CONTACT:{target:"blocking"},UPDATE_CONTACT_GROUP:{target:"updatingGroup"},RELOAD:{target:"loading"},SELECT_CONTACT:{actions:"setActiveContact"},SIGNALING_INVITE_RECEIVED:{actions:"handleIncomingInvite"},SIGNALING_INVITE_ACCEPTED:{actions:"handleInviteAccepted"},SIGNALING_INVITE_REJECTED:{actions:"handleInviteRejected"},SIGNALING_CONTACT_DELETED:{actions:"handleContactDeleted"},SIGNALING_CONTACT_BLOCKED:{actions:"handleContactBlocked"},SIGNALING_PROFILE_UPDATED:{actions:"handleProfileUpdated"}}},adding:{invoke:{src:"addContact",input:({context:e,event:s})=>({service:e.service,data:s.data}),onDone:{target:"ready",actions:["addContactToList","notifyContactAdded"]},onError:{target:"ready",actions:["assignError","logError"]}}},accepting:{invoke:{src:"acceptContact",input:({context:e,event:s})=>({service:e.service,contactId:s.contactId,group:s.group}),onDone:{target:"ready",actions:["updateContactInList","notifyContactUpdated"]},onError:{target:"ready",actions:["assignError","logError"]}}},rejecting:{invoke:{src:"rejectContact",input:({context:e,event:s})=>({service:e.service,contactId:s.contactId}),onDone:{target:"ready",actions:["removeContactFromList","notifyContactDeleted"]},onError:{target:"ready",actions:["assignError","logError"]}}},cancelling:{invoke:{src:"cancelOutgoing",input:({context:e,event:s})=>({service:e.service,contactId:s.contactId}),onDone:{target:"ready",actions:["removeContactFromList","notifyContactDeleted"]},onError:{target:"ready",actions:["assignError","logError"]}}},deleting:{invoke:{src:"deleteContact",input:({context:e,event:s})=>({service:e.service,contactId:s.contactId}),onDone:{target:"ready",actions:["removeContactFromList","notifyContactDeleted"]},onError:{target:"ready",actions:["assignError","logError"]}}},blocking:{invoke:{src:"deleteAndBlockContact",input:({context:e,event:s})=>({service:e.service,contactId:s.contactId}),onDone:{target:"ready",actions:["removeContactFromList","clearActiveContactIfDeleted","notifyContactDeleted"]},onError:{target:"ready",actions:["assignError","logError"]}}},updatingGroup:{invoke:{src:"updateGroup",input:({context:e,event:s})=>({service:e.service,contactId:s.contactId,group:s.group}),onDone:{target:"ready",actions:["updateContactInList","notifyContactUpdated"]},onError:{target:"ready",actions:["assignError","logError"]}}},error:{on:{RETRY:{target:"loading",actions:"clearError"}}}}})}const Cn={id:"contacts",name:"Contacts",version:"1.0.0",dependencies:["persistence","signaling"],async onMount(n){const{actorRegistry:t,eventBus:e}=n;console.log("ðŸŽ¯ CONTACTS FEATURE: onMount called!"),console.log("ðŸ“‡ Mounting Contacts feature...");let s=null,r=null,o=null,i=null;try{o=new Sn,await o.init(),console.log("âœ… Contacts repository initialized")}catch(p){console.error("âŒ Failed to initialize repository:",p);return}const a=p=>{if(console.log("ðŸŽ¯ CONTACTS: startActor called, actor existing?",s?"yes":"no"),s){console.log("ðŸŽ¯ CONTACTS: Actor already exists, returning");return}console.log("ðŸ“‡ Starting Contacts actor..."),r=new En(o,p,e);const g=An({service:r,eventBus:e});s=T(g),s.start(),t.register("contacts",s),i=()=>{console.log("ðŸ“‡ CONTACTS_RELOAD_REQUESTED received, sending RELOAD to actor"),s&&s.send({type:"RELOAD"})},e.on("CONTACTS_RELOAD_REQUESTED",i),console.log("ðŸ“¡ Dispatching CONTACTS_READY event"),console.log("âœ… Actor before dispatch:",s?"exists":"NULL"),e.dispatch({type:"CONTACTS_READY",actor:s}),console.log("âœ… Contacts actor started")},c=()=>{s&&(console.log("ðŸ“‡ Stopping Contacts actor..."),i&&(e.off("CONTACTS_RELOAD_REQUESTED",i),i=null),s.stop(),t.unregister("contacts"),s=null,r=null,console.log("ðŸ”Œ Contacts actor stopped"))},l=p=>{console.log("ðŸŽ¯ CONTACTS: SIGNALING_READY received in onSignalingReady"),console.log("ðŸ“‡ SIGNALING_READY received");const g=p.actor||t.get("signaling");g?(console.log("ðŸŽ¯ CONTACTS: Got signaling actor, calling startActor"),a(g)):console.error("ðŸŽ¯ CONTACTS: No signaling actor found!")};e.on("SIGNALING_READY",l);const h=p=>{s&&s.send(p)},d=["SIGNALING_INVITE_RECEIVED","SIGNALING_INVITE_ACCEPTED","SIGNALING_INVITE_REJECTED","SIGNALING_CONTACT_DELETED","SIGNALING_CONTACT_BLOCKED","SIGNALING_PROFILE_UPDATED"];for(const p of d)e.on(p,h);const u=t.get("signaling");return u?(console.log("ðŸŽ¯ CONTACTS: Signaling already available, starting actor"),console.log("ðŸ“‡ Signaling already available, starting actor"),a(u)):console.log("ðŸŽ¯ CONTACTS: Signaling not yet available, waiting for SIGNALING_READY"),console.log("âœ… Contacts feature mounted (waiting for signaling)"),{getActor:()=>s,cleanup:async()=>{e.off("SIGNALING_READY",l);for(const p of d)e.off(p,h);c(),console.log("ðŸ”Œ Contacts feature unmounted")}}}},In="modulepreload",kn=function(n,t){return new URL(n,t).href},Ie={},te=function(t,e,s){let r=Promise.resolve();if(e&&e.length>0){let l=function(h){return Promise.all(h.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const i=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),c=a?.nonce||a?.getAttribute("nonce");r=l(e.map(h=>{if(h=kn(h,s),h in Ie)return;Ie[h]=!0;const d=h.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(s)for(let g=i.length-1;g>=0;g--){const v=i[g];if(v.href===h&&(!d||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${h}"]${u}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":In,d||(p.as="script"),p.crossOrigin="",p.href=h,c&&p.setAttribute("nonce",c),document.head.appendChild(p),d)return new Promise((g,v)=>{p.addEventListener("load",g),p.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${h}`)))})}))}function o(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return r.then(i=>{for(const a of i||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})};function Tn({authActor:n}){return P({actions:{navigateToSettings:m({currentScreen:"settings",activeContactId:null}),navigateToContacts:m({currentScreen:"contacts",activeContactId:null}),navigateToChat:m(({event:t})=>({currentScreen:"chat",activeContactId:t.contactId||null})),clearActiveContact:m({activeContactId:null,currentScreen:"contacts"}),updateAuthState:m(({event:t})=>({isAuthenticated:t.isAuthenticated,username:t.username})),logScreenChange:({context:t})=>{console.log("ðŸ“± Screen changed:",t.currentScreen,{activeContact:t.activeContactId?.slice(0,16)||null})}},guards:{isAuthenticated:({context:t})=>t.isAuthenticated,isNotAuthenticated:({event:t})=>!t.isAuthenticated,eventIsAuthenticated:({event:t})=>t.isAuthenticated}}).createMachine({id:"shell",initial:"loading",context:{authActor:n,currentScreen:"settings",activeContactId:null,isAuthenticated:!1,username:null},states:{loading:{always:[{guard:"isAuthenticated",target:"authenticated"},{target:"guest"}]},guest:{on:{AUTH_STATE_CHANGED:{actions:"updateAuthState",target:"authenticated",guard:"eventIsAuthenticated"}}},authenticated:{initial:"idle",on:{AUTH_STATE_CHANGED:[{actions:"updateAuthState",target:"guest",guard:"isNotAuthenticated"},{actions:"updateAuthState"}],NAVIGATE_TO_SETTINGS:{actions:["navigateToSettings","logScreenChange"]},NAVIGATE_TO_CONTACTS:{actions:["navigateToContacts","logScreenChange"]},NAVIGATE_TO_CHAT:{actions:["navigateToChat","logScreenChange"]},OPEN_CHAT:{actions:["navigateToChat","logScreenChange"]},CLOSE_CHAT:{actions:["clearActiveContact","logScreenChange"]}},states:{idle:{}}}}})}const $n={id:"shell",name:"Shell",version:"1.0.0",dependencies:["auth"],ui:{main:"app-shell"},async onMount(n){console.log("ðŸš Mounting Shell feature...");const t=n.featureRegistry.getMountResult("auth");if(!t?.actor)throw new Error("Auth actor not available");const e=t.actor,s=Tn({authActor:e}),r=T(s),o=e.getSnapshot();r.send({type:"AUTH_STATE_CHANGED",isAuthenticated:o.value==="authenticated",username:o.context.username}),r.start();const i=e.subscribe(c=>{r.send({type:"AUTH_STATE_CHANGED",isAuthenticated:c.value==="authenticated",username:c.context.username})});n.actorRegistry&&n.actorRegistry.register("shell",r,{type:"feature",feature:"shell"}),await te(()=>Promise.resolve().then(()=>Gn),void 0,import.meta.url);const a=document.getElementById("app");if(a){a.innerHTML="";const c=document.createElement("app-shell");c.authActor=e,c.shellActor=r,c.featureRegistry=n.featureRegistry,c.actorRegistry=n.actorRegistry,c.eventBus=n.eventBus,a.appendChild(c)}return console.log("âœ… Shell feature mounted"),{actor:r,element:document.querySelector("app-shell"),cleanup:()=>{i.unsubscribe()}}},async onUnmount(n){document.querySelector("app-shell")?.remove(),n.cleanup&&n.cleanup(),n.actor&&n.actor.stop(),console.log("ðŸš Shell feature unmounted")}};async function Dn(){console.log("ðŸš€ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."),console.log("ðŸ“‹ Registering features..."),k.register(kr),console.log("  âœ… persistence registered"),k.register(Rr),console.log("  âœ… identity registered"),k.register(pn),console.log("  âœ… auth registered"),k.register(vn),console.log("  âœ… settings registered"),k.register(_n),console.log("  âœ… signaling registered"),k.register(Cn),console.log("  âœ… contacts registered"),k.register($n),console.log("  âœ… shell registered"),console.log("ðŸ“‹ All features registered:",k.getAll().map(e=>e.id));const n={eventBus:L,actorRegistry:ds,featureRegistry:k};Ar(n);const t=T(Cr,{input:n});t.start(),t.subscribe(e=>{console.log("ðŸ“± App state:",e.value),e.matches("ready")&&(console.log("âœ… App reached ready state"),L.dispatch({type:"APP_READY"},"HIGH")),e.matches("error")&&console.error("ðŸ’¥ App error:",e.context.error)});try{await Rn(t,e=>e.matches("ready"),3e4),console.log("âœ… Application ready!")}catch(e){console.error("âŒ App failed to reach ready state:",e)}return typeof window<"u"&&(window.appContext=n,window.appActor=t),{appActor:t,context:n}}function Rn(n,t,e=3e4){return new Promise((s,r)=>{const o=setTimeout(()=>{i.unsubscribe(),r(new Error(`Timeout waiting for state after ${e}ms`))},e);if(t(n.getSnapshot())){clearTimeout(o),s();return}const i=n.subscribe(a=>{t(a)&&(clearTimeout(o),i.unsubscribe(),s())})})}document.documentElement.lang="ru";Dn().catch(n=>{console.error("Bootstrap failed:",n),document.getElementById("app").innerHTML=`
        <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: #f5f5f5;
        ">
            <div style="
                background: white;
                padding: 2rem;
                border-radius: 16px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            ">
                <h2 style="color: #dc3545; margin: 0 0 1rem 0;">
                    âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°
                </h2>
                <pre style="
                    text-align: left;
                    background: #f8f9fa;
                    padding: 1rem;
                    border-radius: 8px;
                    overflow: auto;
                    font-size: 0.85rem;
                ">${n.message}

${n.stack}</pre>
                <button 
                    onclick="location.reload()" 
                    style="
                        margin-top: 1rem;
                        padding: 0.75rem 1.5rem;
                        background: #6366f1;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 1rem;
                    "
                >
                    ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ
                </button>
            </div>
        </div>
    `});const On=b`
	:host {
		display: block;
		height: 100dvh;
		background: var(--color-bg);
	}

	.app-container {
		display: flex;
		height: 100dvh;
		overflow: hidden;
	}

	.main-content {
		flex: 1;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	.content-area {
		flex: 1;
		overflow-y: auto;
		padding: var(--space-l);
	}

	@media (max-width: 768px) {
		.content-area {
			padding: var(--space-m);
		}
	}
`;class Nn extends w{static properties={message:{type:String}};static styles=[es,b`
			:host {
				display: flex;
				align-items: center;
				justify-content: center;
				height: 100dvh;
				background: var(--color-bg);
			}

			.container {
				text-align: center;
			}

			.message {
				margin-top: var(--space-m);
				color: var(--color-text-muted);
			}
		`];constructor(){super(),this.message="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."}render(){return f`
			<div class="container">
				<div class="spinner"></div>
				<p class="message">${this.message}</p>
			</div>
		`}}customElements.define("loading-screen",Nn);class Pn extends w{static properties={authActor:{type:Object}};static styles=b`
		:host {
			display: flex;
			align-items: center;
			justify-content: center;
			min-height: 100dvh;
			background: var(--gradient-auth);
		}
	`;render(){return te(()=>Promise.resolve().then(()=>un),void 0,import.meta.url),f` <auth-screen .actor=${this.authActor}></auth-screen> `}}customElements.define("auth-wrapper",Pn);class ee extends w{static properties={currentScreen:{type:String}};static styles=[q,b`
			:host {
				display: block;
			}

			.top-bar {
				padding: var(--space-m) var(--space-l);
				background: var(--color-surface);
				border-bottom: 1px solid var(--color-border);
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.screen-title {
				font-size: var(--text-xl);
				font-weight: 600;
				color: var(--color-text-main);
				margin: 0;
			}
		`];static TITLES={settings:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",contactsList:"ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹",chat:"Ð§Ð°Ñ‚"};render(){const t=ee.TITLES[this.currentScreen]||"Chat App";return f`
			<div class="top-bar">
				<h1 class="screen-title">${t}</h1>
				<button class="btn btn--secondary" @click=${this._handleLogout}>
					Ð’Ñ‹Ð¹Ñ‚Ð¸
				</button>
			</div>
		`}_handleLogout(){confirm("Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°?")&&this.dispatchEvent(new CustomEvent("logout",{bubbles:!0,composed:!0}))}}customElements.define("top-bar",ee);class Un extends w{static properties={open:{type:Boolean,reflect:!0},groups:{type:Array},loading:{type:Boolean},error:{type:String},currentUserId:{type:String}};static styles=b`
		:host {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			z-index: 1000;
			align-items: center;
			justify-content: center;
		}

		:host([open]) {
			display: flex;
		}

		.overlay {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.5);
			backdrop-filter: blur(4px);
		}

		.dialog {
			position: fixed;
			left: 50%;
			top: 2rem;
			transform: translateX(-50%);
			background: var(--color-surface);
			border-radius: var(--radius-l);
			box-shadow: var(--shadow-lg);
			width: 90%;
			max-width: 500px;
			max-height: 90vh;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		.dialog-header {
			padding: var(--space-l);
			border-bottom: 1px solid var(--border-color);
		}

		.dialog-title {
			font-size: 1.25rem;
			font-weight: 600;
			margin: 0;
		}

		.dialog-body {
			padding: var(--space-l);
			overflow-y: auto;
		}

		.form-group {
			margin-bottom: var(--space-m);
		}

		.form-label {
			display: block;
			font-weight: 500;
			font-size: 0.875rem;
			margin-bottom: var(--space-xs);
			color: var(--color-text-main);
		}

		.form-input,
		.form-textarea {
			width: calc(99% - var(--space-l));
			padding: var(--space-s);
			border: 1px solid var(--border-color);
			border-radius: var(--radius-m);
			font-size: 0.9375rem;
			font-family: inherit;
			background: var(--color-bg);
			color: var(--color-text-main);
			transition: border-color var(--transition-fast);
		}

		.form-input:focus,
		.form-textarea:focus {
			outline: none;
			border-color: var(--color-primary);
			box-shadow: 0 0 0 3px var(--color-primary-soft);
		}

		.form-textarea {
			resize: vertical;
			min-height: 120px;
			font-family: var(--font-mono);
			font-size: 0.8125rem;
		}

		.form-hint {
			font-size: 0.8125rem;
			color: var(--color-text-muted);
			margin-top: var(--space-xs);
		}

		.error-message {
			background: var(--color-danger-soft);
			color: var(--color-danger);
			padding: var(--space-s);
			border-radius: var(--radius-m);
			font-size: 0.875rem;
			margin-bottom: var(--space-m);
		}

		.dialog-footer {
			padding: var(--space-m) var(--space-l);
			border-top: 1px solid var(--border-color);
			display: flex;
			gap: var(--space-s);
			justify-content: flex-end;
		}

		.btn {
			padding: var(--space-xs) var(--space-m);
			border: none;
			border-radius: var(--radius-m);
			font-weight: 500;
			font-size: 0.9375rem;
			cursor: pointer;
			transition: all var(--transition-fast);
		}

		.btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.btn-secondary {
			background: var(--color-surface-raised);
			color: var(--color-text-main);
		}

		.btn-secondary:hover:not(:disabled) {
			background: var(--color-bg-hover);
		}

		.btn-primary {
			background: var(--color-primary);
			color: var(--color-white);
		}

		.btn-primary:hover:not(:disabled) {
			background: var(--color-primary-dark);
		}

		.spinner {
			display: inline-block;
			width: 16px;
			height: 16px;
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-radius: 50%;
			border-top-color: white;
			animation: spin 0.6s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}
	`;constructor(){super(),this.open=!1,this.groups=[],this.loading=!1,this.error=null}_parsePublicKey(t){if(!t||typeof t!="string")throw new Error("Invalid input");try{return JSON.parse(t)}catch{}const e=s=>s.replace(/-/g,"+").replace(/_/g,"/");try{let s=t.trim();for(s=e(s);s.length%4!==0;)s+="=";const r=atob(s),o=new Uint8Array(Array.from(r).map(a=>a.charCodeAt(0))),i=new TextDecoder().decode(o);return JSON.parse(i)}catch{}throw new Error("Invalid public key")}_handleOverlayClick(t){t.target===t.currentTarget&&this._close()}_close(){this.open=!1,this.error=null;const t=this.shadowRoot?.querySelector("form");t&&t.reset(),this.dispatchEvent(new CustomEvent("dialog-close"))}_handleSubmit(t){t.preventDefault();const e=new FormData(t.target),s=e.get("publicKey").trim(),r=e.get("group")?.trim()||"Default";if(!s){this.error="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ";return}let o;try{o=this._parsePublicKey(s)}catch{this.error="ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð°";return}console.log("ðŸ” Parsed key:",JSON.stringify(o,null,2));const i=o?.uid||o?.u;if(!i){this.error="ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ userId",console.error("âŒ No uid in parsed key:",o);return}if(this.currentUserId&&i===this.currentUserId){this.error="Ð’Ñ‹ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ°Ð¼Ð¾Ð³Ð¾ ÑÐµÐ±Ñ",console.warn("âš ï¸ User trying to add themselves");return}console.log("âœ… Extracted userId:",i.slice(0,16)+"..."),this.dispatchEvent(new CustomEvent("add-contact",{detail:{userId:i,exchangePublicKey:o,group:r},bubbles:!0,composed:!0})),this._close()}render(){return f`
			<div class="overlay" @click=${this._handleOverlayClick}>
				<div class="dialog" @click=${t=>t.stopPropagation()}>
					<div class="dialog-header">
						<h2 class="dialog-title">Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚</h2>
					</div>

					<form class="dialog-body" @submit=${this._handleSubmit}>
						${this.error?f`<div class="error-message">${this.error}</div>`:""}

						<div class="form-group">
							<label class="form-label" for="publicKey">
								ÐšÐ»ÑŽÑ‡ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ
							</label>
							<textarea
								id="publicKey"
								name="publicKey"
								class="form-textarea"
								placeholder="Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ»ÑŽÑ‡ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ, Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ð¹ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"
								required
								?disabled=${this.loading}
							></textarea>
							<div class="form-hint">
								ÐŸÐ¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¹ ÐºÐ»ÑŽÑ‡ Ð¸Ð· ÐÐ°ÑÑ‚Ñ€Ð¾ÐµÐº â†’ ÐšÐ»ÑŽÑ‡
								Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ
							</div>
						</div>

						<div class="form-group">
							<label class="form-label" for="group">
								Ð“Ñ€ÑƒÐ¿Ð¿Ð° (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)
							</label>
							<input
								list="groups"
								id="group"
								name="group"
								class="form-input"
								placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ"
								value="Default"
								?disabled=${this.loading}
							/>
							<datalist id="groups">
								${this.groups.map(t=>f`<option value=${t}></option>`)}
							</datalist>
						</div>

						<div class="dialog-footer">
							<button
								type="button"
								class="btn btn-secondary"
								@click=${this._close}
								?disabled=${this.loading}
							>
								ÐžÑ‚Ð¼ÐµÐ½Ð°
							</button>
							<button
								type="submit"
								class="btn btn-primary"
								?disabled=${this.loading}
							>
								${this.loading?f`<span class="spinner"></span>`:"ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ"}
							</button>
						</div>
					</form>
				</div>
			</div>
		`}}customElements.define("add-contact-dialog",Un);class Ln extends w{static properties={contact:{type:Object}};static styles=b`
		:host {
			display: block;
		}

		.contact-item {
			display: flex;
			align-items: center;
			gap: var(--space-3, 12px);
			padding: var(--space-3, 12px) var(--space-4, 16px);
			cursor: pointer;
			transition: background 0.15s;
			position: relative;
			border-bottom: 1px solid var(--border-color, #e5e5e5);
		}

		.contact-item:hover {
			background: var(--color-surface-raised, #f5f5f5);
		}

		.contact-item.active {
			background: var(--color-primary-soft, rgba(122, 92, 255, 0.08));
			border-left: 3px solid var(--color-primary, #7a5cff);
		}

		.avatar {
			width: 44px;
			height: 44px;
			border-radius: 50%;
			background: var(--color-primary, #7a5cff);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: 600;
			font-size: 1.125rem;
			flex-shrink: 0;
			position: relative;
			overflow: hidden;
		}

		.avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.online-indicator {
			position: absolute;
			bottom: 0;
			right: 0;
			width: 12px;
			height: 12px;
			background: var(--color-success, #34d399);
			border: 2px solid var(--color-surface, #fff);
			border-radius: 50%;
		}

		.contact-info {
			flex: 1;
			min-width: 0;
		}

		.contact-name {
			font-weight: 500;
			font-size: 0.9375rem;
			margin-bottom: 2px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			color: var(--color-text-main, #1a1a1a);
		}

		.contact-bio {
			font-size: 0.8125rem;
			color: var(--color-text-muted, #666);
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.last-message {
			font-size: 0.8125rem;
			color: var(--color-text-muted, #666);
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.last-message.unread {
			font-weight: 600;
			color: var(--color-text-main, #1a1a1a);
		}

		.pending-label {
			font-size: 0.75rem;
			color: var(--color-warning, #f59e0b);
			font-style: italic;
		}

		.contact-meta {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 4px;
			flex-shrink: 0;
		}

		.timestamp {
			font-size: 0.75rem;
			color: var(--color-text-muted, #666);
		}

		.unread-badge {
			background: var(--color-primary, #7a5cff);
			color: white;
			font-size: 0.6875rem;
			font-weight: 600;
			padding: 2px 6px;
			border-radius: 10px;
			min-width: 20px;
			text-align: center;
		}

		/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */
		.pending-actions {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(4px);
			display: flex;
			align-items: center;
			justify-content: center;
			gap: var(--space-2, 8px);
			opacity: 0;
			transition: opacity 0.2s;
			pointer-events: none;
		}

		.contact-item:hover .pending-actions {
			opacity: 1;
			pointer-events: all;
		}

		.action-btn {
			padding: 8px 16px;
			border: none;
			border-radius: var(--radius-m, 8px);
			font-weight: 500;
			font-size: 0.875rem;
			cursor: pointer;
			transition: all 0.2s;
		}

		.action-btn.accept {
			background: var(--color-success, #34d399);
			color: white;
		}

		.action-btn.accept:hover {
			background: #2eb88a;
		}

		.action-btn.reject {
			background: var(--color-danger, #ef4444);
			color: white;
		}

		.action-btn.reject:hover {
			background: #dc2626;
		}

		.action-btn.cancel {
			background: var(--color-surface, #f5f5f5);
			color: var(--color-text-main, #1a1a1a);
			border: 1px solid var(--border-color, #e5e5e5);
		}

		.action-btn.cancel:hover {
			background: var(--color-bg-hover, #eee);
		}
	`;constructor(){super(),this.contact=null}_getInitials(t){return t?t.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2):"?"}_formatTimestamp(t){if(!t)return"";const s=Date.now()-t,r=Math.floor(s/6e4),o=Math.floor(s/36e5),i=Math.floor(s/864e5);return r<1?"ÑÐµÐ¹Ñ‡Ð°Ñ":r<60?`${r}Ð¼`:o<24?`${o}Ñ‡`:i<7?`${i}Ð´`:new Date(t).toLocaleDateString("ru-RU",{day:"numeric",month:"short"})}_handleClick(t){t.target.closest(".pending-actions")||this.dispatchEvent(new CustomEvent("contact-click",{detail:{contact:this.contact},bubbles:!0,composed:!0}))}_handleAccept(t){t.stopPropagation(),this.dispatchEvent(new CustomEvent("contact-accept",{detail:{contact:this.contact},bubbles:!0,composed:!0}))}_handleReject(t){t.stopPropagation(),this.dispatchEvent(new CustomEvent("contact-reject",{detail:{contact:this.contact},bubbles:!0,composed:!0}))}_handleCancel(t){t.stopPropagation(),this.dispatchEvent(new CustomEvent("contact-cancel",{detail:{contact:this.contact},bubbles:!0,composed:!0}))}render(){if(!this.contact)return f``;const{username:t,avatar:e,bio:s,isOnline:r,lastMessage:o,unreadCount:i,lastSeen:a,status:c,addedAt:l}=this.contact,h=c==="pending_incoming",d=c==="pending_outgoing",u=c==="accepted",p=t||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ";return f`
			<div class="contact-item" @click=${this._handleClick}>
				<div class="avatar">
					${e?f`<img src=${e} alt=${p} />`:f`${this._getInitials(p)}`}
					${r?f`<div class="online-indicator"></div>`:""}
				</div>

				<div class="contact-info">
					<div class="contact-name">${p}</div>

					${u&&o?f`
								<div class="last-message ${i>0?"unread":""}">
									${o.text}
								</div>
						  `:u&&s?f`<div class="contact-bio">${s}</div>`:h?f`<div class="pending-label">Ð¥Ð¾Ñ‡ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ñ</div>`:d?f`<div class="pending-label">ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð°...</div>`:f`<div class="contact-bio">${s||""}</div>`}
				</div>

				<div class="contact-meta">
					${o?f`<div class="timestamp">
								${this._formatTimestamp(o.timestamp)}
						  </div>`:a?f`<div class="timestamp">
								${this._formatTimestamp(a)}
						  </div>`:l?f`<div class="timestamp">
								${this._formatTimestamp(l)}
						  </div>`:""}
					${i>0?f`<div class="unread-badge">${i}</div>`:""}
				</div>

				\x3C!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² -->
				${h?f`
							<div class="pending-actions">
								<button class="action-btn accept" @click=${this._handleAccept}>
									ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ
								</button>
								<button class="action-btn reject" @click=${this._handleReject}>
									ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ
								</button>
							</div>
					  `:""}

				\x3C!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð´Ð»Ñ Ð¸ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² -->
				${d?f`
							<div class="pending-actions">
								<button class="action-btn cancel" @click=${this._handleCancel}>
									ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ
								</button>
							</div>
					  `:""}
			</div>
		`}}customElements.define("contact-item",Ln);class Mn extends w{static properties={profile:{type:Object},username:{type:String},currentUserId:{type:String},contactsActor:{type:Object},eventBus:{type:Object},activeContactId:{type:String},_showAddDialog:{state:!0},_contacts:{state:!0}};static styles=[ts,q,b`
			:host {
				display: flex;
				flex-direction: column;
				width: 250px;
				min-width: 250px;
				background: var(--color-surface);
				border-right: 1px solid var(--color-border);
				overflow: hidden;
			}

			/* User Section */
			.user-section {
				padding: var(--space-m);
				border-bottom: 1px solid var(--color-border);
			}

			.user-profile {
				display: flex;
				align-items: center;
				gap: var(--space-s);
				margin-bottom: var(--space-s);
			}

			.user-info {
				flex: 1;
				min-width: 0;
			}

			.user-name {
				font-weight: 600;
				color: var(--color-text-main);
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.user-bio {
				font-size: var(--text-sm);
				color: var(--color-text-muted);
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.settings-link {
				display: block;
				padding: var(--space-xs) var(--space-s);
				color: var(--color-primary);
				text-decoration: none;
				font-size: var(--text-sm);
				border-radius: var(--radius-m);
				transition: background var(--transition-fast);
			}

			.settings-link:hover {
				background: var(--color-bg-hover);
			}

			/* Contacts Section */
			.contacts-section {
				flex: 1;
				overflow-y: auto;
				padding: var(--space-s);
			}

			.section-header {
				font-size: var(--text-xs);
				font-weight: 600;
				color: var(--color-text-muted);
				text-transform: uppercase;
				letter-spacing: 0.5px;
				padding: var(--space-xs) var(--space-s);
				margin-bottom: var(--space-xs);
			}

			.group-header {
				font-size: var(--text-xs);
				font-weight: 600;
				color: var(--color-text-muted);
				padding: var(--space-xs) var(--space-s);
				margin-top: var(--space-s);
				border-top: 1px solid var(--color-border);
			}

			.group-header:first-child {
				margin-top: 0;
				border-top: none;
			}

			.empty-state {
				padding: var(--space-m);
				text-align: center;
				color: var(--color-text-muted);
				font-size: var(--text-sm);
			}

			.contacts-list {
				display: flex;
				flex-direction: column;
				gap: var(--space-xs);
				margin-bottom: var(--space-s);
			}

			.pending-badge {
				background: var(--color-warning, #f59e0b);
				color: white;
				font-size: 0.6875rem;
				padding: 2px 6px;
				border-radius: 10px;
				margin-left: var(--space-xs);
			}

			contact-item {
				cursor: pointer;
			}
			contact-item.active {
				background: var(--color-primary-soft, rgba(122, 92, 255, 0.1));
				border-radius: var(--radius-m);
			}

			.add-contact-btn {
				width: 100%;
				margin-top: var(--space-s);
			}

			@media (max-width: 768px) {
				:host {
					width: 200px;
					min-width: 200px;
				}
			}
		`];constructor(){super(),this._showAddDialog=!1,this._contacts=[],this._contactsState=null,this._contactsSubscription=null}connectedCallback(){super.connectedCallback(),this.contactsActor&&this._subscribeToContacts()}disconnectedCallback(){super.disconnectedCallback(),this._contactsSubscription&&this._contactsSubscription.unsubscribe()}updated(t){super.updated(t),t.has("contactsActor")&&console.log("ðŸ“‡ sidebar-panel: contactsActor changed to:",this.contactsActor?"exists":"NULL"),t.has("contactsActor")&&this.contactsActor&&!this._contactsSubscription&&(console.log("ðŸ“‡ sidebar-panel: subscribing to contacts"),this._subscribeToContacts())}_subscribeToContacts(){if(!this.contactsActor){console.warn("âš ï¸ sidebar-panel: contactsActor not available");return}console.log("ðŸ“‡ sidebar-panel: subscribing to contactsActor"),this._contactsSubscription=this.contactsActor.subscribe(t=>{console.log("ðŸ“‡ sidebar-panel: contacts snapshot state:",t.value),console.log("ðŸ“‡ sidebar-panel: contacts count:",t.context?.contacts?.length),this._contactsState=t,Array.isArray(t.context?.contacts)?this._contacts=t.context.contacts:(console.warn("âš ï¸ sidebar-panel: contacts is not an array:",t.context?.contacts),this._contacts=[]),t.context?.activeContactId!==void 0&&(this.activeContactId=t.context.activeContactId),this.requestUpdate()})}_groupContacts(){const t={incoming:[],outgoing:[],accepted:[]};return this._contacts.forEach(e=>{e.status==="pending_incoming"?t.incoming.push(e):e.status==="pending_outgoing"?t.outgoing.push(e):e.status==="accepted"&&t.accepted.push(e)}),t.accepted.sort((e,s)=>{const r=e.lastMessage?.timestamp||e.lastSeen||0;return(s.lastMessage?.timestamp||s.lastSeen||0)-r}),t}get _displayName(){return this.profile?.displayName||this.username||"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ"}get _bio(){return this.profile?.bio||"ÐšÑ€Ð°Ñ‚ÐºÐ¾ Ð¾ ÑÐµÐ±Ðµ"}get _avatarLetter(){return this._displayName[0]?.toUpperCase()||"?"}render(){const t=this._groupContacts(),e=this._contacts.length>0;return f`
			\x3C!-- User Section -->
			<div class="user-section">
				<div class="user-profile">
					<div class="avatar">
						${this.profile?.avatar?f`<img src=${this.profile.avatar} alt="ÐÐ²Ð°Ñ‚Ð°Ñ€" />`:this._avatarLetter}
					</div>
					<div class="user-info">
						<div class="user-name">${this._displayName}</div>
						<div class="user-bio">${this._bio}</div>
					</div>
				</div>
				<a href="#" class="settings-link" @click=${this._handleSettingsClick}>
					âš™ï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
				</a>
			</div>

			\x3C!-- Contacts Section -->
			<div class="contacts-section">
				<div class="section-header">ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹</div>

				${e?f`
							\x3C!-- Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ -->
							${t.incoming.length>0?f`
										<div class="group-header">
											ðŸ“¥ Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ
											<span class="pending-badge"
												>${t.incoming.length}</span
											>
										</div>
										<div class="contacts-list">
											${t.incoming.map(s=>f`
													<contact-item
														.contact=${s}
														@contact-accept=${this._handleContactAccept}
														@contact-reject=${this._handleContactReject}
													></contact-item>
												`)}
										</div>
								  `:""}

							\x3C!-- Ð˜ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ -->
							${t.outgoing.length>0?f`
										<div class="group-header">
											ðŸ“¤ Ð˜ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ðµ
											<span class="pending-badge"
												>${t.outgoing.length}</span
											>
										</div>
										<div class="contacts-list">
											${t.outgoing.map(s=>f`
													<contact-item
														.contact=${s}
														@contact-cancel=${this._handleContactCancel}
													></contact-item>
												`)}
										</div>
								  `:""}

							\x3C!-- ÐŸÑ€Ð¸Ð½ÑÑ‚Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ -->
							${t.accepted.length>0?f`
										<div class="group-header">
											ðŸ‘¥ ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ (${t.accepted.length})
										</div>
										<div class="contacts-list">
											${t.accepted.map(s=>f`
													<contact-item
														.contact=${s}
														@contact-click=${this._handleContactClick}
													></contact-item>
												`)}
										</div>
								  `:""}
					  `:f`<div class="empty-state">Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²</div>`}

				<button
					class="btn btn--primary add-contact-btn"
					@click=${this._handleAddContact}
				>
					âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚
				</button>

				<add-contact-dialog
					?open=${this._showAddDialog}
					.currentUserId=${this.currentUserId}
					@dialog-close=${()=>{console.log("ðŸ”µ Dialog close event"),this._showAddDialog=!1,this.requestUpdate()}}
					@add-contact=${this._handleAddContactSubmit}
				></add-contact-dialog>
			</div>
		`}_handleSettingsClick(t){t.preventDefault(),this.dispatchEvent(new CustomEvent("navigate-settings",{bubbles:!0,composed:!0}))}_handleAddContact(){console.log("ðŸ”µ _handleAddContact called"),this._showAddDialog=!0,this.requestUpdate()}_handleAddContactSubmit(t){const{userId:e,exchangePublicKey:s,username:r,group:o}=t.detail||{};if(!this.contactsActor){console.error("âŒ Contacts actor not available");return}console.log("ðŸ“‡ sidebar-panel: sending ADD_CONTACT",{userId:e?.slice(0,16)}),this.contactsActor.send({type:"ADD_CONTACT",data:{userId:e||null,exchangePublicKey:s||null,username:r||null,group:o||null}}),this._showAddDialog=!1}_handleContactAccept(t){const{contact:e}=t.detail;if(!this.contactsActor){console.error("âŒ Contacts actor not available");return}console.log("ðŸ“‡ sidebar-panel: accepting contact",e.id?.slice(0,16)),this.contactsActor.send({type:"ACCEPT_CONTACT",contactId:e.id,group:"Default"})}_handleContactReject(t){const{contact:e}=t.detail;if(!this.contactsActor){console.error("âŒ Contacts actor not available");return}console.log("ðŸ“‡ sidebar-panel: rejecting contact",e.id?.slice(0,16)),this.contactsActor.send({type:"REJECT_CONTACT",contactId:e.id})}_handleContactCancel(t){const{contact:e}=t.detail;if(!this.contactsActor){console.error("âŒ Contacts actor not available");return}console.log("ðŸ“‡ sidebar-panel: cancelling outgoing request",e.id?.slice(0,16)),this.contactsActor.send({type:"CANCEL_OUTGOING",contactId:e.id})}_handleContactClick(t){const{contact:e}=t.detail;console.log("ðŸ“‡ sidebar-panel: selecting contact",e.id?.slice(0,16)),this.contactsActor&&this.contactsActor.send({type:"SELECT_CONTACT",contactId:e.id}),this.dispatchEvent(new CustomEvent("open-chat",{detail:{contactId:e.id,contact:e},bubbles:!0,composed:!0}))}}customElements.define("sidebar-panel",Mn);class zn extends w{static styles=b`
		:host {
			display: block;
		}

		.placeholder {
			padding: var(--space-2xl);
			text-align: center;
			color: var(--color-text-muted);
		}

		h3 {
			margin: 0 0 var(--space-s);
			color: var(--color-text-main);
		}
	`;render(){return f`
			<div class="placeholder">
				<h3>ðŸ“‡ Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð²</h3>
				<p>Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÑƒÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ Ð²Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹</p>
			</div>
		`}}customElements.define("contacts-screen",zn);class jn extends w{static properties={contactId:{type:String}};static styles=b`
		:host {
			display: block;
		}

		.placeholder {
			padding: var(--space-2xl);
			text-align: center;
			color: var(--color-text-muted);
		}

		h3 {
			margin: 0 0 var(--space-s);
			color: var(--color-text-main);
		}

		.contact-id {
			font-family: var(--font-mono);
			font-size: var(--text-sm);
			background: var(--color-surface-raised);
			padding: var(--space-xs) var(--space-s);
			border-radius: var(--radius-m);
		}
	`;render(){return f`
			<div class="placeholder">
				<h3>ðŸ’¬ Ð§Ð°Ñ‚ Ñ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð¼</h3>
				<p>
					Contact ID:
					<span class="contact-id">${this.contactId||"Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½"}</span>
				</p>
			</div>
		`}}customElements.define("chat-screen",jn);class Bn extends w{static properties={contact:{type:Object},_showDeleteConfirm:{state:!0}};static styles=b`
		:host {
			display: flex;
			flex-direction: column;
			height: 100%;
			background: var(--color-bg, #fafafa);
		}

		/* Header */
		.chat-header {
			display: flex;
			align-items: center;
			gap: 16px;
			padding: 16px;
			background: var(--color-surface, #fff);
			border-bottom: 1px solid var(--border-color, #e5e5e5);
		}

		.avatar {
			width: 48px;
			height: 48px;
			border-radius: 50%;
			background: var(--color-primary, #7a5cff);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: 600;
			font-size: 1.25rem;
			flex-shrink: 0;
			overflow: hidden;
		}

		.avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.contact-info {
			flex: 1;
		}

		.contact-name {
			font-weight: 600;
			font-size: 1.125rem;
			color: var(--color-text-main, #1a1a1a);
		}

		.contact-status {
			font-size: 0.875rem;
			color: var(--color-text-muted, #666);
		}

		.contact-status.online {
			color: var(--color-success, #34d399);
		}

		.back-btn {
			display: none;
			padding: 8px;
			background: none;
			border: none;
			font-size: 1.25rem;
			cursor: pointer;
			border-radius: 50%;
			transition: background 0.2s;
		}

		.back-btn:hover {
			background: var(--color-bg-hover, #f0f0f0);
		}

		@media (max-width: 768px) {
			.back-btn {
				display: block;
			}
		}

		/* Messages area */
		.chat-messages {
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 32px;
			text-align: center;
		}

		.placeholder-icon {
			font-size: 4rem;
			margin-bottom: 16px;
			opacity: 0.5;
		}

		.placeholder-title {
			font-size: 1.25rem;
			font-weight: 600;
			color: var(--color-text-main, #1a1a1a);
			margin-bottom: 8px;
		}

		.placeholder-text {
			color: var(--color-text-muted, #666);
			font-size: 0.9375rem;
			max-width: 300px;
			line-height: 1.5;
		}

		.contact-bio {
			margin-top: 16px;
			padding: 12px 16px;
			background: var(--color-surface, #fff);
			border-radius: 12px;
			font-style: italic;
			color: var(--color-text-muted, #666);
			max-width: 280px;
		}

		/* Input area */
		.chat-input {
			padding: 16px;
			background: var(--color-surface, #fff);
			border-top: 1px solid var(--border-color, #e5e5e5);
		}

		.input-wrapper {
			display: flex;
			gap: 12px;
			align-items: center;
		}

		.input-field {
			flex: 1;
			padding: 12px 16px;
			background: var(--color-bg, #f5f5f5);
			border: 1px solid var(--border-color, #e5e5e5);
			border-radius: 24px;
			font-size: 0.9375rem;
			color: var(--color-text-main, #1a1a1a);
			outline: none;
			transition: border-color 0.2s;
		}

		.input-field:focus {
			border-color: var(--color-primary, #7a5cff);
		}

		.input-field::placeholder {
			color: var(--color-text-muted, #999);
		}

		.send-btn {
			width: 44px;
			height: 44px;
			border-radius: 50%;
			background: var(--color-primary, #7a5cff);
			color: white;
			border: none;
			font-size: 1.25rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background 0.2s, transform 0.1s;
		}

		.send-btn:hover {
			background: var(--color-primary-dark, #6b4ce6);
		}

		.send-btn:active {
			transform: scale(0.95);
		}

		.send-btn:disabled {
			background: var(--color-text-muted, #999);
			cursor: not-allowed;
		}

		/* Footer */
		.chat-footer {
			padding: 12px 16px;
			text-align: center;
			border-top: 1px solid var(--border-color, #e5e5e5);
			background: var(--color-surface, #fff);
		}

		.delete-link {
			color: var(--color-danger, #ef4444);
			text-decoration: none;
			font-size: 0.875rem;
			cursor: pointer;
			transition: opacity 0.2s;
			display: inline-flex;
			align-items: center;
			gap: 6px;
		}

		.delete-link:hover {
			opacity: 0.8;
			text-decoration: underline;
		}

		/* Delete confirmation */
		.delete-confirm {
			background: var(--color-danger-soft, #fee2e2);
			padding: 16px;
			margin: 16px;
			border-radius: 12px;
		}

		.delete-confirm-icon {
			font-size: 2rem;
			margin-bottom: 12px;
		}

		.delete-confirm-title {
			font-weight: 600;
			color: var(--color-danger, #ef4444);
			margin-bottom: 8px;
		}

		.delete-confirm-text {
			color: var(--color-text-main, #1a1a1a);
			font-size: 0.875rem;
			margin-bottom: 16px;
			line-height: 1.5;
		}

		.delete-confirm-actions {
			display: flex;
			gap: 12px;
			justify-content: center;
		}

		.btn {
			padding: 10px 20px;
			border: none;
			border-radius: 8px;
			font-weight: 500;
			font-size: 0.875rem;
			cursor: pointer;
			transition: all 0.2s;
		}

		.btn-danger {
			background: var(--color-danger, #ef4444);
			color: white;
		}

		.btn-danger:hover {
			background: #dc2626;
		}

		.btn-secondary {
			background: var(--color-surface, #fff);
			color: var(--color-text-main, #1a1a1a);
			border: 1px solid var(--border-color, #e5e5e5);
		}

		.btn-secondary:hover {
			background: var(--color-bg-hover, #f5f5f5);
		}

		/* Empty state */
		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			text-align: center;
			padding: 32px;
		}

		.empty-state-icon {
			font-size: 5rem;
			margin-bottom: 24px;
			opacity: 0.4;
		}

		.empty-state-title {
			font-size: 1.5rem;
			font-weight: 600;
			color: var(--color-text-main, #1a1a1a);
			margin-bottom: 8px;
		}

		.empty-state-text {
			color: var(--color-text-muted, #666);
			font-size: 1rem;
			max-width: 300px;
		}
	`;constructor(){super(),this.contact=null,this._showDeleteConfirm=!1}_getInitials(t){return t?t.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2):"?"}_formatLastSeen(t){if(!t)return"Ð±Ñ‹Ð»(Ð°) Ð´Ð°Ð²Ð½Ð¾";const s=Date.now()-t,r=Math.floor(s/6e4),o=Math.floor(s/36e5),i=Math.floor(s/864e5);return r<1?"Ð±Ñ‹Ð»(Ð°) Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾":r<60?`Ð±Ñ‹Ð»(Ð°) ${r} Ð¼Ð¸Ð½. Ð½Ð°Ð·Ð°Ð´`:o<24?`Ð±Ñ‹Ð»(Ð°) ${o} Ñ‡. Ð½Ð°Ð·Ð°Ð´`:i<7?`Ð±Ñ‹Ð»(Ð°) ${i} Ð´Ð½. Ð½Ð°Ð·Ð°Ð´`:`Ð±Ñ‹Ð»(Ð°) ${new Date(t).toLocaleDateString("ru-RU")}`}_handleBack(){this.dispatchEvent(new CustomEvent("close-chat",{bubbles:!0,composed:!0}))}_handleDeleteClick(){this._showDeleteConfirm=!0}_handleDeleteCancel(){this._showDeleteConfirm=!1}_handleDeleteConfirm(){this.dispatchEvent(new CustomEvent("delete-contact",{detail:{contactId:this.contact.id,block:!0},bubbles:!0,composed:!0})),this._showDeleteConfirm=!1}_handleInputKeydown(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this._handleSend())}_handleSend(){const t=this.shadowRoot?.querySelector(".input-field"),e=t?.value?.trim();e&&(this.dispatchEvent(new CustomEvent("send-message",{detail:{contactId:this.contact.id,text:e},bubbles:!0,composed:!0})),t.value="")}render(){if(!this.contact)return f`
				<div class="empty-state">
					<div class="empty-state-icon">ðŸ’¬</div>
					<div class="empty-state-title">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚</div>
					<div class="empty-state-text">
						Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° ÑÐ»ÐµÐ²Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
					</div>
				</div>
			`;const{username:t,avatar:e,bio:s,isOnline:r,lastSeen:o}=this.contact,i=t||"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ";return f`
			\x3C!-- Header -->
			<div class="chat-header">
				<button class="back-btn" @click=${this._handleBack}>â†</button>
				<div class="avatar">
					${e?f`<img src=${e} alt=${i} />`:this._getInitials(i)}
				</div>
				<div class="contact-info">
					<div class="contact-name">${i}</div>
					<div class="contact-status ${r?"online":""}">
						${r?"Ð¾Ð½Ð»Ð°Ð¹Ð½":this._formatLastSeen(o)}
					</div>
				</div>
			</div>

			\x3C!-- Delete confirmation overlay -->
			${this._showDeleteConfirm?f`
						<div class="delete-confirm">
							<div class="delete-confirm-icon">âš ï¸</div>
							<div class="delete-confirm-title">Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚?</div>
							<div class="delete-confirm-text">
								Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ
								<strong>${i}</strong>? <br /><br />
								ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð¸ Ð½Ðµ ÑÐ¼Ð¾Ð¶ÐµÑ‚ ÑÐ½Ð¾Ð²Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ð¼
								Ð·Ð°Ð¿Ñ€Ð¾Ñ. Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ.
							</div>
							<div class="delete-confirm-actions">
								<button
									class="btn btn-secondary"
									@click=${this._handleDeleteCancel}
								>
									ÐžÑ‚Ð¼ÐµÐ½Ð°
								</button>
								<button
									class="btn btn-danger"
									@click=${this._handleDeleteConfirm}
								>
									Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
								</button>
							</div>
						</div>
				  `:f`
						\x3C!-- Messages placeholder -->
						<div class="chat-messages">
							<div class="placeholder-icon">ðŸš€</div>
							<div class="placeholder-title">ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ!</div>
							<div class="placeholder-text">
								ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÐµÑ€Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ¿Ð¸ÑÐºÑƒ Ñ
								${i}
							</div>
							${s?f`<div class="contact-bio">"${s}"</div>`:""}
						</div>

						\x3C!-- Input -->
						<div class="chat-input">
							<div class="input-wrapper">
								<input
									type="text"
									class="input-field"
									placeholder="ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
									@keydown=${this._handleInputKeydown}
								/>
								<button class="send-btn" @click=${this._handleSend}>âž¤</button>
							</div>
						</div>

						\x3C!-- Footer with delete -->
						<div class="chat-footer">
							<a class="delete-link" @click=${this._handleDeleteClick}>
								ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚
							</a>
						</div>
				  `}
		`}}customElements.define("chat-placeholder",Bn);class ns extends w{static properties={authActor:{type:Object},shellActor:{type:Object},featureRegistry:{type:Object},actorRegistry:{type:Object},_authState:{state:!0},_shellState:{state:!0},_username:{state:!0},_currentScreen:{state:!0},_activeContactId:{state:!0},_activeContact:{state:!0},_profile:{state:!0},_userId:{state:!0},_contacts:{state:!0}};static styles=On;constructor(){super(),this._authState="initializing",this._shellState="loading",this._username=null,this._currentScreen="settings",this._activeContactId=null,this._activeContact=null,this._profile=null,this._userId=null,this._contacts=[],this._settingsActor=null,this._contactsActor=null,this._signalingActor=null,this._authSubscription=null,this._shellSubscription=null,this._settingsSubscription=null,this._contactsSubscription=null,this._signalingSubscription=null,this._onSettingsReady=this._onSettingsReady.bind(this),this._onContactsReady=this._onContactsReady.bind(this),this._onOpenChat=this._onOpenChat.bind(this)}connectedCallback(){super.connectedCallback(),this._subscribeToActors(),L.on("SETTINGS_READY",this._onSettingsReady),L.on("CONTACTS_READY",this._onContactsReady)}disconnectedCallback(){super.disconnectedCallback(),this._authSubscription?.unsubscribe(),this._shellSubscription?.unsubscribe(),this._settingsSubscription?.unsubscribe(),this._contactsSubscription?.unsubscribe(),this._signalingSubscription?.unsubscribe(),L.off("SETTINGS_READY",this._onSettingsReady),L.off("CONTACTS_READY",this._onContactsReady)}updated(t){(t.has("authActor")||t.has("shellActor"))&&this.authActor&&this.shellActor&&this._subscribeToActors(),(t.has("_activeContactId")||t.has("_contacts"))&&this._updateActiveContact()}_updateActiveContact(){if(!this._activeContactId||!this._contacts.length){this._activeContact=null;return}this._activeContact=this._contacts.find(t=>t.id===this._activeContactId)||null}_onSettingsReady(t){t.actor&&(console.log("ðŸš Shell: Settings actor ready"),this._connectToSettingsActor(t.actor))}_onContactsReady(t){console.log("ðŸš CONTACTS_READY received, event.actor:",t.actor?"exists":"NULL"),t.actor?(console.log("ðŸš Shell: Contacts actor ready"),this._connectToContactsActor(t.actor)):console.error("âŒ CONTACTS_READY event but actor is null")}_onOpenChat(t){const{contactId:e,contact:s}=t.detail||{};console.log("ðŸš Shell: Opening chat with",e?.slice(0,16)),e&&(this._activeContactId=e,s&&(this._activeContact=s),this._currentScreen="chat",this.shellActor?.send({type:"NAVIGATE_TO_CHAT",contactId:e}))}_subscribeToActors(){if(this.authActor){this._authSubscription?.unsubscribe();const t=this.authActor.getSnapshot();this._authState=t.value,this._username=t.context.username,this._authSubscription=this.authActor.subscribe(e=>{this._authState=e.value,this._username=e.context.username})}this.shellActor&&(this._shellSubscription?.unsubscribe(),this._updateFromShellSnapshot(this.shellActor.getSnapshot()),this._shellSubscription=this.shellActor.subscribe(t=>{this._updateFromShellSnapshot(t)})),this._tryConnectInitialSettings(),this._tryConnectSignaling()}_tryConnectSignaling(){if(this._signalingActor)return;const t=this.featureRegistry?.getMountResult("signaling");if(!t)return;const e=t.actor||t.getActor?.()||null;e&&this._connectToSignalingActor(e)}_connectToSignalingActor(t){if(this._signalingActor===t)return;this._signalingActor=t,this._signalingSubscription?.unsubscribe();const e=t.getSnapshot();this._userId=e.context.userId,this._signalingSubscription=t.subscribe(s=>{this._userId=s.context.userId,this.requestUpdate()})}_updateFromShellSnapshot(t){let e=t.value;typeof e=="object"&&e.authenticated&&(e=`authenticated.${e.authenticated}`),this._shellState=e,this._currentScreen=t.context.currentScreen,this._activeContactId=t.context.activeContactId}_tryConnectInitialSettings(){if(this._settingsActor)return;const t=this.featureRegistry?.getMountResult("settings");if(!t)return;const e=t.actor||t.getActor?.()||null;e&&this._connectToSettingsActor(e)}_connectToSettingsActor(t){if(this._settingsActor===t)return;this._settingsActor=t,this._settingsSubscription?.unsubscribe();const e=t.getSnapshot();this._profile=e.context.profile,this._settingsSubscription=t.subscribe(s=>{this._profile=s.context.profile,this.requestUpdate()}),this.requestUpdate()}_connectToContactsActor(t){if(console.log("ðŸš _connectToContactsActor called, actor:",t?"exists":"NULL"),this._contactsActor===t){console.log("ðŸš Same actor, skipping");return}this._contactsActor=t,this._contactsSubscription?.unsubscribe();const e=t.getSnapshot();this._contacts=e.context.contacts||[],this._activeContactId=e.context.activeContactId,this._updateActiveContact(),this._contactsSubscription=t.subscribe(s=>{this._contacts=s.context.contacts||[],this._activeContactId=s.context.activeContactId,this._updateActiveContact(),this.requestUpdate()}),console.log("ðŸš Contacts actor connected, calling requestUpdate"),this.requestUpdate()}render(){return this._authState==="initializing"||this._shellState==="loading"?f`<loading-screen message="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."></loading-screen>`:this._isAuthState()?f`<auth-wrapper .authActor=${this.authActor}></auth-wrapper>`:this._authState==="authenticated"?this._renderApp():f`<loading-screen></loading-screen>`}_isAuthState(){return["guest","loggingIn","registering"].includes(this._authState)}_renderApp(){return f`
			<div class="app-container">
				<sidebar-panel
					.profile=${this._profile}
					.username=${this._username}
					.currentUserId=${this._userId}
					.contactsActor=${this._contactsActor}
					.activeContactId=${this._activeContactId}
					.eventBus=${L}
					@navigate-settings=${this._handleNavigateToSettings}
					@open-chat=${this._onOpenChat}
				></sidebar-panel>

				<div class="main-content">
					<top-bar
						.currentScreen=${this._currentScreen}
						.activeContact=${this._activeContact}
						@logout=${this._handleLogout}
						@back=${this._handleBack}
					></top-bar>

					<div class="content-area">${this._renderContent()}</div>
				</div>
			</div>
		`}_renderContent(){switch(this._currentScreen){case"settings":return this._renderSettings();case"chat":return this._renderChat();default:return this._renderChatPlaceholder()}}_renderChat(){return this._activeContact?f`
			<chat-placeholder
				.contact=${this._activeContact}
				@close-chat=${this._handleCloseChat}
				@delete-contact=${this._handleDeleteContact}
				@send-message=${this._handleSendMessage}
			></chat-placeholder>
		`:this._renderChatPlaceholder()}_renderChatPlaceholder(){return f` <chat-placeholder .contact=${null}></chat-placeholder> `}_renderSettings(){return te(()=>Promise.resolve().then(()=>Yn),void 0,import.meta.url),this._settingsActor?f`
			<settings-view
				.settingsActor=${this._settingsActor}
				.actorRegistry=${this.actorRegistry}
			></settings-view>
		`:f`<loading-screen
				message="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ..."
			></loading-screen>`}_handleNavigateToSettings(){this._currentScreen="settings",this._activeContactId=null,this._activeContact=null,this.shellActor?.send({type:"NAVIGATE_TO_SETTINGS"}),this._contactsActor?.send({type:"DESELECT_CONTACT"})}_handleBack(){this._activeContactId=null,this._activeContact=null,this._currentScreen="contacts",this._contactsActor?.send({type:"DESELECT_CONTACT"})}_handleCloseChat(){this._activeContactId=null,this._activeContact=null,this._contactsActor?.send({type:"DESELECT_CONTACT"}),this.requestUpdate()}_handleDeleteContact(t){const{contactId:e,block:s}=t.detail;console.log("ðŸš Shell: Deleting contact",e?.slice(0,16),"block:",s),s?this._contactsActor?.send({type:"DELETE_AND_BLOCK_CONTACT",contactId:e}):this._contactsActor?.send({type:"DELETE_CONTACT",contactId:e}),this._handleCloseChat()}_handleSendMessage(t){const{contactId:e,text:s}=t.detail;console.log("ðŸš Shell: Send message to",e?.slice(0,16),":",s),alert(`ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÐºÐ° Ð½Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð°.

Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: "${s}"`)}_handleLogout(){this.authActor?.send({type:"LOGOUT"})}}customElements.define("app-shell",ns);const Gn=Object.freeze(Object.defineProperty({__proto__:null,AppShell:ns},Symbol.toStringTag,{value:"Module"})),qn=b`
	:host {
		display: block;
		max-width: 800px;
		margin: 0 auto;
	}

	.settings-container {
		display: flex;
		flex-direction: column;
		gap: var(--space-l);
	}

	.error-banner {
		padding: var(--space-s) var(--space-m);
		background: var(--color-danger-soft);
		border: 1px solid var(--color-danger-border);
		border-radius: var(--radius-m);
		color: var(--color-danger-text);
	}

	.loading {
		text-align: center;
		padding: var(--space-xl);
		color: var(--color-text-muted);
	}
`;class Fn extends w{static properties={actor:{type:Object},profile:{type:Object},state:{type:String}};static styles=[ut,tt,q,ts,b`
			.avatar-row {
				display: flex;
				align-items: center;
				gap: var(--space-m);
			}

			.avatar-controls {
				display: flex;
				flex-direction: column;
				gap: var(--space-xs);
			}
		`];render(){const t=this.profile?.displayName||this.profile?.username||"",e=t[0]?.toUpperCase()||"?";return f`
			<div class="section">
				<h2 class="section-title">ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ</h2>

				\x3C!-- ÐÐ²Ð°Ñ‚Ð°Ñ€ -->
				<div class="form-group avatar-row">
					<div class="avatar avatar--xl">
						${this.profile?.avatar?f`<img src=${this.profile.avatar} alt="ÐÐ²Ð°Ñ‚Ð°Ñ€" />`:e}
					</div>
					<div class="avatar-controls">
						<input
							type="file"
							class="file-input"
							id="avatar-input"
							accept="image/*"
							@change=${this._handleAvatarUpload}
						/>
						<button class="btn btn--secondary" @click=${this._triggerFileInput}>
							Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð°Ð²Ð°Ñ‚Ð°Ñ€
						</button>
						<p class="help-text">Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ð±Ñ€ÐµÐ·Ð°Ð½Ð¾ Ð´Ð¾ 200Ã—200</p>
					</div>
				</div>

				\x3C!-- Ð˜Ð¼Ñ -->
				<div class="form-group">
					<label class="label">Ð˜Ð¼Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ</label>
					<input
						type="text"
						class="input"
						.value=${t}
						@input=${this._handleDisplayNameChange}
						placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ"
					/>
					<p class="help-text">
						3-32 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°: Ð±ÑƒÐºÐ²Ñ‹, Ñ†Ð¸Ñ„Ñ€Ñ‹, Ð´ÐµÑ„Ð¸Ñ, Ð¿Ð¾Ð´Ñ‡Ñ‘Ñ€ÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ
					</p>
				</div>

				\x3C!-- Ð‘Ð¸Ð¾ -->
				<div class="form-group">
					<label class="label">ÐšÑ€Ð°Ñ‚ÐºÐ¾ Ð¾Ð±Ð¾ Ð¼Ð½Ðµ</label>
					<textarea
						class="textarea"
						.value=${this.profile?.bio||""}
						@input=${this._handleBioChange}
						placeholder="Ð Ð°ÑÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¾ ÑÐµÐ±Ðµ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)"
					></textarea>
					<p class="help-text">Ð”Ð¾ 500 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²</p>
				</div>

				\x3C!-- ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ -->
				<button
					class="btn btn--primary"
					@click=${this._handleSave}
					?disabled=${this.state==="savingProfile"}
				>
					${this.state==="savingProfile"?"Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ...":"Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ"}
				</button>
			</div>
		`}_triggerFileInput(){this.shadowRoot.getElementById("avatar-input").click()}_handleAvatarUpload(t){const e=t.target.files?.[0];e&&this.actor?.send({type:"UPLOAD_AVATAR",file:e})}_handleDisplayNameChange(t){this.actor?.send({type:"UPDATE_PROFILE",updates:{displayName:t.target.value}})}_handleBioChange(t){this.actor?.send({type:"UPDATE_PROFILE",updates:{bio:t.target.value}})}_handleSave(){this.actor?.send({type:"SAVE_PROFILE"})}}customElements.define("profile-section",Fn);class Hn extends w{static properties={actor:{type:Object},username:{type:String},state:{type:String}};static styles=[ut,tt,q,b`
			.password-divider {
				margin-top: var(--space-l);
				padding-top: var(--space-l);
				border-top: 1px solid var(--color-border);
			}

			.subsection-title {
				margin: 0 0 var(--space-m) 0;
				font-size: var(--text-lg);
				font-weight: 600;
			}
		`];constructor(){super(),this._oldPassword="",this._newPassword="",this._confirmPassword=""}render(){return f`
			<div class="section">
				<h2 class="section-title">ðŸ”’ Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ</h2>

				\x3C!-- Ð›Ð¾Ð³Ð¸Ð½ (readonly) -->
				<div class="form-group">
					<label class="label">Ð›Ð¾Ð³Ð¸Ð½ (Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ)</label>
					<input
						type="text"
						class="input"
						.value=${this.username||""}
						disabled
					/>
					<p class="help-text">
						Ð­Ñ‚Ð¾ Ð²Ð°Ñˆ Ð»Ð¾Ð³Ð¸Ð½ Ð´Ð»Ñ Ð²Ñ…Ð¾Ð´Ð° Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ. Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ.
					</p>
				</div>

				\x3C!-- Ð¡Ð¼ÐµÐ½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ -->
				<div class="password-divider">
					<h3 class="subsection-title">Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ</h3>

					<div class="form-group">
						<label class="label">Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ</label>
						<input
							type="password"
							class="input"
							.value=${this._oldPassword}
							@input=${t=>this._oldPassword=t.target.value}
							placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
							autocomplete="current-password"
						/>
					</div>

					<div class="form-group">
						<label class="label">ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ</label>
						<input
							type="password"
							class=${this._getNewPasswordClass()}
							.value=${this._newPassword}
							@input=${t=>{this._newPassword=t.target.value,this.requestUpdate()}}
							placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
							autocomplete="new-password"
						/>
						<p class="help-text">ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 4 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°</p>
					</div>

					<div class="form-group">
						<label class="label">ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ</label>
						<input
							type="password"
							class=${this._getConfirmPasswordClass()}
							.value=${this._confirmPassword}
							@input=${t=>{this._confirmPassword=t.target.value,this.requestUpdate()}}
							placeholder="ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
							autocomplete="new-password"
						/>
					</div>

					<button
						class="btn btn--primary"
						@click=${this._handleChangePassword}
						?disabled=${this.state==="changingPassword"}
					>
						${this.state==="changingPassword"?"Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ...":"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"}
					</button>
				</div>
			</div>
		`}_getNewPasswordClass(){return this._newPassword?this._newPassword.length>=4?"input input--valid":"input input--invalid":"input"}_getConfirmPasswordClass(){return this._confirmPassword?this._newPassword===this._confirmPassword&&this._newPassword.length>=4?"input input--valid":"input input--invalid":"input"}_handleChangePassword(){if(!this._oldPassword||!this._newPassword||!this._confirmPassword){alert("Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ");return}if(this._newPassword!==this._confirmPassword){alert("ÐÐ¾Ð²Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‚");return}if(this._newPassword.length<4){alert("ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 4 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°");return}if(this._oldPassword===this._newPassword){alert("ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°Ñ‚ÑŒÑÑ Ð¾Ñ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾");return}this.actor?.send({type:"CHANGE_PASSWORD",oldPassword:this._oldPassword,newPassword:this._newPassword}),this._waitForResult()}_waitForResult(){const t=this._newPassword,e=this.actor?.subscribe(s=>{s.matches("ready")&&(s.context.error?(alert("âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: "+s.context.error),e?.unsubscribe()):s.context.passwordSuccess&&(alert(`âœ… ÐŸÐ°Ñ€Ð¾Ð»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½!

Ð—Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ: ${t}`),this._clearForm(),e?.unsubscribe()))})}_clearForm(){this._oldPassword="",this._newPassword="",this._confirmPassword="",this.requestUpdate()}}customElements.define("security-section",Hn);class Vn extends w{static properties={actor:{type:Object},enabled:{type:Boolean}};static styles=[ut,tt,b`
			.section--highlighted {
				border: 2px dashed var(--color-primary);
				background: var(--color-primary-soft);
			}

			.section--highlighted .section-title {
				color: var(--color-primary);
			}

			.badge {
				display: inline-block;
				padding: var(--space-3xs) var(--space-xs);
				background: var(--color-primary);
				color: var(--color-white);
				border-radius: var(--radius-xs);
				font-size: var(--text-xs);
				font-weight: 600;
				margin-left: var(--space-xs);
				vertical-align: middle;
			}

			.status-text {
				margin-top: var(--space-m);
			}

			.status-text--active {
				color: var(--color-primary);
			}
		`];render(){const t=this.enabled?"section section--highlighted":"section";return f`
			<div class=${t}>
				<h2 class="section-title">
					ðŸŒ ÐžÐ±Ð·Ð¾Ñ€
					${this.enabled?f`<span class="badge">ÐÐºÑ‚Ð¸Ð²Ð½Ð¾</span>`:""}
				</h2>

				<div class="checkbox-group" @click=${this._handleToggle}>
					<input
						type="checkbox"
						class="checkbox-input"
						.checked=${this.enabled}
						@click=${e=>e.stopPropagation()}
						@change=${this._handleToggle}
					/>
					<div class="checkbox-content">
						<div class="checkbox-label">
							ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ Â«ÐžÐ±Ð·Ð¾Ñ€Â»
						</div>
						<div class="checkbox-description">
							Ð’Ð°Ñˆ Ð°Ð²Ð°Ñ‚Ð°Ñ€, Ð¸Ð¼Ñ Ð¸ Ð±Ð¸Ð¾ Ð±ÑƒÐ´ÑƒÑ‚ Ð²Ð¸Ð´Ð½Ñ‹ Ð²ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ñ‡Ð°Ñ‚Ð° Ð²
							Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ Â«ÐžÐ±Ð·Ð¾Ñ€Â». Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ ÑÐ¼Ð¾Ð³ÑƒÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ð¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ
							Ð½Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹.
						</div>
					</div>
				</div>

				<p
					class="help-text status-text ${this.enabled?"status-text--active":""}"
				>
					${this.enabled?"âœ¨ Ð’Ð°Ñˆ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð²Ð¸Ð´ÐµÐ½ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ Â«ÐžÐ±Ð·Ð¾Ñ€Â» Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹":"Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑÑ‚Ñƒ Ð¾Ð¿Ñ†Ð¸ÑŽ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³Ð»Ð¸ Ð½Ð°Ð¹Ñ‚Ð¸ Ð²Ð°Ñ"}
				</p>
			</div>
		`}_handleToggle(t){t.target.type==="checkbox"&&t.stopPropagation();const e=!this.enabled;this.actor?.send({type:"UPDATE_PROFILE",updates:{showInDiscovery:e}}),setTimeout(()=>{this.actor?.send({type:"SAVE_PROFILE"})},50)}}customElements.define("discovery-section",Vn);class Kn extends w{static properties={identity:{type:Object},service:{type:Object}};static styles=[ut,tt,b`
			.key-container {
				display: flex;
				gap: var(--space-s);
				align-items: center;
			}

			.key-code {
				flex: 1;
				padding: var(--space-s) var(--space-m);
				background: var(--color-surface-raised);
				border: 1px solid var(--color-border);
				border-radius: var(--radius-m);
				font-family: var(--font-mono);
				font-size: var(--text-sm);
				word-break: break-all;
				cursor: pointer;
				user-select: all;
				transition: background var(--transition-fast);
			}

			.key-code:hover {
				background: var(--color-bg-hover);
			}

			.debug-info {
				margin-top: var(--space-s);
				padding: var(--space-s);
				background: var(--color-warning-soft, #fff3cd);
				border-radius: var(--radius-s);
				font-size: var(--text-xs);
				font-family: var(--font-mono);
				color: var(--color-warning, #856404);
			}
		`];get _invitationKey(){if(!this.identity||!this.service)return console.warn("[invitation-section] Missing identity or service:",{hasIdentity:!!this.identity,hasService:!!this.service}),"Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...";console.log("[invitation-section] Generating key with identity:",{userId:this.identity.userId?.slice(0,16)+"...",hasExchange:!!this.identity.exchange,fullIdentity:this.identity});try{const t=this.service.generateInvitationKey(this.identity);try{const e=JSON.parse(atob(t));console.log("[invitation-section] Generated key contains uid:",e.uid?.slice(0,16)+"...")}catch{}return t}catch(t){return console.error("[invitation-section] Failed to generate invitation key:",t),"ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ»ÑŽÑ‡Ð°"}}render(){return console.log("[invitation-section] render, identity userId:",this.identity?.userId?.slice(0,16)+"..."),f`
			<div class="section">
				<h2 class="section-title">ðŸ”‘ ÐšÐ»ÑŽÑ‡ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ</h2>

				<div class="form-group">
					<label class="label"
						>ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ»ÑŽÑ‡ Ð² Ð±ÑƒÑ„ÐµÑ€ Ð¾Ð±Ð¼ÐµÐ½Ð°</label
					>
					<div class="key-container">
						<code class="key-code" @click=${this._handleCopy}>
							${this._invitationKey}
						</code>
					</div>
					<p class="help-text">
						ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÐºÐ»ÑŽÑ‡ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ Ð¼Ð¾Ð³Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ
						Ð²Ð°Ñ Ð² ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹
					</p>

					\x3C!-- âœ… Ð’Ð Ð•ÐœÐ•ÐÐÐÐ¯ Ð”Ð˜ÐÐ“ÐÐžÐ¡Ð¢Ð˜ÐšÐ -->
					<div class="debug-info">
						ðŸ“ Your userId: ${this.identity?.userId?.slice(0,20)||"N/A"}...
					</div>
				</div>
			</div>
		`}_handleCopy(){const t=this._invitationKey;t&&t!=="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°..."&&t!=="ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ»ÑŽÑ‡Ð°"&&navigator.clipboard.writeText(t).then(()=>{alert("Ð’Ð°Ñˆ ÐºÐ»ÑŽÑ‡ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¸ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ð±ÑƒÑ„ÐµÑ€Ðµ Ð¾Ð±Ð¼ÐµÐ½Ð°. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼")})}}customElements.define("invitation-section",Kn);class Wn extends w{static properties={actor:{type:Object},servers:{type:Array},activeServerId:{type:String},signalingActor:{type:Object},_signalingState:{state:!0},_signalingError:{state:!0},_signalingRetryCount:{state:!0}};static styles=[ut,tt,q,b`
			.current-server {
				display: flex;
				gap: var(--space-s);
				align-items: center;
			}

			.server-url {
				flex: 1;
				padding: var(--space-s);
				background: var(--color-bg);
				border-radius: var(--radius-m);
				font-family: var(--font-mono);
				font-size: var(--text-sm);
			}

			.current-server {
				display: flex;
				align-items: center;
				gap: var(--space-s);
			}

			/* Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²ÐµÑ€Ð° */

			.server-url {
				padding: 2px 6px;
				background: var(--color-bg);
				border-radius: var(--radius-s);
				font-family: var(--font-mono);
				font-size: var(--text-sm);
			}

			.server-status {
				padding: var(--space-m);
				border: 2px solid;
				border-radius: var(--radius-m);
				margin-top: var(--space-m);
			}

			.server-main-line {
				margin-bottom: var(--space-m);
			}

			.server-status-text {
				display: flex;
				align-items: center;
				gap: 6px;
				font-weight: 500;
				margin-bottom: var(--space-s);
			}

			.server-controls {
				display: grid;
				grid-template-columns: 1fr auto;
				gap: var(--space-s);
				align-items: center;
			}

			.server-help {
				font-size: var(--text-xs);
				color: var(--color-text-muted);
			}

			.server-status.status-connected {
				border-color: var(--color-success);
				background: var(--color-success-soft);
			}

			.server-status.status-connecting {
				border-color: var(--color-warning);
				background: var(--color-warning-soft);
			}

			.server-status.status-error {
				border-color: var(--color-danger);
				background: var(--color-danger-soft);
			}

			.server-status.status-idle {
				border-color: var(--color-border);
			}

			.status-header {
				display: flex;
				align-items: center;
				gap: var(--space-s);
				margin-bottom: var(--space-s);
			}

			.status-indicator {
				width: var(--indicator-size-md);
				height: var(--indicator-size-md);
				border-radius: 50%;
				animation: pulse 2s ease-in-out infinite;
			}

			.status-indicator.connected {
				background: var(--color-success);
			}

			.status-indicator.connecting {
				background: var(--color-warning);
			}

			.status-indicator.error {
				background: var(--color-danger);
			}

			.status-indicator.idle {
				background: var(--color-text-muted);
				animation: none;
			}

			.status-indicator.reconnecting {
				background: var(--color-warning);
				animation: pulse 1s ease-in-out infinite;
			}

			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}

			.status-title {
				font-weight: 600;
				font-size: var(--text-body);
			}

			.status-details {
				font-size: var(--text-sm);
				color: var(--color-text-muted);
				margin-top: var(--space-xs);
			}

			.status-error {
				margin-top: var(--space-s);
				padding: var(--space-s);
				background: var(--color-danger-soft);
				border-radius: var(--radius-s);
				font-size: var(--text-sm);
				color: var(--color-danger-text);
			}

			.retry-info {
				margin-top: var(--space-xs);
				font-size: var(--text-xs);
				color: var(--color-text-muted);
			}
		`];constructor(){super(),this._signalingState="idle",this._signalingError=null,this._signalingRetryCount=0,this._signalingSubscription=null}connectedCallback(){super.connectedCallback(),this.signalingActor&&this._subscribeToSignaling()}disconnectedCallback(){super.disconnectedCallback(),this._signalingSubscription?.unsubscribe()}updated(t){t.has("signalingActor")&&this.signalingActor&&this._subscribeToSignaling()}updated(t){t.has("signalingActor")&&this._subscribeToSignaling()}_subscribeToSignaling(){if(this._signalingSubscription?.unsubscribe(),!this.signalingActor){this._signalingState="idle";return}const t=s=>{let r="idle";s.matches("idle")?r="idle":s.matches("connecting")?r="connecting":s.matches("connected")?r="connected":s.matches("reconnecting")?r="reconnecting":s.matches("error")&&(r="error"),this._signalingState=r,this._signalingError=s.context.error,this._signalingRetryCount=s.context.retryCount},e=this.signalingActor.getSnapshot();t(e),console.log("[servers-section] Subscribed to signaling, state:",this._signalingState,"snapshot:",e.value),this._signalingSubscription=this.signalingActor.subscribe(t)}get _activeServer(){return this.servers?.find(t=>t.id===this.activeServerId)}_getStatusConfig(){const t={idle:{icon:"âšª",title:"ÐÐµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½",description:"ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ",cssClass:"status-idle",indicatorClass:"idle"},connecting:{icon:"ðŸŸ¡",title:"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...",description:"Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ñ ÑÐ¸Ð³Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð¼",cssClass:"status-connecting",indicatorClass:"connecting"},connected:{icon:"ðŸŸ¢",title:"ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½",description:"Ð¡ÐµÑ€Ð²ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ñ",cssClass:"status-connected",indicatorClass:"connected"},reconnecting:{icon:"ðŸŸ ",title:"ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ...",description:`ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ${this._signalingRetryCount}/5)`,cssClass:"status-connecting",indicatorClass:"reconnecting"},error:{icon:"ðŸ”´",title:"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ",description:"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ",cssClass:"status-error",indicatorClass:"error"}};return t[this._signalingState]||t.idle}render(){const t=this._activeServer,e=this._getStatusConfig();return f`
			<div class="section">
				<h2 class="section-title">ðŸ“¡ Ð¡Ð¸Ð³Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹</h2>

				<div class="server-status ${e.cssClass}">
					\x3C!-- Ð’ÐµÑ€Ñ…Ð½ÑÑ ÑÑ‚Ñ€Ð¾ÐºÐ° -->
					<div class="server-main-line">
						<strong>Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÐµÑ€Ð²ÐµÑ€:</strong>

						${t?f`<code class="server-url">${t.url}</code>`:f`<span>â€”</span>`}
						${t&&!t.isDefault?f`
									<button
										class="btn btn--danger btn--xs"
										@click=${()=>this._handleRemove(t.id)}
									>
										Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
									</button>
							  `:""}
					</div>

					\x3C!-- Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ -->
					<div class="server-controls">
						<select
							class="select"
							.value=${this.activeServerId||""}
							@change=${this._handleSelect}
						>
							${this.servers?.map(s=>f`
									<option value=${s.id}>
										${s.label} ${s.isDefault?"(Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ)":""}
									</option>
								`)}
						</select>

						<button class="btn btn--secondary" @click=${this._handleAdd}>
							âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ
						</button>
					</div>

					\x3C!-- Ð”ÐµÑ‚Ð°Ð»Ð¸ / Ð¾ÑˆÐ¸Ð±ÐºÐ¸ -->
					<div class="status-details">
						<span class="server-status-text">
							<div
								class="status-indicator ${e.indicatorClass}"
							></div>
							${e.title} ${e.icon}
						</span>
						${e.description}
					</div>

					${this._signalingError?f`
								<div class="status-error">
									<strong>ÐžÑˆÐ¸Ð±ÐºÐ°:</strong>
									${this._signalingError}
								</div>
						  `:""}
					${this._signalingState==="reconnecting"?f`
								<div class="retry-info">
									Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ·
									${Math.pow(2,this._signalingRetryCount)} ÑÐµÐºÑƒÐ½Ð´
								</div>
						  `:""}

					\x3C!-- ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ -->
					<div class="server-help">
						Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ ÑÐ¸Ð³Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÑ€Ð²ÐµÑ€Ñ‹ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
						ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹
					</div>
				</div>
			</div>
		`}_handleSelect(t){this.actor?.send({type:"SET_ACTIVE_SERVER",serverId:t.target.value})}_handleAdd(){const t=prompt("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ URL ÑÐ¸Ð³Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð° (wss://...):");t&&this.actor?.send({type:"ADD_SERVER",url:t})}_handleRemove(t){confirm("Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€?")&&this.actor?.send({type:"REMOVE_SERVER",serverId:t})}}customElements.define("servers-section",Wn);class os extends w{static properties={settingsActor:{type:Object},actorRegistry:{type:Object},_state:{state:!0},_profile:{state:!0},_servers:{state:!0},_activeServerId:{state:!0},_identity:{state:!0},_error:{state:!0},_signalingActor:{state:!0}};static styles=qn;constructor(){super(),this._state="loading",this._profile=null,this._servers=[],this._activeServerId=null,this._identity=null,this._error=null,this._subscription=null,this._signalingActor=null}connectedCallback(){super.connectedCallback(),this._subscribe(),this._subscribeToSignaling(),this._subscribeToSignalingReady()}disconnectedCallback(){super.disconnectedCallback(),this._subscription?.unsubscribe(),this._unsubRegistry?.(),window.appContext?.eventBus&&window.appContext.eventBus.off("SIGNALING_READY",this._onSignalingReady)}updated(t){console.log("[settings] updated called with properties:",Array.from(t.keys())),t.has("settingsActor")&&this.settingsActor&&this._subscribe(),t.has("actorRegistry")&&this.actorRegistry&&(console.log("[settings] actorRegistry changed, subscribing to signaling"),this._subscribeToSignaling())}_subscribe(){if(!this.settingsActor)return;this._subscription?.unsubscribe();const t=e=>{this._state=e.value,this._profile=e.context.profile,this._servers=e.context.signalingServers,this._activeServerId=e.context.activeServerId,this._identity=e.context.identity,this._error=e.context.error};t(this.settingsActor.getSnapshot()),this._subscription=this.settingsActor.subscribe(t)}_subscribeToSignaling(){if(console.log("[settings] _subscribeToSignaling called, actorRegistry:",this.actorRegistry),!this.actorRegistry){console.warn("[settings] No actorRegistry provided, cannot subscribe");return}this._unsubRegistry?.(),console.log("[settings] Subscribing to actorRegistry"),this._unsubRegistry=this.actorRegistry.subscribe(t=>{console.log("[settings] ActorRegistry event:",t.type,"actors:",t.actors?.size);const e=t.actors;if(!e)return;const r=e.get("signaling")?.actor||null;console.log("[settings] Signaling from registry:",r?"found":"not found"),r&&r!==this._signalingActor&&(console.log("[settings] Binding signaling actor from registry:",r),this._signalingActor=r,this.requestUpdate()),!r&&this._signalingActor&&(console.log("[settings] Signaling actor removed"),this._signalingActor=null,this.requestUpdate())})}_subscribeToSignalingReady(){const t=window.appContext?.eventBus;if(!t){console.warn("[settings] No eventBus found in window.appContext");return}console.log("[settings] Subscribing to SIGNALING_READY event"),this._onSignalingReady=e=>{console.log("[settings] SIGNALING_READY event received:",e),e.actor&&e.actor!==this._signalingActor&&(console.log("[settings] Binding signaling actor from SIGNALING_READY event:",e.actor),this._signalingActor=e.actor,this.requestUpdate())},t.on("SIGNALING_READY",this._onSignalingReady)}get _service(){return this.settingsActor?.getSnapshot().context.service}render(){return this._state==="loading"?f`<div class="loading">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº...</div>`:f`
			<div class="settings-container">
				${this._error?f`<div class="error-banner">âš ï¸ ${this._error}</div>`:""}

				<profile-section
					.actor=${this.settingsActor}
					.profile=${this._profile}
					.state=${this._state}
				></profile-section>

				<security-section
					.actor=${this.settingsActor}
					.username=${this._profile?.username}
					.state=${this._state}
				></security-section>

				<discovery-section
					.actor=${this.settingsActor}
					.enabled=${this._profile?.showInDiscovery||!1}
				></discovery-section>

				<invitation-section
					.identity=${this._identity}
					.service=${this._service}
				></invitation-section>

				<servers-section
					.actor=${this.settingsActor}
					.servers=${this._servers}
					.activeServerId=${this._activeServerId}
					.signalingActor=${this._signalingActor}
				></servers-section>
			</div>
		`}}customElements.define("settings-view",os);const Yn=Object.freeze(Object.defineProperty({__proto__:null,SettingsView:os},Symbol.toStringTag,{value:"Module"}));</script>
		<style rel="stylesheet" crossorigin>*,*:before,*:after{margin:0;padding:0;box-sizing:border-box}html{color-scheme:light dark;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-size-adjust:100%;scroll-behavior:smooth}body{font-family:var(--font-ui);font-size:var(--text-body);line-height:var(--line-normal);color:var(--color-text-main);background:var(--color-bg);transition:background .3s,color .3s}#app{width:100dvw;height:100dvh;overflow-x:hidden;overflow-y:auto;position:absolute;inset:0}:root{--font-ui: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;--font-mono: ui-monospace, "Cascadia Mono", "Segoe UI Mono", "Courier New", monospace;--hue-primary: 270;--hue-danger: 27;--hue-success: 145;--l-bg: 98%;--l-surface: 100%;--l-raised: 96%;--l-hover: 94%;--l-border: 88%;--l-muted: 45%;--l-text: 25%;--color-bg: oklch(var(--l-bg) 0 0);--color-surface: oklch(var(--l-surface) 0 0);--color-surface-raised: oklch(var(--l-raised) 0 0);--color-bg-hover: oklch(var(--l-hover) 0 0);--color-text-main: oklch(var(--l-text) 0 0);--color-text-muted: oklch(var(--l-muted) 0 0);--color-border: oklch(var(--l-border) 0 0);--border-color: var(--color-border);--color-primary: oklch(55% .25 var(--hue-primary));--color-primary-dark: oklch(48% .25 var(--hue-primary));--color-primary-soft: oklch(95% .05 var(--hue-primary));--color-primary-muted: oklch(75% .08 var(--hue-primary));--color-danger: oklch(55% .18 var(--hue-danger));--color-danger-soft: oklch(95% .05 var(--hue-danger));--color-danger-border: oklch(85% .08 var(--hue-danger));--color-danger-text: oklch(45% .15 var(--hue-danger));--color-success: oklch(55% .15 var(--hue-success));--color-success-soft: oklch(95% .05 var(--hue-success));--space-3xs: clamp(.25rem, .2rem + .2vw, .375rem);--space-2xs: clamp(.375rem, .3rem + .3vw, .5rem);--space-xs: clamp(.5rem, .45rem + .25vw, .625rem);--space-s: clamp(.625rem, .55rem + .35vw, .875rem);--space-m: clamp(.875rem, .8rem + .4vw, 1.125rem);--space-l: clamp(1.25rem, 1.1rem + .7vw, 1.75rem);--space-xl: clamp(1.75rem, 1.5rem + 1.2vw, 2.5rem);--space-2xl: clamp(2.5rem, 2rem + 2vw, 4rem);--text-xs: clamp(.75rem, .7rem + .15vw, .8125rem);--text-sm: clamp(.8125rem, .78rem + .15vw, .875rem);--text-body: clamp(.9375rem, .875rem + .25vw, 1.0625rem);--text-lg: clamp(1.0625rem, .95rem + .5vw, 1.25rem);--text-xl: clamp(1.25rem, 1.1rem + .7vw, 1.5rem);--text-2xl: clamp(1.5rem, 1.25rem + 1vw, 2rem);--text-3xl: clamp(1.875rem, 1.5rem + 1.5vw, 2.5rem);--line-tight: 1.2;--line-normal: 1.5;--line-loose: 1.7;--radius-xs: 4px;--radius-s: 6px;--radius-m: 8px;--radius-l: 12px;--radius-xl: 16px;--radius-full: 9999px;--shadow-xs: 0 1px 2px rgba(0, 0, 0, .05);--shadow-sm: 0 1px 3px rgba(0, 0, 0, .1), 0 1px 2px rgba(0, 0, 0, .06);--shadow-md: 0 4px 6px rgba(0, 0, 0, .07), 0 2px 4px rgba(0, 0, 0, .05);--shadow-lg: 0 4px 24px rgba(0, 0, 0, .1);--shadow-card: 0 2px 8px rgba(0, 0, 0, .05);--transition-fast: .15s ease;--transition-normal: .2s ease;--transition-slow: .3s ease;--z-dropdown: 100;--z-sticky: 200;--z-modal: 300;--z-toast: 400}@media(prefers-color-scheme:dark){:root{--l-bg: 10%;--l-surface: 15%;--l-raised: 18%;--l-hover: 22%;--l-border: 25%;--l-muted: 60%;--l-text: 92%;--color-primary: oklch(65% .25 var(--hue-primary));--color-primary-dark: oklch(58% .25 var(--hue-primary));--color-primary-soft: oklch(25% .08 var(--hue-primary));--shadow-card: 0 2px 8px rgba(0, 0, 0, .3);--shadow-lg: 0 4px 24px rgba(0, 0, 0, .4)}}:focus-visible{outline:2px solid var(--color-primary);outline-offset:2px}</style>
	</head>
	<body>
		<div id="app">
			<div style="padding: 2rem; text-align: center">
				<p>Initializing...</p>
			</div>
		</div>

	</body>
</html>
